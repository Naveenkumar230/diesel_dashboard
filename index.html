<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>DG Analytics Dashboard - Advanced Monitoring</title>
<style>
  :root {
    --primary: #2563eb;
    --primary-dark: #1e40af;
    --success: #10b981;
    --warning: #f59e0b;
    --danger: #ef4444;
    --bg-primary: #0f172a;
    --bg-secondary: #1e293b;
    --bg-tertiary: #334155;
    --text-primary: #f1f5f9;
    --text-secondary: #cbd5e1;
    --text-muted: #94a3b8;
    --border: #334155;
    --chart-blue: #3b82f6;
    --chart-green: #10b981;
    --chart-yellow: #f59e0b;
    --chart-purple: #8b5cf6;
  }
  
  * { box-sizing: border-box; margin: 0; padding: 0; }
  
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
    color: var(--text-primary);
    min-height: 100vh;
    padding: 20px;
  }
  
  .container {
    max-width: 1600px;
    margin: 0 auto;
  }
  
  /* Header Styles */
  .header {
    text-align: center;
    margin-bottom: 2rem;
    padding: 1.5rem;
    background: var(--bg-secondary);
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
  }
  
  h1 {
    font-size: 2.5rem;
    font-weight: 700;
    background: linear-gradient(90deg, #60a5fa, #34d399);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: 0.5rem;
  }
  
  .subtitle {
    font-size: 1rem;
    color: var(--text-muted);
  }
  
  .status-badge {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 8px 16px;
    background: var(--bg-tertiary);
    border-radius: 20px;
    font-size: 0.9rem;
    margin-top: 10px;
  }
  
  .status-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: var(--success);
    animation: pulse 2s infinite;
  }
  
  @keyframes pulse {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.7; transform: scale(1.1); }
  }
  
  /* Navigation Tabs */
  .nav-tabs {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    background: var(--bg-secondary);
    padding: 10px;
    border-radius: 12px;
    overflow-x: auto;
  }
  
  .nav-tab {
    padding: 12px 24px;
    background: var(--bg-tertiary);
    border: none;
    border-radius: 8px;
    color: var(--text-secondary);
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s ease;
    white-space: nowrap;
  }
  
  .nav-tab:hover {
    background: var(--primary-dark);
    color: white;
  }
  
  .nav-tab.active {
    background: var(--primary);
    color: white;
    box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
  }
  
  /* Filter Section */
  .filter-section {
    background: var(--bg-secondary);
    padding: 20px;
    border-radius: 12px;
    margin-bottom: 20px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
  }
  
  .filter-title {
    font-size: 1.2rem;
    font-weight: 700;
    margin-bottom: 15px;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: 10px;
  }
  
  .filter-controls {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    align-items: end;
  }
  
  .filter-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  
  .filter-group label {
    font-size: 0.9rem;
    color: var(--text-secondary);
    font-weight: 600;
  }
  
  .filter-group input,
  .filter-group select {
    padding: 10px;
    background: var(--bg-tertiary);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text-primary);
    font-size: 0.95rem;
    transition: all 0.3s ease;
  }
  
  .filter-group input:focus,
  .filter-group select:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
  }
  
  .btn {
    padding: 12px 24px;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    font-size: 0.95rem;
    cursor: pointer;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    justify-content: center;
  }
  
  .btn-primary {
    background: var(--primary);
    color: white;
  }
  
  .btn-primary:hover {
    background: var(--primary-dark);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
  }
  
  .btn-success {
    background: var(--success);
    color: white;
  }
  
  .btn-success:hover {
    background: #059669;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
  }
  
  .btn-group {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
  }
  
  /* Tab Content */
  .tab-content {
    display: none;
  }
  
  .tab-content.active {
    display: block;
    animation: fadeIn 0.3s ease;
  }
  
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  
  /* Stats Cards */
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-bottom: 20px;
  }
  
  .stat-card {
    background: var(--bg-secondary);
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    position: relative;
    overflow: hidden;
    transition: transform 0.3s ease;
  }
  
  .stat-card:hover {
    transform: translateY(-5px);
  }
  
  .stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
  }
  
  .stat-card.diesel::before {
    background: linear-gradient(90deg, var(--chart-green), var(--success));
  }
  
  .stat-card.electrical::before {
    background: linear-gradient(90deg, var(--chart-blue), var(--primary));
  }
  
  .stat-label {
    font-size: 0.85rem;
    color: var(--text-muted);
    text-transform: uppercase;
    font-weight: 600;
    letter-spacing: 0.5px;
  }
  
  .stat-value {
    font-size: 2rem;
    font-weight: 800;
    color: var(--text-primary);
    margin: 10px 0;
  }
  
  .stat-unit {
    font-size: 0.9rem;
    color: var(--text-secondary);
  }
  
  .stat-change {
    font-size: 0.85rem;
    padding: 4px 8px;
    border-radius: 4px;
    display: inline-block;
    margin-top: 5px;
  }
  
  .stat-change.positive {
    background: rgba(16, 185, 129, 0.2);
    color: var(--success);
  }
  
  .stat-change.negative {
    background: rgba(239, 68, 68, 0.2);
    color: var(--danger);
  }
  
  /* Chart Container */
  .chart-container {
    background: var(--bg-secondary);
    padding: 20px;
    border-radius: 12px;
    margin-bottom: 20px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
  }
  
  .chart-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    flex-wrap: wrap;
    gap: 10px;
  }
  
  .chart-title {
    font-size: 1.3rem;
    font-weight: 700;
    color: var(--text-primary);
  }
  
  .chart-legend {
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
  }
  
  .legend-item {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.9rem;
  }
  
  .legend-color {
    width: 12px;
    height: 12px;
    border-radius: 3px;
  }
  
  /* Canvas for Charts */
  .chart-canvas {
    width: 100%;
    height: 400px;
    background: var(--bg-tertiary);
    border-radius: 8px;
    position: relative;
    overflow: hidden;
  }
  
  /* Data Table */
  .data-table-section {
    background: var(--bg-secondary);
    padding: 20px;
    border-radius: 12px;
    margin-bottom: 20px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
  }
  
  .table-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    flex-wrap: wrap;
    gap: 10px;
  }
  
  .table-title {
    font-size: 1.3rem;
    font-weight: 700;
  }
  
  .table-info {
    font-size: 0.9rem;
    color: var(--text-muted);
  }
  
  .table-container {
    overflow-x: auto;
    border-radius: 8px;
  }
  
  .data-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.9rem;
  }
  
  .data-table thead {
    background: var(--bg-tertiary);
    position: sticky;
    top: 0;
    z-index: 10;
  }
  
  .data-table th {
    padding: 12px;
    text-align: left;
    font-weight: 700;
    color: var(--text-primary);
    border-bottom: 2px solid var(--border);
    white-space: nowrap;
  }
  
  .data-table td {
    padding: 12px;
    border-bottom: 1px solid var(--border);
    color: var(--text-secondary);
  }
  
  .data-table tbody tr {
    transition: background 0.2s ease;
  }
  
  .data-table tbody tr:hover {
    background: var(--bg-tertiary);
  }
  
  /* Status Messages */
  .status-message {
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 10px;
    font-weight: 600;
  }
  
  .status-message.info {
    background: rgba(37, 99, 235, 0.2);
    color: var(--primary);
    border-left: 4px solid var(--primary);
  }
  
  .status-message.success {
    background: rgba(16, 185, 129, 0.2);
    color: var(--success);
    border-left: 4px solid var(--success);
  }
  
  .status-message.warning {
    background: rgba(245, 158, 11, 0.2);
    color: var(--warning);
    border-left: 4px solid var(--warning);
  }
  
  .status-message.error {
    background: rgba(239, 68, 68, 0.2);
    color: var(--danger);
    border-left: 4px solid var(--danger);
  }
  
  /* Loading Spinner */
  .loading-spinner {
    display: none;
    justify-content: center;
    align-items: center;
    padding: 40px;
  }
  
  .loading-spinner.active {
    display: flex;
  }
  
  .spinner {
    width: 50px;
    height: 50px;
    border: 4px solid var(--bg-tertiary);
    border-top-color: var(--primary);
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }
  
  @keyframes spin {
    to { transform: rotate(360deg); }
  }
  
  /* Chart Visualization */
  .chart-bars {
    display: flex;
    align-items: flex-end;
    justify-content: space-around;
    height: 300px;
    padding: 20px;
    gap: 10px;
  }
  
  .bar-group {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
  }
  
  .bar {
    width: 100%;
    max-width: 80px;
    background: linear-gradient(180deg, var(--chart-blue), var(--primary-dark));
    border-radius: 8px 8px 0 0;
    position: relative;
    transition: all 0.3s ease;
    box-shadow: 0 -2px 10px rgba(37, 99, 235, 0.3);
  }
  
  .bar:hover {
    transform: scaleY(1.05);
    box-shadow: 0 -4px 20px rgba(37, 99, 235, 0.5);
  }
  
  .bar-label {
    font-size: 0.85rem;
    color: var(--text-muted);
    text-align: center;
    font-weight: 600;
  }
  
  .bar-value {
    position: absolute;
    top: -25px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 0.8rem;
    font-weight: 700;
    color: var(--text-primary);
    white-space: nowrap;
  }
  
  /* Grid Layout for Charts */
  .charts-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
    gap: 20px;
    margin-bottom: 20px;
  }
  
  /* Responsive Design */
  @media (max-width: 768px) {
    h1 { font-size: 1.8rem; }
    .nav-tabs { flex-wrap: nowrap; }
    .filter-controls { grid-template-columns: 1fr; }
    .stats-grid { grid-template-columns: 1fr; }
    .charts-grid { grid-template-columns: 1fr; }
    .chart-canvas { height: 300px; }
    .btn-group { flex-direction: column; }
    .btn { width: 100%; }
  }
  
  @media (max-width: 480px) {
    body { padding: 10px; }
    .header { padding: 1rem; }
    h1 { font-size: 1.5rem; }
    .stat-value { font-size: 1.5rem; }
  }
  
  /* Print Styles */
  @media print {
    body { background: white; color: black; }
    .nav-tabs, .filter-section, .btn { display: none; }
    .chart-container, .data-table-section { 
      box-shadow: none; 
      border: 1px solid #ddd; 
    }
  }
</style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <h1>üìä DG Analytics & Reporting Dashboard</h1>
      <div class="subtitle">Advanced Monitoring, Analytics, and Data Export System</div>
      <div class="status-badge">
        <div class="status-dot" id="connection-status"></div>
        <span>Live Monitoring Active</span>
      </div>
    </div>
    
    <!-- Navigation Tabs -->
    <div class="nav-tabs">
      <button class="nav-tab active" onclick="switchTab('diesel-overview')">üõ¢Ô∏è Diesel Overview</button>
      <button class="nav-tab" onclick="switchTab('electrical-overview')">‚ö° Electrical Overview</button>
      <button class="nav-tab" onclick="switchTab('dg1-detail')">DG-1 Detailed</button>
      <button class="nav-tab" onclick="switchTab('dg2-detail')">DG-2 Detailed</button>
      <button class="nav-tab" onclick="switchTab('dg3-detail')">DG-3 Detailed</button>
      <button class="nav-tab" onclick="switchTab('dg4-detail')">DG-4 Detailed</button>
      <button class="nav-tab" onclick="switchTab('historical-data')">üìà Historical Data</button>
    </div>
    
    <!-- Filter Section -->
    <div class="filter-section">
      <div class="filter-title">üîç Data Filters & Controls</div>
      <div class="filter-controls">
        <div class="filter-group">
          <label for="start-date">Start Date</label>
          <input type="date" id="start-date" />
        </div>
        <div class="filter-group">
          <label for="end-date">End Date</label>
          <input type="date" id="end-date" />
        </div>
        <div class="filter-group">
          <label for="time-range">Quick Range</label>
          <select id="time-range" onchange="applyQuickRange()">
            <option value="">Custom Range</option>
            <option value="today">Today</option>
            <option value="yesterday">Yesterday</option>
            <option value="7days">Last 7 Days</option>
            <option value="30days">Last 30 Days</option>
            <option value="thismonth">This Month</option>
          </select>
        </div>
        <div class="filter-group">
          <label for="dg-select">Select DG</label>
          <select id="dg-select">
            <option value="all">All DGs</option>
            <option value="dg1">DG-1</option>
            <option value="dg2">DG-2</option>
            <option value="dg3">DG-3</option>
            <option value="dg4">DG-4</option>
          </select>
        </div>
        <div class="filter-group">
          <label>&nbsp;</label>
          <div class="btn-group">
            <button class="btn btn-primary" onclick="loadAnalyticsData()">üìä Load Analytics</button>
            <button class="btn btn-success" onclick="downloadExcelReport()">üì• Download Excel</button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Status Message -->
    <div id="status-message"></div>
    
    <!-- Loading Spinner -->
    <div class="loading-spinner" id="loading-spinner">
      <div class="spinner"></div>
    </div>
    
    <!-- Tab: Diesel Overview -->
    <div id="diesel-overview" class="tab-content active">
      <div class="stats-grid" id="diesel-stats-grid">
        <!-- Stats will be populated here -->
      </div>
      
      <div class="chart-container">
        <div class="chart-header">
          <div class="chart-title">Diesel Level Trends (All DGs)</div>
          <div class="chart-legend">
            <div class="legend-item">
              <div class="legend-color" style="background: #3b82f6;"></div>
              <span>DG-1</span>
            </div>
            <div class="legend-item">
              <div class="legend-color" style="background: #10b981;"></div>
              <span>DG-2</span>
            </div>
            <div class="legend-item">
              <div class="legend-color" style="background: #f59e0b;"></div>
              <span>DG-3</span>
            </div>
          </div>
        </div>
        <div class="chart-canvas" id="diesel-chart">
          <div class="chart-bars" id="diesel-bars"></div>
        </div>
      </div>
    </div>
    
    <!-- Tab: Electrical Overview -->
    <div id="electrical-overview" class="tab-content">
      <div class="stats-grid" id="electrical-stats-grid">
        <!-- Stats will be populated here -->
      </div>
      
      <div class="charts-grid">
        <div class="chart-container">
          <div class="chart-header">
            <div class="chart-title">Active Power (kW)</div>
          </div>
          <div class="chart-canvas">
            <div class="chart-bars" id="power-bars"></div>
          </div>
        </div>
        
        <div class="chart-container">
          <div class="chart-header">
            <div class="chart-title">Voltage Levels (V)</div>
          </div>
          <div class="chart-canvas">
            <div class="chart-bars" id="voltage-bars"></div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Tab: DG-1 Detailed -->
    <div id="dg1-detail" class="tab-content">
      <div class="stats-grid" id="dg1-stats"></div>
      <div class="data-table-section">
        <div class="table-header">
          <div class="table-title">DG-1 Parameter History</div>
          <div class="table-info" id="dg1-table-info">No data loaded</div>
        </div>
        <div class="table-container">
          <table class="data-table" id="dg1-table">
            <thead></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
    
    <!-- Tab: DG-2 Detailed -->
    <div id="dg2-detail" class="tab-content">
      <div class="stats-grid" id="dg2-stats"></div>
      <div class="data-table-section">
        <div class="table-header">
          <div class="table-title">DG-2 Parameter History</div>
          <div class="table-info" id="dg2-table-info">No data loaded</div>
        </div>
        <div class="table-container">
          <table class="data-table" id="dg2-table">
            <thead></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
    
    <!-- Tab: DG-3 Detailed -->
    <div id="dg3-detail" class="tab-content">
      <div class="stats-grid" id="dg3-stats"></div>
      <div class="data-table-section">
        <div class="table-header">
          <div class="table-title">DG-3 Parameter History</div>
          <div class="table-info" id="dg3-table-info">No data loaded</div>
        </div>
        <div class="table-container">
          <table class="data-table" id="dg3-table">
            <thead></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
    
    <!-- Tab: DG-4 Detailed -->
    <div id="dg4-detail" class="tab-content">
      <div class="stats-grid" id="dg4-stats"></div>
      <div class="data-table-section">
        <div class="table-header">
          <div class="table-title">DG-4 Parameter History</div>
          <div class="table-info" id="dg4-table-info">No data loaded</div>
        </div>
        <div class="table-container">
          <table class="data-table" id="dg4-table">
            <thead></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
    
    <!-- Tab: Historical Data -->
    <div id="historical-data" class="tab-content">
      <div class="data-table-section">
        <div class="table-header">
          <div class="table-title">Complete Historical Data</div>
          <div class="table-info" id="historical-table-info">Use filters above and click "Load Analytics"</div>
        </div>
        <div class="table-container">
          <table class="data-table" id="historical-table">
            <thead></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Global state
    let currentData = null;
    let liveData = null;
    
    // Initialize date inputs with current date
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('end-date').value = today;
    document.getElementById('end-date').max = today;
    
    const sevenDaysAgo = new Date();
    sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
    document.getElementById('start-date').value = sevenDaysAgo.toISOString().split('T')[0];
    document.getElementById('start-date').max = today;
    
    // Tab switching
    function switchTab(tabId) {
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      document.querySelectorAll('.nav-tab').forEach(btn => {
        btn.classList.remove('active');
      });
      
      document.getElementById(tabId).classList.add('active');
      event.target.classList.add('active');
      
      // Load data if needed
      if (tabId.includes('detail') || tabId === 'historical-data') {
        if (!currentData) {
          showMessage('info', 'Please load data using the filters above');
        }
      }
    }
    
    // Quick range selector
    function applyQuickRange() {
      const range = document.getElementById('time-range').value;
      const endDate = new Date();
      let startDate = new Date();
      
      switch(range) {
        case 'today':
          startDate = new Date();
          break;
        case 'yesterday':
          startDate.setDate(startDate.getDate() - 1);
          endDate.setDate(endDate.getDate() - 1);
          break;
        case '7days':
          startDate.setDate(startDate.getDate() - 7);
          break;
        case '30days':
          startDate.setDate(startDate.getDate() - 30);
          break;
        case 'thismonth':
          startDate = new Date(startDate.getFullYear(), startDate.getMonth(), 1);
          break;
        default:
          return;
      }
      
      document.getElementById('start-date').value = startDate.toISOString().split('T')[0];
      document.getElementById('end-date').value = endDate.toISOString().split('T')[0];
    }
    
    // Show status message
    function showMessage(type, text) {
      const container = document.getElementById('status-message');
      container.innerHTML = `
        <div class="status-message ${type}">
          <span>${getIcon(type)}</span>
          <span>${text}</span>
        </div>
      `;
      setTimeout(() => { container.innerHTML = ''; }, 5000);
    }
    
    function getIcon(type) {
      const icons = {
        info: '‚ÑπÔ∏è',
        success: '‚úÖ',
        warning: '‚ö†Ô∏è',
        error: '‚ùå'
      };
      return icons[type] || '‚ÑπÔ∏è';
    }
    
    // Fetch live data
    async function fetchLiveData() {
      try {
        const response = await fetch('/api/data');
        if (!response.ok) throw new Error('Failed to fetch live data');
        liveData = await response.json();
        updateConnectionStatus(true);
        return liveData;
      } catch (error) {
        console.error('Live data fetch error:', error);
        updateConnectionStatus(false);
        return null;
      }
    }
    
    // Update connection status indicator
    function updateConnectionStatus(connected) {
      const indicator = document.getElementById('connection-status');
      if (connected) {
        indicator.style.background = 'var(--success)';
      } else {
        indicator.style.background = 'var(--danger)';
      }
    }
    
    // Load analytics data from API
    async function loadAnalyticsData() {
      const startDate = document.getElementById('start-date').value;
      const endDate = document.getElementById('end-date').value;
      const dgSelect = document.getElementById('dg-select').value;
      
      if (!startDate || !endDate) {
        showMessage('warning', 'Please select both start and end dates');
        return;
      }
      
      const spinner = document.getElementById('loading-spinner');
      spinner.classList.add('active');
      
      try {
        const params = new URLSearchParams({ 
          startDate, 
          endDate,
          dg: dgSelect !== 'all' ? dgSelect : ''
        });
        
        const response = await fetch(`/api/history?${params.toString()}`);
        if (!response.ok) throw new Error('Failed to fetch historical data');
        
        currentData = await response.json();
        
        if (currentData.length === 0) {
          showMessage('warning', 'No data found for the selected date range');
          spinner.classList.remove('active');
          return;
        }
        
        showMessage('success', `Loaded ${currentData.length} records successfully`);
        
        // Update all visualizations
        updateDieselOverview(currentData);
        updateElectricalOverview(currentData);
        updateDGDetails('dg1', currentData);
        updateDGDetails('dg2', currentData);
        updateDGDetails('dg3', currentData);
        updateDGDetails('dg4', currentData);
        updateHistoricalTable(currentData);
        
      } catch (error) {
        console.error('Analytics load error:', error);
        showMessage('error', `Error loading data: ${error.message}`);
      } finally {
        spinner.classList.remove('active');
      }
    }
    
    // Update Diesel Overview
    function updateDieselOverview(data) {
      if (!data || data.length === 0) return;
      
      // Calculate statistics
      const latest = data[data.length - 1];
      const statsGrid = document.getElementById('diesel-stats-grid');
      
      const dg1Avg = calculateAverage(data, 'dg1_diesel');
      const dg2Avg = calculateAverage(data, 'dg2_diesel');
      const dg3Avg = calculateAverage(data, 'dg3_diesel');
      
      statsGrid.innerHTML = `
        <div class="stat-card diesel">
          <div class="stat-label">DG-1 Current Level</div>
          <div class="stat-value">${formatNumber(latest.dg1_diesel, 0)}</div>
          <div class="stat-unit">Liters</div>
          <div class="stat-change ${latest.dg1_diesel > 100 ? 'positive' : 'negative'}">
            Avg: ${formatNumber(dg1Avg, 0)}L
          </div>
        </div>
        <div class="stat-card diesel">
          <div class="stat-label">DG-2 Current Level</div>
          <div class="stat-value">${formatNumber(latest.dg2_diesel, 0)}</div>
          <div class="stat-unit">Liters</div>
          <div class="stat-change ${latest.dg2_diesel > 100 ? 'positive' : 'negative'}">
            Avg: ${formatNumber(dg2Avg, 0)}L
          </div>
        </div>
        <div class="stat-card diesel">
          <div class="stat-label">DG-3 Current Level</div>
          <div class="stat-value">${formatNumber(latest.dg3_diesel, 0)}</div>
          <div class="stat-unit">Liters</div>
          <div class="stat-change ${latest.dg3_diesel > 100 ? 'positive' : 'negative'}">
            Avg: ${formatNumber(dg3Avg, 0)}L
          </div>
        </div>
        <div class="stat-card diesel">
          <div class="stat-label">Total Diesel</div>
          <div class="stat-value">${formatNumber(latest.dg1_diesel + latest.dg2_diesel + latest.dg3_diesel, 0)}</div>
          <div class="stat-unit">Liters</div>
          <div class="stat-change positive">
            Combined Stock
          </div>
        </div>
      `;
      
      // Create bar chart
      createDieselBarChart(latest);
    }
    
    // Create diesel bar chart
    function createDieselBarChart(data) {
      const container = document.getElementById('diesel-bars');
      const maxValue = Math.max(data.dg1_diesel, data.dg2_diesel, data.dg3_diesel, 600);
      
      const bars = [
        { label: 'DG-1', value: data.dg1_diesel, color: '#3b82f6' },
        { label: 'DG-2', value: data.dg2_diesel, color: '#10b981' },
        { label: 'DG-3', value: data.dg3_diesel, color: '#f59e0b' }
      ];
      
      container.innerHTML = bars.map(bar => {
        const height = (bar.value / maxValue) * 100;
        return `
          <div class="bar-group">
            <div class="bar" style="height: ${height}%; background: linear-gradient(180deg, ${bar.color}, ${bar.color}dd);">
              <div class="bar-value">${formatNumber(bar.value, 0)}L</div>
            </div>
            <div class="bar-label">${bar.label}</div>
          </div>
        `;
      }).join('');
    }
    
    // Update Electrical Overview
    function updateElectricalOverview(data) {
      if (!data || data.length === 0) return;
      
      const latest = data[data.length - 1];
      const statsGrid = document.getElementById('electrical-stats-grid');
      
      // Get electrical data for all DGs
      const dgs = ['dg1', 'dg2', 'dg3', 'dg4'];
      let statsHTML = '';
      
      dgs.forEach(dg => {
        const power = latest[`${dg}_activePower`] || 0;
        const voltage = latest[`${dg}_voltageR`] || 0;
        const current = latest[`${dg}_currentR`] || 0;
        const frequency = latest[`${dg}_frequency`] || 0;
        
        const isRunning = power > 5;
        
        statsHTML += `
          <div class="stat-card electrical">
            <div class="stat-label">${dg.toUpperCase()} Status</div>
            <div class="stat-value" style="font-size: 1.5rem; color: ${isRunning ? 'var(--success)' : 'var(--danger)'}">
              ${isRunning ? 'RUNNING' : 'OFF'}
            </div>
            <div class="stat-unit">Power: ${formatNumber(power, 1)} kW</div>
          </div>
        `;
      });
      
      statsGrid.innerHTML = statsHTML;
      
      // Create power bar chart
      createPowerBarChart(latest, dgs);
      createVoltageBarChart(latest, dgs);
    }
    
    // Create power bar chart
    function createPowerBarChart(data, dgs) {
      const container = document.getElementById('power-bars');
      const powers = dgs.map(dg => data[`${dg}_activePower`] || 0);
      const maxValue = Math.max(...powers, 100);
      
      container.innerHTML = dgs.map((dg, idx) => {
        const power = powers[idx];
        const height = (power / maxValue) * 100;
        const colors = ['#3b82f6', '#10b981', '#f59e0b', '#8b5cf6'];
        
        return `
          <div class="bar-group">
            <div class="bar" style="height: ${height}%; background: linear-gradient(180deg, ${colors[idx]}, ${colors[idx]}dd);">
              <div class="bar-value">${formatNumber(power, 1)} kW</div>
            </div>
            <div class="bar-label">${dg.toUpperCase()}</div>
          </div>
        `;
      }).join('');
    }
    
    // Create voltage bar chart
    function createVoltageBarChart(data, dgs) {
      const container = document.getElementById('voltage-bars');
      const voltages = dgs.map(dg => {
        const vR = data[`${dg}_voltageR`] || 0;
        const vY = data[`${dg}_voltageY`] || 0;
        const vB = data[`${dg}_voltageB`] || 0;
        return (vR + vY + vB) / 3;
      });
      const maxValue = 250;
      
      container.innerHTML = dgs.map((dg, idx) => {
        const voltage = voltages[idx];
        const height = (voltage / maxValue) * 100;
        const colors = ['#3b82f6', '#10b981', '#f59e0b', '#8b5cf6'];
        
        return `
          <div class="bar-group">
            <div class="bar" style="height: ${height}%; background: linear-gradient(180deg, ${colors[idx]}, ${colors[idx]}dd);">
              <div class="bar-value">${formatNumber(voltage, 1)} V</div>
            </div>
            <div class="bar-label">${dg.toUpperCase()}</div>
          </div>
        `;
      }).join('');
    }
    
    // Update individual DG details
    function updateDGDetails(dg, data) {
      if (!data || data.length === 0) return;
      
      const filtered = data.filter(item => item[`${dg}_activePower`] !== undefined);
      if (filtered.length === 0) return;
      
      const latest = filtered[filtered.length - 1];
      const statsGrid = document.getElementById(`${dg}-stats`);
      const tableInfo = document.getElementById(`${dg}-table-info`);
      const table = document.getElementById(`${dg}-table`);
      
      // Update stats
      const params = [
        { key: 'activePower', label: 'Active Power', unit: 'kW' },
        { key: 'voltageR', label: 'Voltage R', unit: 'V' },
        { key: 'currentR', label: 'Current R', unit: 'A' },
        { key: 'frequency', label: 'Frequency', unit: 'Hz' },
        { key: 'powerFactor', label: 'Power Factor', unit: '' },
        { key: 'energyMeter', label: 'Energy', unit: 'kWh' }
      ];
      
      statsGrid.innerHTML = params.map(param => {
        const value = latest[`${dg}_${param.key}`] || 0;
        const avg = calculateAverage(filtered, `${dg}_${param.key}`);
        
        return `
          <div class="stat-card electrical">
            <div class="stat-label">${param.label}</div>
            <div class="stat-value">${formatNumber(value, param.key === 'powerFactor' ? 2 : 1)}</div>
            <div class="stat-unit">${param.unit}</div>
            <div class="stat-change positive">Avg: ${formatNumber(avg, 1)} ${param.unit}</div>
          </div>
        `;
      }).join('');
      
      // Update table
      tableInfo.textContent = `Showing ${filtered.length} records`;
      
      const thead = table.querySelector('thead');
      const tbody = table.querySelector('tbody');
      
      // Create headers
      const headers = ['Timestamp', 'Diesel (L)', 'Voltage R (V)', 'Voltage Y (V)', 'Voltage B (V)', 
                       'Current R (A)', 'Current Y (A)', 'Current B (A)', 'Active Power (kW)', 
                       'Frequency (Hz)', 'Power Factor'];
      
      thead.innerHTML = `<tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr>`;
      
      // Create rows (show last 50 records)
      const recentData = filtered.slice(-50).reverse();
      tbody.innerHTML = recentData.map(item => {
        return `
          <tr>
            <td>${formatTimestamp(item.timestamp)}</td>
            <td>${formatNumber(item[`${dg.replace('dg', 'dg')}_diesel`] || item[dg.replace('dg', 'dg') + '_diesel'], 0)}</td>
            <td>${formatNumber(item[`${dg}_voltageR`], 1)}</td>
            <td>${formatNumber(item[`${dg}_voltageY`], 1)}</td>
            <td>${formatNumber(item[`${dg}_voltageB`], 1)}</td>
            <td>${formatNumber(item[`${dg}_currentR`], 1)}</td>
            <td>${formatNumber(item[`${dg}_currentY`], 1)}</td>
            <td>${formatNumber(item[`${dg}_currentB`], 1)}</td>
            <td>${formatNumber(item[`${dg}_activePower`], 1)}</td>
            <td>${formatNumber(item[`${dg}_frequency`], 2)}</td>
            <td>${formatNumber(item[`${dg}_powerFactor`], 2)}</td>
          </tr>
        `;
      }).join('');
    }
    
    // Update historical table
    function updateHistoricalTable(data) {
      if (!data || data.length === 0) return;
      
      const tableInfo = document.getElementById('historical-table-info');
      const table = document.getElementById('historical-table');
      const thead = table.querySelector('thead');
      const tbody = table.querySelector('tbody');
      
      tableInfo.textContent = `Showing ${data.length} records`;
      
      // Create headers dynamically from first data item
      const headers = Object.keys(data[0]).filter(key => key !== 'electrical');
      thead.innerHTML = `<tr>${headers.map(h => `<th>${formatHeader(h)}</th>`).join('')}</tr>`;
      
      // Create rows (show last 100 records)
      const recentData = data.slice(-100).reverse();
      tbody.innerHTML = recentData.map(item => {
        return `
          <tr>
            ${headers.map(key => {
              if (key === 'timestamp') {
                return `<td>${formatTimestamp(item[key])}</td>`;
              } else if (typeof item[key] === 'number') {
                return `<td>${formatNumber(item[key], key.includes('powerFactor') ? 2 : 1)}</td>`;
              } else {
                return `<td>${item[key] || '--'}</td>`;
              }
            }).join('')}
          </tr>
        `;
      }).join('');
    }
    
    // Download Excel report
    async function downloadExcelReport() {
      const startDate = document.getElementById('start-date').value;
      const endDate = document.getElementById('end-date').value;
      const dgSelect = document.getElementById('dg-select').value;
      
      if (!startDate || !endDate) {
        showMessage('warning', 'Please select both start and end dates');
        return;
      }
      
      showMessage('info', 'Generating Excel report... Please wait');
      
      try {
        const params = new URLSearchParams({ 
          startDate, 
          endDate,
          dg: dgSelect !== 'all' ? dgSelect : ''
        });
        
        const url = `/api/download/excel?${params.toString()}`;
        window.open(url, '_blank');
        
        setTimeout(() => {
          showMessage('success', 'Excel report download initiated');
        }, 1000);
        
      } catch (error) {
        console.error('Excel download error:', error);
        showMessage('error', 'Failed to download Excel report');
      }
    }
    
    // Utility functions
    function formatNumber(num, decimals = 1) {
      if (num === undefined || num === null || isNaN(num)) return '--';
      return num.toFixed(decimals);
    }
    
    function formatTimestamp(timestamp) {
      if (!timestamp) return '--';
      const date = new Date(timestamp);
      return date.toLocaleString('en-IN', { 
        timeZone: 'Asia/Kolkata',
        dateStyle: 'short',
        timeStyle: 'medium'
      });
    }
    
    function formatHeader(key) {
      return key
        .replace(/_/g, ' ')
        .replace(/dg(\d)/g, 'DG-$1')
        .replace(/([A-Z])/g, ' $1')
        .trim()
        .toUpperCase();
    }
    
    function calculateAverage(data, key) {
      if (!data || data.length === 0) return 0;
      const values = data.map(item => item[key] || 0).filter(v => v > 0);
      if (values.length === 0) return 0;
      return values.reduce((a, b) => a + b, 0) / values.length;
    }
    
    // Auto-refresh live data every 5 seconds
    setInterval(async () => {
      await fetchLiveData();
    }, 5000);
    
    // Initial load
    fetchLiveData();
    
    // Make functions available globally
    window.switchTab = switchTab;
    window.applyQuickRange = applyQuickRange;
    window.loadAnalyticsData = loadAnalyticsData;
    window.downloadExcelReport = downloadExcelReport;
  </script>
</body>
</html>
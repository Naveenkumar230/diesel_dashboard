<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>DG Electrical Details</title>
<link rel="icon" type="image/png" href="/logo.png">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
  :root {
    --primary: #0052cc; --success: #00875a; --warning: #ffab00; --danger: #de350b;
    --bg-primary: #ffffff; --bg-secondary: #f4f5f7; --bg-tertiary: #ffffff;
    --text-primary: #172b4d; --text-secondary: #42526e; --text-muted: #6b778c;
    --border: #dfe1e6;
    --volt: #fa8231; --curr: #eb3b5a; --power: #20bf6b; --freq: #8854d0;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { background: var(--bg-primary); font-family: 'Segoe UI', Tahoma, sans-serif; color: var(--text-primary); min-height: 100vh; padding: 15px; }
  .container { max-width: 1600px; margin: 0 auto; }
  .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 20px; background: var(--bg-secondary); border-radius: 12px; border: 1px solid var(--border); flex-wrap: wrap; gap: 15px; }
  .header-left h1 { font-size: 1.8rem; background: linear-gradient(90deg, #0052cc, #0065ff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 5px; }
  .header-left .subtitle { font-size: 0.9rem; color: var(--text-muted); }
  .header-right { display: flex; gap: 10px; flex-wrap: wrap; }
  .btn { padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; transition: all 0.3s; text-decoration: none; display: inline-block; font-size: 0.95rem; }
  .btn-primary { background: var(--primary); color: white; }
  .btn-primary:hover { background: #0041a3; transform: translateY(-2px); }
  .btn-success { background: var(--success); color: white; }
  .btn-success:hover { background: #006644; transform: translateY(-2px); }
  .btn-secondary { background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border); }
  .btn-secondary:hover { background: #dfe1e6; }
  .filters { background: var(--bg-secondary); border: 1px solid var(--border); padding: 20px; border-radius: 12px; margin-bottom: 20px; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
  .filter-group { display: flex; flex-direction: column; gap: 8px; }
  label { font-size: 0.9rem; color: var(--text-muted); font-weight: 600; }
  input, select { padding: 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--bg-tertiary); color: var(--text-primary); font-size: 0.95rem; }
  .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px; }
  .stat-card { background: var(--bg-tertiary); border: 1px solid var(--border); padding: 20px; border-radius: 12px; text-align: center; border-top: 4px solid var(--primary); }
  .stat-label { font-size: 0.85rem; color: var(--text-muted); margin-bottom: 10px; text-transform: uppercase; letter-spacing: 0.5px; }
  .stat-value { font-size: 2.2rem; font-weight: 800; margin-bottom: 5px; color: var(--text-primary); }
  .stat-unit { font-size: 0.85rem; color: var(--text-muted); }
  .chart-section { background: var(--bg-secondary); border: 1px solid var(--border); padding: 25px; border-radius: 12px; margin-bottom: 20px; }
  .chart-title { font-size: 1.3rem; font-weight: 700; margin-bottom: 20px; color: var(--text-primary); border-left: 4px solid var(--primary); padding-left: 15px; }
  
  /* Split and Combined Charts */
  .chart-grid-split { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
  .chart-container-split { position: relative; height: 350px; }
  .chart-container-combined { position: relative; height: 450px; }

  .timeline-section { background: var(--bg-secondary); border: 1px solid var(--border); padding: 25px; border-radius: 12px; margin-bottom: 20px; }
  .timeline-item { display: flex; align-items: center; gap: 15px; padding: 15px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 8px; border-left: 4px solid var(--success); }
  .timeline-item.stopped { border-left-color: var(--danger); }
  .timeline-time { font-weight: 700; min-width: 150px; font-size: 0.95rem; color: var(--text-primary); }
  .timeline-status { padding: 5px 12px; border-radius: 12px; font-size: 0.8rem; font-weight: 700; text-transform: uppercase; }
  .timeline-status.running { background: var(--success); color: white; }
  .timeline-status.stopped { background: var(--danger); color: white; }
  .timeline-details { font-size: 0.9rem; color: var(--text-secondary); }
  .loading, .empty-state { text-align: center; padding: 60px; color: var(--text-muted); font-size: 1.2rem; }
  .empty-state { background: var(--bg-secondary); border-radius: 12px; }
  .empty-state-icon { font-size: 4rem; margin-bottom: 20px; opacity: 0.5; }

  @media (max-width: 1024px) { .chart-grid-split { grid-template-columns: 1fr; } }
  @media (max-width: 768px) { .header { flex-direction: column; align-items: flex-start; } .header-right { width: 100%; flex-direction: column; } .btn { width: 100%; text-align: center; } }
</style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="header-left">
        <h1 id="page-title">DG Electrical Details</h1>
        <div class="subtitle" id="date-range">Loading...</div>
      </div>
      <div class="header-right">
        <button class="btn btn-success" onclick="exportElectricalData()">üì• Download Electrical Data</button>
        <a href="/" class="btn btn-secondary">‚Üê Back to Dashboard</a>
      </div>
    </div>

    <div class="filters">
      <div class="filter-group">
        <label>From Date</label>
        <input type="date" id="start-date" />
      </div>
      <div class="filter-group">
        <label>To Date</label>
        <input type="date" id="end-date" />
      </div>
      <div class="filter-group">
        <label>Quick Select</label>
        <select id="quick-select">
          <option value="today" selected>Today</option> <option value="yesterday">Yesterday</option>
          <option value="week">Last 7 Days</option>
          <option value="month">Last 30 Days</option>
          <option value="custom">Custom Range</option>
        </select>
      </div>
      <div class="filter-group" style="justify-content: flex-end;">
        <label>&nbsp;</label>
        <button class="btn btn-primary" onclick="loadData()">Apply Filter</button>
      </div>
    </div>

    <div class="stats-grid">
      <div class="stat-card" style="border-top-color: var(--success);"><div class="stat-label">Total Running Hours</div><div class="stat-value" id="total-hours">--</div><div class="stat-unit">Hours</div></div>
      <div class="stat-card" style="border-top-color: var(--primary);"><div class="stat-label">Total Energy (kWh)</div><div class="stat-value" id="total-kwh">--</div><div class="stat-unit">kWh</div></div>
      <div class="stat-card" style="border-top-color: var(--warning);"><div class="stat-label">Average Load %</div><div class="stat-value" id="avg-load">--</div><div class="stat-unit">Percent</div></div>
      <div class="stat-card" style="border-top-color: var(--danger);"><div class="stat-label">Peak Active Power</div><div class="stat-value" id="peak-kw">--</div><div class="stat-unit">kW</div></div>
    </div>

    <div class="chart-grid-split">
      <div class="chart-section"><div class="chart-title">Voltage (V)</div><div class="chart-container-split"><canvas id="voltageChart"></canvas></div></div>
      <div class="chart-section"><div class="chart-title">Current (A)</div><div class="chart-container-split"><canvas id="currentChart"></canvas></div></div>
      <div class="chart-section"><div class="chart-title">Power (kW / kVAR)</div><div class="chart-container-split"><canvas id="powerChart"></canvas></div></div>
      <div class="chart-section"><div class="chart-title">Frequency (Hz) & Power Factor</div><div class="chart-container-split"><canvas id="freqPfChart"></canvas></div></div>
    </div>

    <div class="chart-section">
      <div class="chart-title">All Parameters Combined</div>
      <div class="chart-container-combined">
        <canvas id="combinedChart"></canvas>
      </div>
    </div>
    <div id="loading" class="loading" style="display:none;">‚è≥ Loading data...</div>
    <div id="empty-state" class="empty-state" style="display:none;">
      <div class="empty-state-icon">üì≠</div>
      <h2>No Data Available</h2>
      <p>No electrical data found for this DG in the selected date range.</p>
    </div>
  </div>

<script>
// electrical.html - FINAL VERSION: 7AM START + STICKY STATS + NOISE FILTER

let voltageChart, currentChart, powerChart, freqPfChart, combinedChart;
let dgType = 'dg1';
const DG_MAX_KW = { dg1: 500, dg2: 500, dg3: 380, dg4: 380 };

// ‚úÖ 1. LOAD STICKY VALUES (Restore last known values)
let stickyValues = JSON.parse(localStorage.getItem('dgStickyStats_' + dgType)) || {
  totalHours: '--', totalKwh: '--', avgLoad: '--', peakKw: '--'
};

const urlParams = new URLSearchParams(window.location.search);
if (urlParams.get('dg')) dgType = urlParams.get('dg');

document.getElementById('page-title').textContent = `‚öôÔ∏è ${dgType.toUpperCase().replace('DG', 'DG-')} Electrical Details`;
renderStickyStats();

function setDateRange(range) {
    const end = new Date();
    const start = new Date();
    if (range === 'yesterday') {
        start.setDate(start.getDate() - 1);
        end.setDate(end.getDate() - 1);
    } else if (range === 'week') {
        start.setDate(start.getDate() - 6);
    } else if (range === 'month') {
        start.setDate(start.getDate() - 29);
    }
    document.getElementById('start-date').value = start.toISOString().split('T')[0];
    document.getElementById('end-date').value = end.toISOString().split('T')[0];
}

setDateRange('today'); 
document.getElementById('quick-select').value = 'today';
document.getElementById('quick-select').addEventListener('change', function() {
  if (this.value !== 'custom') setDateRange(this.value);
});

// ‚úÖ HELPER: GENERATE 0 DATA FROM 7 AM TO NOW
function generateZeroDataForTimeline() {
    const now = new Date();
    const data = [];
    let currentHour = 7; // Start at 7 AM
    let currentMinute = 0;
    
    // End at Current Time
    let endHour = now.getHours();
    let endMinute = now.getMinutes();

    while (currentHour < endHour || (currentHour === endHour && currentMinute <= endMinute)) {
        const d = new Date();
        d.setHours(currentHour, currentMinute, 0, 0);
        
        data.push({
            timestamp: d.toISOString(),
            voltageR: 0, voltageY: 0, voltageB: 0,
            currentR: 0, currentY: 0, currentB: 0,
            activePower: 0, reactivePower: 0, frequency: 0, powerFactor: 0, energyMeter: 0
        });

        currentMinute += 30;
        if (currentMinute >= 60) { currentMinute = 0; currentHour++; }
    }
    return data;
}

async function loadData() {
  const startDate = document.getElementById('start-date').value;
  const endDate = document.getElementById('end-date').value;
  if (!startDate || !endDate) { alert('Please select dates'); return; }
  
  document.getElementById('loading').style.display = 'block';
  document.getElementById('empty-state').style.display = 'none';
  clearCharts();

  try {
    const url = `/api/electrical/${dgType}?startDate=${startDate}&endDate=${endDate}`;
    const response = await fetch(url);
    const result = await response.json();

    // ‚úÖ CHECK: If Today and No Data, Generate Zero Data
    let displayData = result.data || [];
    const isToday = (startDate === new Date().toISOString().split('T')[0]);

    if (displayData.length === 0 && isToday) {
        console.log("No data yet today. Generating 7 AM zero-line.");
        displayData = generateZeroDataForTimeline();
        document.getElementById('empty-state').style.display = 'none'; // Hide empty state because we are showing a 0-graph
    } else if (displayData.length === 0) {
        showEmptyState();
        return; // Stop if it's history and empty
    }

    processData(displayData, startDate, endDate);
    document.getElementById('empty-state').style.display = 'none';

  } catch (err) {
    console.error('Error:', err);
    showEmptyState();
  } finally {
    document.getElementById('loading').style.display = 'none';
  }
}

function showEmptyState() {
  document.getElementById('empty-state').style.display = 'block';
  clearCharts();
}

function clearCharts() {
  if (voltageChart) voltageChart.destroy();
  if (currentChart) currentChart.destroy();
  if (powerChart) powerChart.destroy();
  if (freqPfChart) freqPfChart.destroy();
  if (combinedChart) combinedChart.destroy();
}

function updateStickyStats(totalHours, totalKwh, avgLoad, peakKw) {
  stickyValues = {
    totalHours: totalHours.toFixed(1),
    totalKwh: totalKwh.toFixed(0),
    avgLoad: avgLoad.toFixed(1),
    peakKw: peakKw.toFixed(1)
  };
  localStorage.setItem('dgStickyStats_' + dgType, JSON.stringify(stickyValues));
  renderStickyStats();
}

function renderStickyStats() {
  if(stickyValues.totalHours !== '--') {
      document.getElementById('total-hours').textContent = stickyValues.totalHours;
      document.getElementById('total-kwh').textContent = stickyValues.totalKwh;
      document.getElementById('avg-load').textContent = stickyValues.avgLoad;
      document.getElementById('peak-kw').textContent = stickyValues.peakKw;
  }
}

function processData(data, startDate, endDate) {
  const startStr = new Date(startDate).toLocaleDateString('en-IN', { day: 'numeric', month: 'long' });
  document.getElementById('date-range').textContent = startStr;

  // ‚úÖ STATS: STRICTLY IGNORE "OFF" DATA (Voltage < 200V)
  const runningData = data.filter(r => r.voltageR > 200);

  if (runningData.length > 0) {
      let totalRunningHours = runningData.length * 0.5; 
      let totalKwh = 0;
      // Kwh is cumulative, try to find max - min
      const validMeters = runningData.map(r => r.energyMeter).filter(e => e > 0).sort((a,b)=>a-b);
      if (validMeters.length > 1) {
          totalKwh = validMeters[validMeters.length - 1] - validMeters[0];
      }

      let peakKw = 0;
      let loadSum = 0;
      const maxKw = DG_MAX_KW[dgType] || 500;

      runningData.forEach(r => {
        if (r.activePower > peakKw) peakKw = r.activePower;
        loadSum += (r.activePower / maxKw) * 100;
      });

      const avgLoad = (loadSum / runningData.length);
      updateStickyStats(totalRunningHours, totalKwh, avgLoad, peakKw);
  } 
  
  // ‚úÖ GRAPH: Use ALL data (including 0s) to draw the lines
  updateSplitCharts(data); 
  updateCombinedChart(data);
}

function updateSplitCharts(data) {
  if (data.length === 0) return;
  const labels = data.map(r => new Date(r.timestamp).toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' }));
  const commonOptions = { responsive: true, maintainAspectRatio: false, scales: { x: { ticks: { maxRotation: 45, minRotation: 45 }, grid: { display: false } }, y: { beginAtZero: true } } };
  const lineOpts = { tension: 0.1, pointRadius: 2, borderWidth: 2, fill: false };

  if (voltageChart) voltageChart.destroy();
  voltageChart = new Chart(document.getElementById('voltageChart'), {
    type: 'line', data: { labels, datasets: [
        { label: 'V-R', data: data.map(r => r.voltageR), borderColor: '#fa8231', ...lineOpts },
        { label: 'V-Y', data: data.map(r => r.voltageY), borderColor: '#f7b731', ...lineOpts },
        { label: 'V-B', data: data.map(r => r.voltageB), borderColor: '#0052cc', ...lineOpts }
    ]}, options: commonOptions
  });

  if (currentChart) currentChart.destroy();
  currentChart = new Chart(document.getElementById('currentChart'), {
    type: 'line', data: { labels, datasets: [
        { label: 'C-R', data: data.map(r => r.currentR), borderColor: '#eb3b5a', ...lineOpts },
        { label: 'C-Y', data: data.map(r => r.currentY), borderColor: '#a55eea', ...lineOpts },
        { label: 'C-B', data: data.map(r => r.currentB), borderColor: '#2bcbba', ...lineOpts }
    ]}, options: commonOptions
  });

  if (powerChart) powerChart.destroy();
  powerChart = new Chart(document.getElementById('powerChart'), {
    type: 'line', data: { labels, datasets: [
        { label: 'Active (kW)', data: data.map(r => r.activePower), borderColor: '#20bf6b', ...lineOpts, borderWidth: 3 },
        { label: 'Reactive (kVAR)', data: data.map(r => r.reactivePower), borderColor: '#4b6584', ...lineOpts, borderDash: [5,5] }
    ]}, options: commonOptions
  });

  if (freqPfChart) freqPfChart.destroy();
  freqPfChart = new Chart(document.getElementById('freqPfChart'), {
    type: 'line', data: { labels, datasets: [
        { label: 'Freq (Hz)', data: data.map(r => r.frequency), borderColor: '#8854d0', yAxisID: 'yHz', ...lineOpts },
        { label: 'PF', data: data.map(r => r.powerFactor), borderColor: '#172b4d', yAxisID: 'yPF', ...lineOpts }
    ]}, options: { ...commonOptions, scales: { ...commonOptions.scales, yHz: { position: 'left' }, yPF: { position: 'right', min: 0, max: 1 } } }
  });
}

function updateCombinedChart(data) {
  if (data.length === 0) return;
  const labels = data.map(r => new Date(r.timestamp).toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' }));
  if (combinedChart) combinedChart.destroy();
  const lineOpts = { tension: 0.1, pointRadius: 1, borderWidth: 2, fill: false };

  combinedChart = new Chart(document.getElementById('combinedChart'), {
    type: 'line',
    data: {
        labels,
        datasets: [
            { label: 'Voltage (Avg)', data: data.map(r => (r.voltageR+r.voltageY+r.voltageB)/3), borderColor: '#fa8231', yAxisID: 'yV', ...lineOpts },
            { label: 'Current (Avg)', data: data.map(r => (r.currentR+r.currentY+r.currentB)/3), borderColor: '#eb3b5a', yAxisID: 'yA', ...lineOpts },
            { label: 'Power (kW)', data: data.map(r => r.activePower), borderColor: '#20bf6b', yAxisID: 'yP', ...lineOpts, borderWidth: 3 },
            { label: 'Freq (Hz)', data: data.map(r => r.frequency), borderColor: '#8854d0', yAxisID: 'yF', ...lineOpts },
            { label: 'Power Factor', data: data.map(r => r.powerFactor), borderColor: '#172b4d', yAxisID: 'yPF', ...lineOpts }
        ]
    },
    options: {
        responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false },
        scales: {
            x: { ticks: { maxRotation: 45, minRotation: 45 }, grid: { display: false } },
            yV: { position: 'left', title: {display: true, text: 'Volts'} },
            yA: { position: 'right', title: {display: true, text: 'Amps'}, grid: {drawOnChartArea: false} },
            yP: { position: 'right', title: {display: true, text: 'kW'}, grid: {drawOnChartArea: false}, offset: true },
            yF: { position: 'left', title: {display: true, text: 'Hz'}, grid: {drawOnChartArea: false}, offset: true },
            yPF: { position: 'right', title: {display: true, text: 'PF'}, min: 0, max: 1, grid: {drawOnChartArea: false}, offset: true }
        }
    }
  });
}

function exportElectricalData() {
  const startDate = document.getElementById('start-date').value;
  const endDate = document.getElementById('end-date').value;
  window.location.href = `/api/export/electrical/${dgType}?startDate=${startDate}&endDate=${endDate}`;
}

loadData();
</script>
</body>
</html>
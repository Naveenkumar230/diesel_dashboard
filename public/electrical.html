<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>DG Electrical Details</title>
<link rel="icon" type="image/png" href="/logo.png">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
  :root {
    --primary: #0052cc; --success: #00875a; --warning: #ffab00; --danger: #de350b;
    --bg-primary: #ffffff; --bg-secondary: #f4f5f7; --bg-tertiary: #ffffff;
    --text-primary: #172b4d; --text-secondary: #42526e; --text-muted: #6b778c;
    --border: #dfe1e6;
    --volt: #fa8231; --curr: #eb3b5a; --power: #20bf6b; --freq: #8854d0;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { background: var(--bg-primary); font-family: 'Segoe UI', Tahoma, sans-serif; color: var(--text-primary); min-height: 100vh; padding: 15px; }
  .container { max-width: 1600px; margin: 0 auto; }
  .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 20px; background: var(--bg-secondary); border-radius: 12px; border: 1px solid var(--border); flex-wrap: wrap; gap: 15px; }
  .header-left h1 { font-size: 1.8rem; background: linear-gradient(90deg, #0052cc, #0065ff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 5px; }
  .header-left .subtitle { font-size: 0.9rem; color: var(--text-muted); }
  .header-right { display: flex; gap: 10px; flex-wrap: wrap; }
  .btn { padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; transition: all 0.3s; text-decoration: none; display: inline-block; font-size: 0.95rem; }
  .btn-primary { background: var(--primary); color: white; }
  .btn-primary:hover { background: #0041a3; transform: translateY(-2px); }
  .btn-success { background: var(--success); color: white; }
  .btn-success:hover { background: #006644; transform: translateY(-2px); }
  .btn-secondary { background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border); }
  .btn-secondary:hover { background: #dfe1e6; }
  .filters { background: var(--bg-secondary); border: 1px solid var(--border); padding: 20px; border-radius: 12px; margin-bottom: 20px; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
  .filter-group { display: flex; flex-direction: column; gap: 8px; }
  label { font-size: 0.9rem; color: var(--text-muted); font-weight: 600; }
  input, select { padding: 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--bg-tertiary); color: var(--text-primary); font-size: 0.95rem; }
  .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px; }
  .stat-card { background: var(--bg-tertiary); border: 1px solid var(--border); padding: 20px; border-radius: 12px; text-align: center; border-top: 4px solid var(--primary); }
  .stat-label { font-size: 0.85rem; color: var(--text-muted); margin-bottom: 10px; text-transform: uppercase; letter-spacing: 0.5px; }
  .stat-value { font-size: 2.2rem; font-weight: 800; margin-bottom: 5px; color: var(--text-primary); }
  .stat-unit { font-size: 0.85rem; color: var(--text-muted); }
  .chart-section { background: var(--bg-secondary); border: 1px solid var(--border); padding: 25px; border-radius: 12px; margin-bottom: 20px; }
  .chart-title { font-size: 1.3rem; font-weight: 700; margin-bottom: 20px; color: var(--text-primary); border-left: 4px solid var(--primary); padding-left: 15px; }
  

  /* --- NEW CSS FOR SMART ANALYTICS SECTION --- */

/* 1. The Container for the new section */
.smart-analytics-section {
    background: #ffffff;
    border: 1px solid #dfe1e6;
    border-left: 5px solid #0052cc; /* Blue accent line on left */
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 25px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.02);
}

/* 2. Colored Stat Cards */
/* These overrides change the top border color */
.stat-card.blue   { border-top-color: #0052cc; }
.stat-card.green  { border-top-color: #00875a; }
.stat-card.gold   { border-top-color: #d97706; background: #fffbf0; } /* Light yellow bg for money */
.stat-card.purple { border-top-color: #6554c0; }

/* 3. Text Colors for Values */
.val-blue   { color: #0052cc; }
.val-green  { color: #00875a; }
.val-gold   { color: #d97706; }
.val-purple { color: #6554c0; }

/* 4. Smaller Graphs for Cost/Fuel */
/* FIXED: Flexbox layout to stop graph overflow */
.chart-split-container {
    background: #ffffff;
    border: 1px solid #dfe1e6;
    border-radius: 8px;
    padding: 15px;
    height: 320px;       /* Fixed height */
    display: flex;       /* Enable Flexbox */
    flex-direction: column; /* Stack items vertically */
    overflow: hidden;    /* Safety: hide any spillover */
    box-shadow: 0 2px 4px rgba(0,0,0,0.02);
}

/* Wrapper for the canvas to make it responsive inside flex */
.chart-canvas-wrapper {
    flex: 1;             /* Take all remaining height */
    position: relative;  /* Required for Chart.js */
    width: 100%;
    min-height: 0;       /* Crucial flexbox fix */
}

  /* Split and Combined Charts */
  .chart-grid-split { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
  .chart-container-split { position: relative; height: 350px; }
  .chart-container-combined { position: relative; height: 450px; }

  .timeline-section { background: var(--bg-secondary); border: 1px solid var(--border); padding: 25px; border-radius: 12px; margin-bottom: 20px; }
  .timeline-item { display: flex; align-items: center; gap: 15px; padding: 15px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 8px; border-left: 4px solid var(--success); }
  .timeline-item.stopped { border-left-color: var(--danger); }
  .timeline-time { font-weight: 700; min-width: 150px; font-size: 0.95rem; color: var(--text-primary); }
  .timeline-status { padding: 5px 12px; border-radius: 12px; font-size: 0.8rem; font-weight: 700; text-transform: uppercase; }
  .timeline-status.running { background: var(--success); color: white; }
  .timeline-status.stopped { background: var(--danger); color: white; }
  .timeline-details { font-size: 0.9rem; color: var(--text-secondary); }
  .loading, .empty-state { text-align: center; padding: 60px; color: var(--text-muted); font-size: 1.2rem; }
  .empty-state { background: var(--bg-secondary); border-radius: 12px; }
  .empty-state-icon { font-size: 4rem; margin-bottom: 20px; opacity: 0.5; }

  @media (max-width: 1024px) { .chart-grid-split { grid-template-columns: 1fr; } }
  @media (max-width: 768px) { .header { flex-direction: column; align-items: flex-start; } .header-right { width: 100%; flex-direction: column; } .btn { width: 100%; text-align: center; } }
</style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="header-left">
        <h1 id="page-title">DG Electrical Details</h1>
        <div class="subtitle" id="date-range">Loading...</div>
      </div>
      <div class="header-right">
        <button class="btn btn-success" onclick="exportElectricalData()">üì• Download Electrical Data</button>
        <a href="/" class="btn btn-secondary">‚Üê Back to Dashboard</a>
      </div>
    </div>

    <div class="filters">
      <div class="filter-group">
        <label>From Date</label>
        <input type="date" id="start-date" />
      </div>
      <div class="filter-group">
        <label>To Date</label>
        <input type="date" id="end-date" />
      </div>
      <div class="filter-group">
        <label>Quick Select</label>
        <select id="quick-select">
          <option value="today" selected>Today</option> <option value="yesterday">Yesterday</option>
          <option value="week">Last 7 Days</option>
          <option value="month">Last 30 Days</option>
          <option value="custom">Custom Range</option>
        </select>
      </div>
      <div class="filter-group" style="justify-content: flex-end;">
        <label>&nbsp;</label>
        <button class="btn btn-primary" onclick="loadData()">Apply Filter</button>
      </div>
    </div>

  <div class="stats-grid">
    <div class="stat-card" style="border-top-color: #20bf6b;">
      <div class="stat-label">Runtime Hours</div>
      <div class="stat-value" id="plc-runtime">--</div>
      <div class="stat-unit">Hours</div>
    </div>
    <div class="stat-card" style="border-top-color: var(--primary);">
      <div class="stat-label">Total Energy (kWh)</div>
      <div class="stat-value" id="total-kwh">--</div>
      <div class="stat-unit">kWh</div>
    </div>
    <div class="stat-card" style="border-top-color: var(--warning);">
      <div class="stat-label">Average Load %</div>
      <div class="stat-value" id="avg-load">--</div>
      <div class="stat-unit">Percent</div>
    </div>
    <div class="stat-card" style="border-top-color: var(--danger);">
      <div class="stat-label">Peak Active Power</div>
      <div class="stat-value" id="peak-kw">--</div>
      <div class="stat-unit">kW</div>
    </div>
    <div class="stat-card" style="border-top-color: #8854d0;">
      <div class="stat-label">Avg Power Factor</div>
      <div class="stat-value" id="avg-pf">--</div>
      <div class="stat-unit">PF</div>
    </div>
  </div> 
  <div class="smart-analytics-section">
    <div class="chart-title" style="border:none; padding-left:0;">
        üìä Session Analytics (Calculated from Load)
    </div>
    
    <div class="stats-grid" style="grid-template-columns: repeat(4, 1fr); margin-bottom: 20px;">
        
        <div class="stat-card blue">
            <div class="stat-label">‚è±Ô∏è Calc. Run Time</div>
            <div class="stat-value val-blue" id="calc-time">0</div>
            <div class="stat-unit">Minutes</div>
        </div>

        <div class="stat-card green">
            <div class="stat-label">‚õΩ Est. Fuel Used</div>
            <div class="stat-value val-green" id="calc-fuel">0.0</div>
            <div class="stat-unit">Liters</div>
        </div>

        <div class="stat-card gold">
            <div class="stat-label">üí∞ Est. Total Cost</div>
            <div class="stat-value val-gold">
                <span style="font-size: 1.5rem;">‚Çπ</span> <span id="calc-cost">0</span>
            </div>
            <div class="stat-unit">Indian Rupees</div>
        </div>

        <div class="stat-card purple">
            <div class="stat-label">‚ö° Peak Load</div>
            <div class="stat-value val-purple" id="calc-peak">0</div>
            <div class="stat-unit">Amps</div>
        </div>
    </div>

   <div class="chart-grid-split">
        
        <div class="chart-split-container">
            <h3 style="text-align:center; color:#d97706; font-size:1rem; margin-bottom:10px; flex-shrink: 0;">
                üí∞ Running Cost (‚Çπ/hr)
            </h3>
            <div class="chart-canvas-wrapper">
                <canvas id="costGraph"></canvas>
            </div>
        </div>

        <div class="chart-split-container">
            <h3 style="text-align:center; color:#00875a; font-size:1rem; margin-bottom:10px; flex-shrink: 0;">
                ‚õΩ Fuel Rate (L/hr)
            </h3>
            <div class="chart-canvas-wrapper">
                <canvas id="fuelGraph"></canvas>
            </div>
        </div>
        
    </div>
</div>

<div class="chart-grid-split">
  <div class="chart-section">
    <div class="chart-title">Voltage(R Y B)</div>
    <div class="chart-container-split"><canvas id="voltageChart"></canvas></div>
  </div>
  <div class="chart-section">
    <div class="chart-title">Current(R Y B)</div>
    <div class="chart-container-split"><canvas id="currentChart"></canvas></div>
  </div>
  <div class="chart-section">
    <div class="chart-title">Power (kW)</div>
    <div class="chart-container-split"><canvas id="powerChart"></canvas></div>
  </div>
  <div class="chart-section">
    <div class="chart-title">Frequency (Hz)</div>
    <div class="chart-container-split"><canvas id="freqChart"></canvas></div>
  </div>
  <div class="chart-section">
    <div class="chart-title">Power Factor</div>
    <div class="chart-container-split"><canvas id="powerFactorChart"></canvas></div>
  </div>
  <div class="chart-section">
    <div class="chart-title">Runtime Hours</div>
    <div class="chart-container-split"><canvas id="runtimeChart"></canvas></div>
  </div>
</div>

    <div class="chart-section">
      <div class="chart-title">All Parameters Combined</div>
      <div class="chart-container-combined">
        <canvas id="combinedChart"></canvas>
      </div>
    </div>
    <div id="loading" class="loading" style="display:none;">‚è≥ Loading data...</div>
    <div id="empty-state" class="empty-state" style="display:none;">
      <div class="empty-state-icon">üì≠</div>
      <h2>No Data Available</h2>
      <p>No electrical data found for this DG in the selected date range.</p>
    </div>
  </div>

<script>

let voltageChart, currentChart, powerChart, freqChart, powerFactorChart, runtimeChart, combinedChart;
let dgType = 'dg1';
const DG_MAX_KW = { dg1: 500, dg2: 500, dg3: 380, dg4: 380 };

const PRICE_PER_LITER = 97.00;
const MAX_AMPS_125KVA = 175; // 100% Load
let costGraphInstance, fuelGraphInstance; // Store chart instances

let stickyValues = JSON.parse(localStorage.getItem('dgStickyStats_' + dgType)) || {
  totalKwh: '--', avgLoad: '--', peakKw: '--', avgPF: '--', plcRuntime: '--'
};

const urlParams = new URLSearchParams(window.location.search);
if (urlParams.get('dg')) dgType = urlParams.get('dg');

document.getElementById('page-title').textContent = `‚öôÔ∏è ${dgType.toUpperCase().replace('DG', 'DG-')} Electrical Details`;
renderStickyStats();

function setDateRange(range) {
    const end = new Date();
    const start = new Date();
    if (range === 'yesterday') {
        start.setDate(start.getDate() - 1);
        end.setDate(end.getDate() - 1);
    } else if (range === 'week') {
        start.setDate(start.getDate() - 6);
    } else if (range === 'month') {
        start.setDate(start.getDate() - 29);
    }
    document.getElementById('start-date').value = start.toISOString().split('T')[0];
    document.getElementById('end-date').value = end.toISOString().split('T')[0];
}

setDateRange('today'); 
document.getElementById('quick-select').value = 'today';
document.getElementById('quick-select').addEventListener('change', function() {
  if (this.value !== 'custom') setDateRange(this.value);
});

// ‚úÖ HELPER: Generate zero data from 7 AM to now
function generateZeroDataForTimeline() {
    const data = [];
    const now = new Date();
    let currentHour = 7; // Start 7 AM
    
    while (currentHour <= now.getHours()) {
        const d = new Date();
        d.setHours(currentHour, 0, 0, 0);
        
        data.push({
            timestamp: d.toISOString(),
            voltageR: 0, voltageY: 0, voltageB: 0,
            currentR: 0, currentY: 0, currentB: 0,
            activePower: 0, frequency: 0, powerFactor: 0
        });
        currentHour++;
    }
    return data;
}

// ============================================================
// ‚úÖ FIXED loadData - ACCURATE TIME CALCULATION
// ============================================================
async function loadData() {
  const startDate = document.getElementById('start-date').value;
  const endDate = document.getElementById('end-date').value;
  
  document.getElementById('loading').style.display = 'block';
  document.getElementById('empty-state').style.display = 'none';

  try {
    // ‚úÖ STEP 1: Fetch Electrical Data
    const electricalUrl = `/api/electrical/${dgType}?startDate=${startDate}&endDate=${endDate}`;
    const electricalResponse = await fetch(electricalUrl);
    const electricalResult = await electricalResponse.json();
    
    let displayData = electricalResult.data || [];
    
    // If empty and today, generate zero-line
    const isToday = (new Date(startDate).toDateString() === new Date().toDateString());
    if (displayData.length === 0 && isToday) {
        displayData = generateZeroDataForTimeline();
    }

    // ‚úÖ STEP 2: Fetch Diesel Consumption Data (for Running Hours)
    let runningHoursFromDiesel = 0;
    
    try {
        const consumptionUrl = `/api/consumption?dg=${dgType}&startDate=${startDate}&endDate=${endDate}`;
        const consumptionResponse = await fetch(consumptionUrl);
        const consumptionResult = await consumptionResponse.json();
        
        if (consumptionResult.success && consumptionResult.data) {
            // Filter only Running Records
            const runningRecords = consumptionResult.data.filter(r => r.isRunning === true);
            
            // üõë OLD WRONG LOGIC: runningRecords.length * (5 / 60);
            
            // ‚úÖ NEW ACCURATE LOGIC: Sum of Time Differences
            if (runningRecords.length > 0) {
                // Sort by time to be safe
                runningRecords.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

                let totalMs = 0;
                
                for (let i = 0; i < runningRecords.length - 1; i++) {
                    const current = new Date(runningRecords[i].timestamp);
                    const next = new Date(runningRecords[i+1].timestamp);
                    const diff = next - current;

                    // logic: If the gap between two 'Running' records is small (e.g., < 10 mins), 
                    // it means the DG was running continuously. Add the time.
                    // If the gap is huge (e.g., 2 hours), the DG stopped and started again. Don't add the gap.
                    if (diff < 10 * 60 * 1000) { 
                        totalMs += diff;
                    }
                }
                
                // Add a small buffer (e.g. 1 min) for the very last record since it represents a duration
                if (runningRecords.length > 0) totalMs += 60000; 

                // Convert Milliseconds to Hours
                runningHoursFromDiesel = totalMs / (1000 * 60 * 60);
            }
            
            console.log(`‚úÖ Accurate Running Hours: ${runningHoursFromDiesel.toFixed(2)} hours`);
        }
    } catch (err) {
        console.error('‚ö†Ô∏è Failed to fetch diesel consumption data:', err);
        // Fallback: Use electrical data timestamps if diesel data fails
        const runningElec = displayData.filter(r => r.voltageR > 200);
        if (runningElec.length > 1) {
             runningElec.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
             const durationMs = new Date(runningElec[runningElec.length-1].timestamp) - new Date(runningElec[0].timestamp);
             runningHoursFromDiesel = durationMs / (1000 * 60 * 60);
        }
    }

    if (displayData.length > 0) {
        processData(displayData, startDate, endDate, runningHoursFromDiesel);
    } else {
        document.getElementById('empty-state').style.display = 'block';
        clearCharts();
    }

  } catch (err) {
    console.error('Error:', err);
    document.getElementById('empty-state').style.display = 'block';
  } finally {
    document.getElementById('loading').style.display = 'none';
  }
}

function showEmptyState() {
  document.getElementById('empty-state').style.display = 'block';
  clearCharts();
}

function clearCharts() {
  if (voltageChart) voltageChart.destroy();
  if (currentChart) currentChart.destroy();
  if (powerChart) powerChart.destroy();
  if (freqChart) freqChart.destroy();
  if (powerFactorChart) powerFactorChart.destroy();
  if (runtimeChart) runtimeChart.destroy();
  if (combinedChart) combinedChart.destroy();
}

function updateStickyStats(totalKwh, avgLoad, peakKw, avgPF, plcRuntime) {
  stickyValues = {
    totalKwh: totalKwh.toFixed(0),
    avgLoad: avgLoad.toFixed(1),
    peakKw: peakKw.toFixed(1),
    avgPF: avgPF.toFixed(2),
    plcRuntime: plcRuntime.toFixed(1)
  };
  localStorage.setItem('dgStickyStats_' + dgType, JSON.stringify(stickyValues));
  renderStickyStats();
}

function renderStickyStats() {
  if(stickyValues.totalKwh !== '--') {
      document.getElementById('total-kwh').textContent = stickyValues.totalKwh;
      document.getElementById('avg-load').textContent = stickyValues.avgLoad;
      document.getElementById('peak-kw').textContent = stickyValues.peakKw;
      document.getElementById('avg-pf').textContent = stickyValues.avgPF || '--';
      document.getElementById('plc-runtime').textContent = stickyValues.plcRuntime || '--';
  }
}

function processData(data, startDate, endDate) {
  const startStr = new Date(startDate).toLocaleDateString('en-IN', { day: 'numeric', month: 'long' });
  document.getElementById('date-range').textContent = startStr;

  const runningData = data.filter(r => r.voltageR > 200);

  let totalKwh = 0;
  let avgLoad = 0;
  let peakKw = 0;
  let avgPowerFactor = 0;
  let plcRuntimeHours = 0;

  if (runningData.length > 0) {
      // Total Energy (Sum of Voltages as per your logic)
      let totalVoltageSum = 0;
      runningData.forEach(r => {
          totalVoltageSum += (r.voltageR + r.voltageY + r.voltageB);
      });
      totalKwh = totalVoltageSum; 

      // Average Load
      let totalCurrentSum = 0;
      runningData.forEach(r => {
          const avgCurrent = (r.currentR + r.currentY + r.currentB) / 3;
          totalCurrentSum += avgCurrent;
      });
      avgLoad = totalCurrentSum / runningData.length;

      // Peak kW
      runningData.forEach(r => {
        if (r.activePower > peakKw) peakKw = r.activePower;
      });

      // Average Power Factor
      let totalPF = 0;
      runningData.forEach(r => {
          totalPF += (r.powerFactor || 0);
      });
      avgPowerFactor = totalPF / runningData.length;
      
      // Get latest runtime from PLC (last record)
      plcRuntimeHours = data[data.length - 1]?.runningHours || 0;
  }

  // Update UI (REMOVED total-hours)
  document.getElementById('total-kwh').textContent = totalKwh.toFixed(0);
  document.getElementById('avg-load').textContent = avgLoad.toFixed(1);
  document.getElementById('peak-kw').textContent = peakKw.toFixed(1);
  document.getElementById('avg-pf').textContent = avgPowerFactor.toFixed(2);
  document.getElementById('plc-runtime').textContent = plcRuntimeHours.toFixed(1);

  // Update Sticky Values (REMOVED totalHours)
  updateStickyStats(totalKwh, avgLoad, peakKw, avgPowerFactor, plcRuntimeHours);

  // Update Charts
  updateSplitCharts(data); 
  updateCombinedChart(data);
  updateSmartAnalytics(data);
}

function updateSplitCharts(data) {
  if (data.length === 0) return;
  const labels = data.map(r => new Date(r.timestamp).toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' }));
  const commonOptions = { 
    responsive: true, 
    maintainAspectRatio: false, 
    scales: { 
      x: { ticks: { maxRotation: 45, minRotation: 45 }, grid: { display: false } }, 
      y: { beginAtZero: true } 
    } 
  };
  const lineOpts = { tension: 0.1, pointRadius: 2, borderWidth: 2, fill: false };

  // Voltage Chart
  if (voltageChart) voltageChart.destroy();
  voltageChart = new Chart(document.getElementById('voltageChart'), {
    type: 'line', 
    data: { 
      labels, 
      datasets: [
        { label: 'V-R', data: data.map(r => r.voltageR), borderColor: '#fa8231', ...lineOpts },
        { label: 'V-Y', data: data.map(r => r.voltageY), borderColor: '#f7b731', ...lineOpts },
        { label: 'V-B', data: data.map(r => r.voltageB), borderColor: '#0052cc', ...lineOpts }
      ]
    }, 
    options: commonOptions
  });

  // Current Chart
  if (currentChart) currentChart.destroy();
  currentChart = new Chart(document.getElementById('currentChart'), {
    type: 'line', 
    data: { 
      labels, 
      datasets: [
        { label: 'C-R', data: data.map(r => r.currentR), borderColor: '#eb3b5a', ...lineOpts },
        { label: 'C-Y', data: data.map(r => r.currentY), borderColor: '#a55eea', ...lineOpts },
        { label: 'C-B', data: data.map(r => r.currentB), borderColor: '#2bcbba', ...lineOpts }
      ]
    }, 
    options: commonOptions
  });

  // Power Chart
  if (powerChart) powerChart.destroy();
  powerChart = new Chart(document.getElementById('powerChart'), {
    type: 'line', 
    data: { 
      labels, 
      datasets: [
        { label: 'kW', data: data.map(r => r.activePower), borderColor: '#20bf6b', ...lineOpts, borderWidth: 3 }
      ]
    }, 
    options: commonOptions
  });

  // Frequency Chart
  if (freqChart) freqChart.destroy();
  freqChart = new Chart(document.getElementById('freqChart'), {
    type: 'line', 
    data: { 
      labels, 
      datasets: [
        { label: 'Freq (Hz)', data: data.map(r => r.frequency), borderColor: '#8854d0', ...lineOpts }
      ]
    }, 
    options: commonOptions
  });

  // ‚úÖ NEW: Power Factor Chart
  if (powerFactorChart) powerFactorChart.destroy();
  powerFactorChart = new Chart(document.getElementById('powerFactorChart'), {
    type: 'line', 
    data: { 
      labels, 
      datasets: [
        { label: 'Power Factor', data: data.map(r => r.powerFactor || 0), borderColor: '#fd79a8', ...lineOpts, borderWidth: 3 }
      ]
    }, 
    options: {
      ...commonOptions,
      scales: {
        x: { ticks: { maxRotation: 45, minRotation: 45 }, grid: { display: false } },
        y: { beginAtZero: true, max: 1 }
      }
    }
  });

  // ‚úÖ NEW: Runtime Chart
  if (runtimeChart) runtimeChart.destroy();
  runtimeChart = new Chart(document.getElementById('runtimeChart'), {
    type: 'line', 
    data: { 
      labels, 
      datasets: [
        { label: 'Runtime (Hrs)', data: data.map(r => r.runningHours || 0), borderColor: '#00b894', ...lineOpts, borderWidth: 3 }
      ]
    }, 
    options: commonOptions
  });
}

function updateCombinedChart(data) {
  if (data.length === 0) return;
  const labels = data.map(r => new Date(r.timestamp).toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' }));
  if (combinedChart) combinedChart.destroy();
  const lineOpts = { tension: 0.1, pointRadius: 1, borderWidth: 2, fill: false };

  combinedChart = new Chart(document.getElementById('combinedChart'), {
    type: 'line',
    data: {
        labels,
        datasets: [
            // ‚úÖ VOLTAGE - SEPARATE R, Y, B LINES
            { 
                label: 'Voltage-R', 
                data: data.map(r => r.voltageR), 
                borderColor: '#fa8231', 
                backgroundColor: 'rgba(250, 130, 49, 0.1)',
                yAxisID: 'yV', 
                ...lineOpts 
            },
            { 
                label: 'Voltage-Y', 
                data: data.map(r => r.voltageY), 
                borderColor: '#f7b731', 
                backgroundColor: 'rgba(247, 183, 49, 0.1)',
                yAxisID: 'yV', 
                ...lineOpts 
            },
            { 
                label: 'Voltage-B', 
                data: data.map(r => r.voltageB), 
                borderColor: '#0052cc', 
                backgroundColor: 'rgba(0, 82, 204, 0.1)',
                yAxisID: 'yV', 
                ...lineOpts 
            },
            
            // ‚úÖ CURRENT - SEPARATE R, Y, B LINES
            { 
                label: 'Current-R', 
                data: data.map(r => r.currentR), 
                borderColor: '#eb3b5a', 
                backgroundColor: 'rgba(235, 59, 90, 0.1)',
                yAxisID: 'yA', 
                ...lineOpts 
            },
            { 
                label: 'Current-Y', 
                data: data.map(r => r.currentY), 
                borderColor: '#a55eea', 
                backgroundColor: 'rgba(165, 94, 234, 0.1)',
                yAxisID: 'yA', 
                ...lineOpts 
            },
            { 
                label: 'Current-B', 
                data: data.map(r => r.currentB), 
                borderColor: '#2bcbba', 
                backgroundColor: 'rgba(43, 203, 186, 0.1)',
                yAxisID: 'yA', 
                ...lineOpts 
            },
            
            // ‚úÖ POWER
            { 
                label: 'Power (kW)', 
                data: data.map(r => r.activePower), 
                borderColor: '#20bf6b', 
                backgroundColor: 'rgba(32, 191, 107, 0.1)',
                yAxisID: 'yP', 
                ...lineOpts, 
                borderWidth: 3 
            },
            
            // ‚úÖ FREQUENCY
            { 
                label: 'Freq (Hz)', 
                data: data.map(r => r.frequency), 
                borderColor: '#8854d0', 
                backgroundColor: 'rgba(136, 84, 208, 0.1)',
                yAxisID: 'yF', 
                ...lineOpts 
            },
            
            // ‚úÖ POWER FACTOR (UPDATED COLOR)
            { 
                label: 'Power Factor', 
                data: data.map(r => r.powerFactor || 0), 
                borderColor: '#fd79a8', 
                backgroundColor: 'rgba(253, 121, 168, 0.1)',
                yAxisID: 'yPF', 
                ...lineOpts 
            },
            
            // ‚úÖ NEW: RUNTIME HOURS
            { 
                label: 'Runtime (Hrs)', 
                data: data.map(r => r.runningHours || 0), 
                borderColor: '#00b894', 
                backgroundColor: 'rgba(0, 184, 148, 0.1)',
                yAxisID: 'yRT', 
                ...lineOpts 
            }
        ]
    },
    options: {
        responsive: true, 
        maintainAspectRatio: false, 
        interaction: { mode: 'index', intersect: false },
        plugins: {
            legend: {
                display: true,
                position: 'top',
                labels: {
                    usePointStyle: true,
                    padding: 15,
                    font: { size: 11 }
                }
            },
            tooltip: {
                mode: 'index',
                intersect: false,
                callbacks: {
                    label: function(context) {
                        let label = context.dataset.label || '';
                        if (label) {
                            label += ': ';
                        }
                        if (context.parsed.y !== null) {
                            label += context.parsed.y.toFixed(2);
                        }
                        return label;
                    }
                }
            }
        },
        scales: {
            x: { 
                ticks: { maxRotation: 45, minRotation: 45 }, 
                grid: { display: false } 
            },
            yV: { 
                position: 'left', 
                title: { display: true, text: 'Voltage (V)', color: '#fa8231' },
                ticks: { color: '#fa8231' }
            },
            yA: { 
                position: 'right', 
                title: { display: true, text: 'Current (A)', color: '#eb3b5a' }, 
                grid: { drawOnChartArea: false },
                ticks: { color: '#eb3b5a' }
            },
            yP: { 
                position: 'right', 
                title: { display: true, text: 'Power (kW)', color: '#20bf6b' }, 
                grid: { drawOnChartArea: false }, 
                offset: true,
                ticks: { color: '#20bf6b' }
            },
            yF: { 
                position: 'left', 
                title: { display: true, text: 'Freq (Hz)', color: '#8854d0' }, 
                grid: { drawOnChartArea: false }, 
                offset: true,
                ticks: { color: '#8854d0' }
            },
            yPF: { 
                position: 'right', 
                title: { display: true, text: 'Power Factor', color: '#fd79a8' }, 
                min: 0, 
                max: 1, 
                grid: { drawOnChartArea: false }, 
                offset: true,
                ticks: { color: '#fd79a8' }
            },
            yRT: { 
                position: 'left', 
                title: { display: true, text: 'Runtime (Hrs)', color: '#00b894' }, 
                grid: { drawOnChartArea: false }, 
                offset: true,
                ticks: { color: '#00b894' }
            }
        }
    }
  });
}

// ============================================================
// ‚úÖ SMART ANALYTICS LOGIC
// ============================================================

// 1. Helper: Calculate L/hr based on Amps
function calculateSmartRate(amps) {
    if (amps < 5) return 0; // Engine Off
    // Formula: Linear interpolation from 4.5L (Idle) to 18L (Full)
    let loadPct = amps / MAX_AMPS_125KVA;
    if (loadPct > 1) loadPct = 1;
    return 4.5 + ((18 - 4.5) * loadPct);
}

// 2. Main Function: Process History & Calculate Totals
function updateSmartAnalytics(data) {
    if (!data || data.length === 0) return;

    // Arrays for Graphs
    const labels = [];
    const costData = [];
    const fuelData = [];

    // Totals
    let totalFuel = 0;
    let totalMins = 0;
    let peakAmps = 0;

    // Iterate through history
    for (let i = 0; i < data.length; i++) {
        const point = data[i];
        
        // Use Average Current
        const amps = (point.currentR + point.currentY + point.currentB) / 3 || 0;
        
        if (amps > peakAmps) peakAmps = amps;

        // Create Label
        labels.push(new Date(point.timestamp).toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' }));

        // Calculate Instant Rates
        const fuelRate = calculateSmartRate(amps); // L/hr
        const costRate = fuelRate * PRICE_PER_LITER; // ‚Çπ/hr

        fuelData.push(fuelRate.toFixed(2));
        costData.push(Math.round(costRate));

        // --- INTEGRATION (Accumulate Totals) ---
        // We calculate the time difference from the previous point to determine volume
        if (i > 0) {
            const prevTime = new Date(data[i-1].timestamp);
            const currTime = new Date(point.timestamp);
            const diffMs = currTime - prevTime;
            const diffHours = diffMs / (1000 * 60 * 60); // Hours
            
            // Only integrate if gap is reasonable (< 15 mins) and DG is running
            if (diffHours < 0.25 && amps > 5) {
                totalFuel += (fuelRate * diffHours);
                totalMins += (diffMs / (1000 * 60));
            }
        }
    }

    // 3. Update UI Cards
    document.getElementById('calc-time').textContent = Math.round(totalMins);
    document.getElementById('calc-fuel').textContent = totalFuel.toFixed(1);
    document.getElementById('calc-cost').textContent = Math.round(totalFuel * PRICE_PER_LITER).toLocaleString();
    document.getElementById('calc-peak').textContent = Math.round(peakAmps);

    // 4. Render Graphs
    renderSmartCharts(labels, costData, fuelData);
}

// 3. Render the new Charts
function renderSmartCharts(labels, costData, fuelData) {
    const commonOpts = {
        responsive: true,
        maintainAspectRatio: false,
        elements: { point: { radius: 0 } }, // Clean line, no dots
        scales: { 
            x: { display: false }, // Hide X axis labels for clean look
            y: { beginAtZero: true } 
        },
        plugins: { legend: { display: false } }
    };

    // Cost Chart
    if (costGraphInstance) costGraphInstance.destroy();
    costGraphInstance = new Chart(document.getElementById('costGraph'), {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Cost (‚Çπ/hr)',
                data: costData,
                borderColor: '#d97706',
                backgroundColor: 'rgba(217, 119, 6, 0.1)',
                fill: true,
                tension: 0.4,
                borderWidth: 2
            }]
        },
        options: commonOpts
    });

    // Fuel Chart
    if (fuelGraphInstance) fuelGraphInstance.destroy();
    fuelGraphInstance = new Chart(document.getElementById('fuelGraph'), {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Fuel (L/hr)',
                data: fuelData,
                borderColor: '#00875a',
                backgroundColor: 'rgba(0, 135, 90, 0.1)',
                fill: true,
                tension: 0.4,
                borderWidth: 2
            }]
        },
        options: commonOpts
    });
}

// REPLACE your existing 'exportElectricalData' function with this:

async function exportElectricalData() {
    const startDate = document.getElementById('start-date').value;
    const endDate = document.getElementById('end-date').value;
    
    // 1. Notify User
    const btn = document.querySelector('.btn-success');
    const originalText = btn.textContent;
    btn.textContent = "‚è≥ Generating Report...";
    
    try {
        // 2. Fetch Raw Data
        const response = await fetch(`/api/electrical/${dgType}?startDate=${startDate}&endDate=${endDate}`);
        const result = await response.json();
        
        if (!result.data || result.data.length === 0) {
            alert("No data to export for this date range.");
            btn.textContent = originalText;
            return;
        }

        // 3. Create CSV Content with NEW Calculated Columns
        // Headers
        let csvContent = "Date,Time,Amps (Avg),kW,Fuel Rate (L/hr),Est. Cost (INR)\n";

        // Rows
        result.data.forEach(row => {
            const dateObj = new Date(row.timestamp);
            const date = dateObj.toLocaleDateString('en-IN');
            const time = dateObj.toLocaleTimeString('en-IN');
            
            // Get Amps
            const amps = (row.currentR + row.currentY + row.currentB) / 3 || 0;
            
            // --- SMART CALCULATION ---
            let fuelRate = 0;
            let cost = 0;
            
            if (amps > 5) {
                // Same formula as the dashboard
                const loadPct = amps / MAX_AMPS_125KVA;
                const factor = (loadPct > 1) ? 1 : loadPct;
                fuelRate = 4.5 + ((18 - 4.5) * factor);
                cost = fuelRate * PRICE_PER_LITER;
            }
            // -------------------------

            // Append Row
            csvContent += `${date},${time},${amps.toFixed(1)},${row.activePower.toFixed(1)},${fuelRate.toFixed(2)},${cost.toFixed(2)}\n`;
        });

        // 4. Trigger Download
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.setAttribute("href", url);
        link.setAttribute("download", `${dgType}_Report_${startDate}_to_${endDate}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

    } catch (err) {
        console.error("Export failed:", err);
        alert("Failed to export data.");
    } finally {
        btn.textContent = originalText;
    }
}

loadData();
</script>
</body>
</html>

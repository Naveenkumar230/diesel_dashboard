<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>DG Consumption Details</title>
<link rel="icon" type="image/png" href="/favicon.png">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
  :root {
    --primary: #0052cc; --success: #00875a; --warning: #ffab00; --danger: #de350b;
    --bg-primary: #ffffff; --bg-secondary: #f4f5f7; --bg-tertiary: #ffffff;
    --text-primary: #172b4d; --text-secondary: #42526e; --text-muted: #6b778c;
    --border: #dfe1e6;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { background: var(--bg-primary); font-family: 'Segoe UI', Tahoma, sans-serif; color: var(--text-primary); min-height: 100vh; padding: 15px; }
  .container { max-width: 1600px; margin: 0 auto; }
  .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 20px; background: var(--bg-secondary); border-radius: 12px; border: 1px solid var(--border); flex-wrap: wrap; gap: 15px; }
  .header-left h1 { font-size: 1.8rem; background: linear-gradient(90deg, #0052cc, #0065ff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 5px; }
  .header-left .subtitle { font-size: 0.9rem; color: var(--text-muted); }
  .header-right { display: flex; gap: 10px; flex-wrap: wrap; }
  .btn { padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; transition: all 0.3s; text-decoration: none; display: inline-block; font-size: 0.95rem; }
  .btn-primary { background: var(--primary); color: white; }
  .btn-primary:hover { background: #0041a3; transform: translateY(-2px); }
  .btn-success { background: var(--success); color: white; }
  .btn-success:hover { background: #006644; transform: translateY(-2px); }
  .btn-secondary { background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border); }
  .btn-secondary:hover { background: #dfe1e6; }
  .filters { background: var(--bg-secondary); border: 1px solid var(--border); padding: 20px; border-radius: 12px; margin-bottom: 20px; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
  .filter-group { display: flex; flex-direction: column; gap: 8px; }
  label { font-size: 0.9rem; color: var(--text-muted); font-weight: 600; }
  input, select { padding: 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--bg-tertiary); color: var(--text-primary); font-size: 0.95rem; }
  .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px; }
  .stat-card { background: var(--bg-tertiary); border: 1px solid var(--border); padding: 20px; border-radius: 12px; text-align: center; border-top: 4px solid var(--primary); }
  .stat-label { font-size: 0.85rem; color: var(--text-muted); margin-bottom: 10px; text-transform: uppercase; letter-spacing: 0.5px; }
  .stat-value { font-size: 2.2rem; font-weight: 800; margin-bottom: 5px; color: var(--text-primary); }
  .stat-unit { font-size: 0.85rem; color: var(--text-muted); }
  .live-indicator { display: inline-block; width: 8px; height: 8px; background: #00875a; border-radius: 50%; margin-left: 8px; animation: pulse 2s infinite; }
  @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
  
  #refill-details { 
    margin-top: 10px; 
    font-size: 0.75rem; 
    color: var(--text-muted); 
    text-align: left;
    max-height: 80px;
    overflow-y: auto;
    padding: 5px;
    background: rgba(0, 82, 204, 0.05);
    border-radius: 4px;
  }
  
  .chart-section { background: var(--bg-secondary); border: 1px solid var(--border); padding: 25px; border-radius: 12px; margin-bottom: 20px; }
  .chart-title { font-size: 1.3rem; font-weight: 700; margin-bottom: 20px; color: var(--text-primary); border-left: 4px solid var(--primary); padding-left: 15px; }
  .chart-container { position: relative; height: 400px; }
  .loading, .empty-state { text-align: center; padding: 60px; color: var(--text-muted); font-size: 1.2rem; }
  .empty-state { background: var(--bg-secondary); border-radius: 12px; }
  .empty-state-icon { font-size: 4rem; margin-bottom: 20px; opacity: 0.5; }

  @media (max-width: 768px) {
    .header { flex-direction: column; align-items: flex-start; }
    .header-right { width: 100%; flex-direction: column; }
    .btn { width: 100%; text-align: center; }
    .chart-container { height: 300px; }
  }
</style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="header-left">
        <h1 id="page-title">DG Consumption Details</h1>
        <div class="subtitle" id="date-range">Loading...</div>
      </div>
      <div class="header-right">
        <button class="btn btn-success" onclick="exportAllData()">üì• Download All Data</button>
        <a href="/" class="btn btn-secondary">‚Üê Back to Dashboard</a>
      </div>
    </div>

    <div class="filters">
      <div class="filter-group">
        <label>From Date</label>
        <input type="date" id="start-date" />
      </div>
      <div class="filter-group">
        <label>To Date</label>
        <input type="date" id="end-date" />
      </div>
      <div class="filter-group">
        <label>Quick Select</label>
        <select id="quick-select">
          <option value="today" selected>Today</option>
          <option value="yesterday">Yesterday</option>
          <option value="week">Last 7 Days</option>
          <option value="month">Last 30 Days</option>
          <option value="custom">Custom Range</option>
        </select>
      </div>
      <div class="filter-group" style="justify-content: flex-end;">
        <label>&nbsp;</label>
        <button class="btn btn-primary" onclick="loadData()">Apply Filter</button>
      </div>
    </div>

    <div class="stats-grid">
      <div class="stat-card"><div class="stat-label">Start Level</div><div class="stat-value" id="start-level">--</div><div class="stat-unit">Liters</div></div>
      <div class="stat-card"><div class="stat-label">End Level</div><div class="stat-value" id="end-level">--</div><div class="stat-unit">Liters</div></div>
      <div class="stat-card" style="border-top-color: var(--danger);"><div class="stat-label">Total Consumption</div><div class="stat-value" id="total-consumption" style="color: var(--danger);">--</div><div class="stat-unit">Liters</div></div>
      
      <div class="stat-card" id="refill-info-card" style="border-top-color: #0052cc; display: none;">
        <div class="stat-label">‚õΩ Total Refilled</div>
        <div class="stat-value" id="total-refilled" style="color: #0052cc;">--</div>
        <div class="stat-unit">Liters</div>
        <div id="refill-details"></div>
      </div>
      
      <div class="stat-card" style="border-top-color: var(--success);"><div class="stat-label">Total Running Hours</div><div class="stat-value" id="running-hours" style="color: var(--success);">--</div><div class="stat-unit">Hours</div></div>
      <div class="stat-card" style="border-top-color: var(--warning);"><div class="stat-label">Avg Consumption</div><div class="stat-value" id="avg-consumption" style="color: var(--warning);">--</div><div class="stat-unit">L/Hour</div></div>
      <div class="stat-card" id="refill-card" style="display: none;"><div class="stat-label">Refill Prediction</div><div class="stat-value" id="refill-prediction" style="color: var(--primary);">--</div><div class="stat-unit">Days until 50L</div></div>
    </div>

    <div class="chart-section">
      <div class="chart-title" id="consumption-chart-title">üìà Hourly Diesel Consumption<span id="live-badge-consumption"></span></div>
      <div class="chart-container">
        <canvas id="consumptionChart"></canvas>
      </div>
    </div>

    <div class="chart-section">
      <div class="chart-title" id="level-chart-title">üìâ Diesel Level Over Time<span id="live-badge-level"></span></div>
      <div class="chart-container">
        <canvas id="levelChart"></canvas>
      </div>
    </div>

    <div id="loading" class="loading" style="display:none;">‚è≥ Loading data...</div>
    <div id="empty-state" class="empty-state" style="display:none;">
      <div class="empty-state-icon">üì≠</div>
      <h2>No Data Available</h2>
      <p>No consumption data found for the selected date range.</p>
    </div>
  </div>

  <script>
// ========================================
// FIXED CONSUMPTION.HTML with SMOOTHING + LIVE DATA
// ========================================

let consumptionChart, levelChart;
let currentData = [];
let autoRefreshInterval = null;
const CRITICAL_LEVEL = 50;
const REFILL_THRESHOLD = 20; // Minimum increase to consider as refill

const urlParams = new URLSearchParams(window.location.search);
const dgType = urlParams.get('dg') || 'dg1';

const titles = { 
  'dg1': 'DG-1 Consumption', 
  'dg2': 'DG-2 Consumption', 
  'dg3': 'DG-3 Consumption', 
  'total': 'Total Consumption' 
};
document.getElementById('page-title').textContent = titles[dgType] || titles['dg1'];

if (dgType === 'total') document.getElementById('refill-card').style.display = 'block';

// ========================================
// DATE RANGE SETUP
// ========================================
function setDateRange(range) {
    const end = new Date();
    const start = new Date();
    
    if (range === 'yesterday') {
        start.setDate(start.getDate() - 1);
        end.setDate(end.getDate() - 1);
    } else if (range === 'week') {
        start.setDate(start.getDate() - 6);
    } else if (range === 'month') {
        start.setDate(start.getDate() - 29);
    }
    
    document.getElementById('start-date').value = start.toISOString().split('T')[0];
    document.getElementById('end-date').value = end.toISOString().split('T')[0];
}

setDateRange('today'); 
document.getElementById('quick-select').value = 'today';

document.getElementById('quick-select').addEventListener('change', function() {
  if (this.value !== 'custom') setDateRange(this.value);
});

// ========================================
// AUTO-REFRESH SETUP
// ========================================
function setupAutoRefresh() {
  const startDate = document.getElementById('start-date').value;
  const endDate = document.getElementById('end-date').value;
  const today = new Date().toISOString().split('T')[0];
  
  if (autoRefreshInterval) {
    clearInterval(autoRefreshInterval);
    autoRefreshInterval = null;
  }
  
  if (startDate === today && endDate === today) {
    console.log('üîÑ Auto-refresh enabled for live data');
    autoRefreshInterval = setInterval(() => {
      loadData(true);
    }, 30000); // 30 seconds
  }
}

// ========================================
// ‚úÖ NEW: 3-POINT MOVING AVERAGE SMOOTHING
// ========================================
function smoothLevelData(data) {
  if (data.length < 3) return data;
  
  const smoothed = [...data];
  
  for (let i = 1; i < data.length - 1; i++) {
    const prev = data[i - 1].level;
    const curr = data[i].level;
    const next = data[i + 1].level;
    
    // Apply moving average
    smoothed[i].smoothedLevel = (prev + curr + next) / 3;
  }
  
  // Handle edges
  smoothed[0].smoothedLevel = data[0].level;
  smoothed[data.length - 1].smoothedLevel = data[data.length - 1].level;
  
  return smoothed;
}

// ========================================
// ‚úÖ FIXED: CONSUMPTION CALCULATION
// ========================================
function calculateConsumptionWithRefills(data, dgType) {
  let totalConsumption = 0;
  let totalRefilled = 0;
  let refillEvents = [];
  let previousLevel = null;

  // Smooth the data first to remove noise
  const processedData = data.map(record => {
    let level;
    if (dgType === 'total') {
      level = record.total?.level || 0;
    } else {
      level = record.level || 0;
    }
    return { ...record, level };
  });

  // Apply smoothing
  const smoothedData = smoothLevelData(processedData);

  smoothedData.forEach((record, index) => {
    const currentLevel = record.smoothedLevel || record.level;

    if (previousLevel !== null) {
      const levelChange = currentLevel - previousLevel;
      
      if (levelChange < -0.5) {
        // ‚úÖ CONSUMPTION: Level decreased by more than 0.5L (ignore tiny fluctuations)
        totalConsumption += Math.abs(levelChange);
      } else if (levelChange >= REFILL_THRESHOLD) {
        // ‚úÖ REFILL DETECTED
        totalRefilled += levelChange;
        refillEvents.push({
          timestamp: record.timestamp,
          amount: levelChange,
          beforeLevel: previousLevel,
          afterLevel: currentLevel,
          time: new Date(record.timestamp).toLocaleTimeString('en-IN', {
            hour: '2-digit',
            minute: '2-digit'
          })
        });
      }
    }

    previousLevel = currentLevel;
  });

  return { totalConsumption, totalRefilled, refillEvents };
}

// ========================================
// ‚úÖ MAIN DATA LOADING
// ========================================
async function loadData(silent = false) {
  const startDate = document.getElementById('start-date').value;
  const endDate = document.getElementById('end-date').value;
  if (!startDate || !endDate) { 
    alert('Please select a start and end date'); 
    return; 
  }
  
  if (!silent) {
    document.getElementById('loading').style.display = 'block';
    document.getElementById('empty-state').style.display = 'none';
  }

  try {
    const query = `startDate=${startDate}&endDate=${endDate}`;
    const url = (dgType === 'total') 
      ? `/api/consumption?${query}` 
      : `/api/consumption?dg=${dgType}&${query}`;
    
    const response = await fetch(url);
    const result = await response.json();

    // ‚úÖ APPEND LIVE DATA if viewing today
    const today = new Date().toISOString().split('T')[0];
    let dataToProcess = result.success ? result.data : [];
    
    if (startDate === today && endDate === today) {
      try {
        const liveResponse = await fetch('/api/data');
        const liveData = await liveResponse.json();
        
        if (liveData) {
          let currentLevel;
          if (dgType === 'total') {
            currentLevel = liveData.total || 0;
          } else {
            currentLevel = liveData[dgType] || 0;
          }
          
          // Add live data point
          const now = new Date();
          const livePoint = {
            timestamp: now.toISOString(),
            date: today,
            hour: now.getHours(),
            minute: now.getMinutes(),
            level: currentLevel,
            isRunning: false,
            isLive: true
          };
          
          if (dgType === 'total') {
            livePoint.total = { level: currentLevel };
          }
          
          dataToProcess.push(livePoint);
          
          // Show live indicator
          document.getElementById('live-badge-consumption').innerHTML = '<span class="live-indicator"></span>';
          document.getElementById('live-badge-level').innerHTML = '<span class="live-indicator"></span>';
        }
      } catch (liveErr) {
        console.log('Could not fetch live data:', liveErr);
      }
    }

    if (dataToProcess.length > 0) {
      currentData = dataToProcess;
      processData(dataToProcess, startDate, endDate);
      document.getElementById('empty-state').style.display = 'none';
      setupAutoRefresh();
    } else {
      showEmptyState();
    }
  } catch (err) {
    console.error('Error loading data:', err);
    showEmptyState();
  } finally {
    if (!silent) {
      document.getElementById('loading').style.display = 'none';
    }
  }
}

function showEmptyState() {
  document.getElementById('empty-state').innerHTML = `
    <div class="empty-state-icon">üì≠</div>
    <h2>No Data Available</h2>
    <p>No consumption data found for the selected date range.</p>
  `;
  document.getElementById('empty-state').style.display = 'block';
  if (consumptionChart) consumptionChart.destroy();
  if (levelChart) levelChart.destroy();
  clearStats();
}

function clearStats() {
  document.getElementById('start-level').textContent = '--';
  document.getElementById('end-level').textContent = '--';
  document.getElementById('total-consumption').textContent = '--';
  document.getElementById('running-hours').textContent = '--';
  document.getElementById('avg-consumption').textContent = '--';
}

// ========================================
// ‚úÖ PROCESS DATA
// ========================================
function processData(data, startDate, endDate) {
  const isMultiDay = (new Date(endDate) - new Date(startDate)) > 0;

  const startStr = new Date(startDate + 'T00:00:00').toLocaleDateString('en-IN', { 
    day: 'numeric', 
    month: 'long' 
  });
  const endStr = new Date(endDate + 'T00:00:00').toLocaleDateString('en-IN', { 
    day: 'numeric', 
    month: 'long' 
  });
  document.getElementById('date-range').textContent = (startStr === endStr) 
    ? startStr 
    : `From ${startStr} to ${endStr}`;

  let startLevel, endLevel, runningHours;

  // ‚úÖ FIXED: Use ACTUAL first and last readings
  if (dgType === 'total') {
    startLevel = data[0]?.total?.level || 0;
    endLevel = data[data.length - 1]?.total?.level || 0;
    runningHours = data.filter(r => 
      (r.dg1?.isRunning || r.dg2?.isRunning || r.dg3?.isRunning)
    ).length * 0.5;
  } else {
    startLevel = data[0]?.level || 0;
    endLevel = data[data.length - 1]?.level || 0;
    runningHours = data.filter(r => r.isRunning).length * 0.5;
  }

  // ‚úÖ Calculate consumption with smoothing
  const { totalConsumption, totalRefilled, refillEvents } = calculateConsumptionWithRefills(data, dgType);

  // Update stats
  document.getElementById('start-level').textContent = startLevel.toFixed(0);
  document.getElementById('end-level').textContent = endLevel.toFixed(0);
  document.getElementById('total-consumption').textContent = totalConsumption.toFixed(1);
  document.getElementById('running-hours').textContent = runningHours.toFixed(1);
  document.getElementById('avg-consumption').textContent = 
    (runningHours > 0 ? (totalConsumption / runningHours) : 0).toFixed(2);

  // Refill prediction
  if (dgType === 'total') {
    const avgConsumptionRate = runningHours > 0 ? (totalConsumption / runningHours) : 0;
    let daysRemaining = '--';
    if (avgConsumptionRate > 0) {
      const usableDiesel = endLevel - CRITICAL_LEVEL;
      daysRemaining = (usableDiesel > 0) 
        ? ((usableDiesel / avgConsumptionRate) / 24).toFixed(1) 
        : '0.0';
    }
    document.getElementById('refill-prediction').textContent = daysRemaining;
  }

  displayRefillInfo(totalRefilled, refillEvents);
  updateCharts(data, startDate, endDate, refillEvents);
}

// ========================================
// DISPLAY REFILL INFO
// ========================================
function displayRefillInfo(totalRefilled, refillEvents) {
  const refillCard = document.getElementById('refill-info-card');
  const totalRefilledEl = document.getElementById('total-refilled');
  const refillDetailsEl = document.getElementById('refill-details');
  
  if (!refillCard || !totalRefilledEl || !refillDetailsEl) return;

  if (totalRefilled > 0 && refillEvents.length > 0) {
    refillCard.style.display = 'block';
    totalRefilledEl.textContent = totalRefilled.toFixed(0);
    
    let detailsHTML = `<strong>üìã ${refillEvents.length} refill event(s):</strong><br><br>`;
    refillEvents.forEach(event => {
      detailsHTML += `‚õΩ <strong>${event.time}</strong>: +${event.amount.toFixed(0)}L<br>`;
      detailsHTML += `&nbsp;&nbsp;&nbsp;Before: ${event.beforeLevel.toFixed(0)}L ‚Üí After: ${event.afterLevel.toFixed(0)}L<br><br>`;
    });
    refillDetailsEl.innerHTML = detailsHTML;
  } else {
    refillCard.style.display = 'none';
    totalRefilledEl.textContent = '--';
    refillDetailsEl.innerHTML = '';
  }
}

// ========================================
// ‚úÖ IMPROVED CHARTS WITH HOURLY AGGREGATION
// ========================================
function updateCharts(data, startDate, endDate, refillEvents) {
  const isMultiDay = (new Date(endDate) - new Date(startDate)) > 0;

  let labels = [];
  let consumptionData = [];
  let levelData = [];
  let refillMarkers = [];

  if (!isMultiDay) {
    // ‚úÖ SINGLE DAY: HOURLY AGGREGATION
    document.getElementById('consumption-chart-title').textContent = 
      'üìà Hourly Diesel Consumption';
    document.getElementById('level-chart-title').textContent = 
      'üìâ Diesel Level Over Time';
    
    // Smooth the level data first
    const processedData = data.map(record => {
      let level;
      if (dgType === 'total') {
        level = record.total?.level || 0;
      } else {
        level = record.level || 0;
      }
      return { ...record, level };
    });
    
    const smoothedData = smoothLevelData(processedData);
    
    // Group into hourly buckets
    const hourlyBuckets = {};
    
    smoothedData.forEach((record, index) => {
      const hour = record.hour;
      const currentLevel = record.smoothedLevel || record.level;
      
      if (!hourlyBuckets[hour]) {
        hourlyBuckets[hour] = {
          records: [],
          consumption: 0,
          levels: []
        };
      }
      
      hourlyBuckets[hour].records.push(record);
      hourlyBuckets[hour].levels.push(currentLevel);
    });
    
    // Calculate consumption per hour
    const hours = Object.keys(hourlyBuckets).sort((a, b) => parseInt(a) - parseInt(b));
    let previousHourEndLevel = null;
    
    hours.forEach(hour => {
      const bucket = hourlyBuckets[hour];
      const hourInt = parseInt(hour);
      const hourStr = hourInt > 12 ? hourInt - 12 : (hourInt === 0 ? 12 : hourInt);
      const ampm = hourInt >= 12 ? 'PM' : 'AM';
      
      // Get start and end level for this hour
      const hourStartLevel = bucket.levels[0];
      const hourEndLevel = bucket.levels[bucket.levels.length - 1];
      
      // Calculate consumption for this hour
      let hourConsumption = 0;
      if (previousHourEndLevel !== null) {
        const levelChange = hourStartLevel - previousHourEndLevel;
        if (levelChange < 0) {
          hourConsumption = Math.abs(levelChange);
        }
      }
      
      // Add consumption within the hour
      for (let i = 1; i < bucket.levels.length; i++) {
        const levelChange = bucket.levels[i] - bucket.levels[i - 1];
        if (levelChange < -0.5) {
          hourConsumption += Math.abs(levelChange);
        } else if (levelChange >= REFILL_THRESHOLD) {
          // Mark refill
          refillMarkers.push({
            index: labels.length,
            label: `${hourStr}:00 ${ampm}`,
            amount: levelChange
          });
        }
      }
      
      labels.push(`${hourStr}:00 ${ampm}`);
      consumptionData.push(hourConsumption);
      levelData.push(hourEndLevel);
      
      previousHourEndLevel = hourEndLevel;
    });

  } else {
    // MULTI-DAY MODE
    document.getElementById('consumption-chart-title').textContent = 'üìà Daily Consumption Trend';
    document.getElementById('level-chart-title').textContent = 'üìâ Daily End Level';
    
    const dateGroups = {};
    
    data.forEach(record => {
      const dateKey = record.date;
      if (!dateGroups[dateKey]) dateGroups[dateKey] = [];
      dateGroups[dateKey].push(record);
    });

    const sortedDates = Object.keys(dateGroups).sort();
    
    sortedDates.forEach(dateKey => {
      const dayRecords = dateGroups[dateKey];
      dayRecords.sort((a, b) => (a.hour * 60 + a.minute) - (b.hour * 60 + b.minute));

      if (dayRecords.length === 0) return;

      const getLevel = (r) => dgType === 'total' ? (r.total?.level || 0) : (r.level || 0);
      
      // Smooth daily data
      const dailyProcessed = dayRecords.map(r => ({ ...r, level: getLevel(r) }));
      const dailySmoothed = smoothLevelData(dailyProcessed);
      
      let dailyConsumption = 0;
      let prevLevel = null;

      dailySmoothed.forEach(r => {
        const currLevel = r.smoothedLevel || r.level;
        if (prevLevel !== null && currLevel < prevLevel) {
          dailyConsumption += (prevLevel - currLevel);
        }
        prevLevel = currLevel;
      });
      
      const dateLabel = new Date(dateKey).toLocaleDateString('en-IN', { 
        day: '2-digit', 
        month: 'short' 
      });
      const lastLevel = dailySmoothed[dailySmoothed.length - 1].smoothedLevel || 
                        dailySmoothed[dailySmoothed.length - 1].level;
      
      labels.push(dateLabel);
      consumptionData.push(dailyConsumption);
      levelData.push(lastLevel);
    });
  }

  // Render Consumption Chart
  if (consumptionChart) consumptionChart.destroy();
  consumptionChart = new Chart(document.getElementById('consumptionChart'), {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        label: isMultiDay ? 'Daily Consumption (L)' : 'Hourly Consumption (L)',
        data: consumptionData,
        backgroundColor: 'rgba(222, 53, 11, 0.8)',
        borderColor: 'rgba(222, 53, 11, 1)',
        borderWidth: 1,
        borderRadius: 4
      }]
    },
    options: {
      responsive: true, 
      maintainAspectRatio: false,
      plugins: {
        legend: { display: true },
        tooltip: {
          callbacks: {
            afterLabel: function(context) {
              const refill = refillMarkers.find(m => m.index === context.dataIndex);
              if (refill) {
                return `‚õΩ Refilled: +${refill.amount.toFixed(0)}L`;
              }
              return '';
            }
          }
        }
      },
      scales: { 
        y: { 
          beginAtZero: true,
          title: {
            display: true,
            text: 'Consumption (Liters)'
          }
        }, 
        x: { 
          ticks: { maxRotation: 45, minRotation: 45 },
          title: {
            display: true,
            text: isMultiDay ? 'Date' : 'Time'
          }
        } 
      }
    }
  });

  // Render Level Chart with refill markers
  if (levelChart) levelChart.destroy();
  levelChart = new Chart(document.getElementById('levelChart'), {
    type: 'line',
    data: { 
      labels: labels, 
      datasets: [
        {
          label: (dgType === 'total' ? 'Total' : dgType.toUpperCase()) + ' Level (L)',
          data: levelData,
          borderColor: 'rgba(0, 135, 90, 1)',
          backgroundColor: 'rgba(0, 135, 90, 0.1)',
          borderWidth: 3, 
          fill: true, 
          tension: 0.4, 
          pointBackgroundColor: levelData.map((val, idx) => {
            return refillMarkers.some(m => m.index === idx) 
              ? '#0052cc' 
              : 'rgba(0, 135, 90, 1)';
          }),
          pointRadius: levelData.map((val, idx) => {
            return refillMarkers.some(m => m.index === idx) ? 8 : 4;
          }),
          pointBorderWidth: 2,
          pointBorderColor: '#ffffff'
        }
      ]
    },
    options: {
      responsive: true, 
      maintainAspectRatio: false,
      plugins: { 
        legend: { display: true },
        tooltip: {
          callbacks: {
            label: function(context) {
              return `Level: ${context.parsed.y.toFixed(1)}L`;
            },
            afterLabel: function(context) {
              const refill = refillMarkers.find(m => m.index === context.dataIndex);
              if (refill) {
                return `‚õΩ Refilled: +${refill.amount.toFixed(0)}L`;
              }
              return '';
            }
          }
        }
      },
      scales: { 
        y: { 
          beginAtZero: false,
          title: {
            display: true,
            text: 'Diesel Level (Liters)'
          }
        }, 
        x: { 
          ticks: { maxRotation: 45, minRotation: 45 },
          title: {
            display: true,
            text: isMultiDay ? 'Date' : 'Time'
          }
        } 
      }
    }
  });
}

// ========================================
// EXPORT FUNCTION
// ========================================
function exportAllData() {
  const startDate = document.getElementById('start-date').value;
  const endDate = document.getElementById('end-date').value;
  if (!startDate || !endDate) { 
    alert('Please select a date range'); 
    return; 
  }
  window.location.href = `/api/export/all?startDate=${startDate}&endDate=${endDate}`;
}

// ========================================
// INITIAL LOAD
// ========================================
loadData();

// Cleanup on page unload
window.addEventListener('beforeunload', () => {
  if (autoRefreshInterval) {
    clearInterval(autoRefreshInterval);
  }
});
  </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>DG Consumption Details</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
  :root {
    /* Blue-and-White Theme */
    --primary: #0052cc;  /* Strong blue */
    --success: #00875a;  /* Green */
    --warning: #ffab00;  /* Yellow */
    --danger: #de350b;   /* Red */
    --bg-primary: #ffffff;      /* White background */
    --bg-secondary: #f4f5f7;  /* Light grey background for cards */
    --bg-tertiary: #ffffff;   /* Card content background */
    --text-primary: #172b4d;  /* Dark blue/black text */
    --text-secondary: #42526e; /* Secondary text */
    --text-muted: #6b778c;   /* Muted text */
    --border: #dfe1e6;
  }
  
  * { box-sizing: border-box; margin: 0; padding: 0; }
  
  body {
    background: var(--bg-primary);
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    color: var(--text-primary);
    min-height: 100vh;
    padding: 15px;
  }
  
  .container { max-width: 1600px; margin: 0 auto; }
  
  .header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding: 20px;
    background: var(--bg-secondary);
    border-radius: 12px;
    border: 1px solid var(--border);
    flex-wrap: wrap;
    gap: 15px;
  }
  
  .header-left h1 {
    font-size: 1.8rem;
    background: linear-gradient(90deg, #0052cc, #0065ff);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    margin-bottom: 5px;
  }
  
  .header-left .subtitle {
    font-size: 0.9rem;
    color: var(--text-muted);
  }
  
  .header-right {
    display: flex;
    gap: 10px;
  }
  
  .btn {
    padding: 10px 20px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s;
    text-decoration: none;
    display: inline-block;
    font-size: 0.95rem;
  }
  
  .btn-primary {
    background: var(--primary);
    color: white;
  }
  
  .btn-primary:hover {
    background: #0041a3; /* Darker blue */
    transform: translateY(-2px);
  }
  
  .btn-success {
    background: var(--success);
    color: white;
  }
  
  .btn-success:hover {
    background: #006644; /* Darker green */
    transform: translateY(-2px);
  }
  
  .btn-secondary {
    background: var(--bg-tertiary);
    color: var(--text-primary);
    border: 1px solid var(--border);
  }
  
  .btn-secondary:hover {
    background: #dfe1e6; /* Darker grey */
  }
  
  /* Updated Filters Layout for Range Inputs */
  .filters {
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    padding: 20px;
    border-radius: 12px;
    margin-bottom: 20px;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 15px;
    align-items: end; /* Align buttons with inputs */
  }
  
  .filter-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  
  label {
    font-size: 0.9rem;
    color: var(--text-muted);
    font-weight: 600;
  }
  
  input, select {
    padding: 10px;
    border-radius: 6px;
    border: 1px solid var(--border);
    background: var(--bg-tertiary);
    color: var(--text-primary);
    font-size: 0.95rem;
    width: 100%;
  }
  
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-bottom: 25px;
  }
  
  .stat-card {
    background: var(--bg-tertiary);
    border: 1px solid var(--border);
    padding: 20px;
    border-radius: 12px;
    text-align: center;
    border-top: 4px solid var(--primary);
  }
  
  .stat-label {
    font-size: 0.85rem;
    color: var(--text-muted);
    margin-bottom: 10px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  .stat-value {
    font-size: 2.2rem;
    font-weight: 800;
    margin-bottom: 5px;
    color: var(--text-primary);
  }
  
  .stat-unit {
    font-size: 0.85rem;
    color: var(--text-muted);
  }
  
  .chart-section {
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    padding: 25px;
    border-radius: 12px;
    margin-bottom: 20px;
  }
  
  .chart-title {
    font-size: 1.3rem;
    font-weight: 700;
    margin-bottom: 20px;
    color: var(--text-primary);
    border-left: 4px solid var(--primary);
    padding-left: 15px;
  }
  
  .chart-container {
    position: relative;
    height: 400px;
  }
  
  .running-hours-section {
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    padding: 25px;
    border-radius: 12px;
    margin-bottom: 20px;
  }
  
  .timeline {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-top: 20px;
  }
  
  .timeline-item {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 15px;
    background: var(--bg-tertiary);
    border: 1px solid var(--border);
    border-radius: 8px;
    border-left: 4px solid var(--success);
  }
  
  .timeline-item.stopped {
    border-left-color: var(--danger);
  }
  
  .timeline-time {
    font-weight: 700;
    min-width: 120px;
    font-size: 0.95rem;
    color: var(--text-primary);
  }
  
  .timeline-status {
    padding: 5px 12px;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: 700;
    text-transform: uppercase;
  }
  
  .timeline-status.running {
    background: var(--success);
    color: white;
  }
  
  .timeline-status.stopped {
    background: var(--danger);
    color: white;
  }
  
  .timeline-consumption {
    margin-left: auto;
    font-weight: 700;
    color: var(--danger);
  }
  
  .loading {
    text-align: center;
    padding: 60px;
    color: var(--text-muted);
    font-size: 1.2rem;
  }
  
  .empty-state {
    text-align: center;
    padding: 60px;
    color: var(--text-muted);
    background: var(--bg-secondary);
    border-radius: 12px;
  }
  
  .empty-state-icon {
    font-size: 4rem;
    margin-bottom: 20px;
    opacity: 0.5;
  }

  @media (max-width: 768px) {
    .header {
      flex-direction: column;
      align-items: flex-start;
    }
    
    .header-right {
      width: 100%;
      flex-direction: column;
    }
    
    .btn {
      width: 100%;
      text-align: center;
    }
    
    .chart-container {
      height: 300px;
    }
    
    .timeline-item {
      flex-direction: column;
      align-items: flex-start;
    }
    
    .timeline-consumption {
      margin-left: 0;
    }
  }
</style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="header-left">
        <h1 id="page-title">DG Consumption Details</h1>
        <div class="subtitle" id="date-range">Loading...</div>
      </div>
      <div class="header-right">
        <button class="btn btn-success" onclick="exportToExcel()">üì• Download Excel</button>
        <a href="/" class="btn btn-secondary">‚Üê Back to Dashboard</a>
      </div>
    </div>

    <div class="filters">
      <div class="filter-group">
        <label>From Date</label>
        <input type="date" id="start-date" />
      </div>
      <div class="filter-group">
        <label>To Date</label>
        <input type="date" id="end-date" />
      </div>
      <div class="filter-group">
        <label>Quick Select</label>
        <select id="quick-select">
          <option value="today">Today</option>
          <option value="yesterday">Yesterday</option>
          <option value="week">Last 7 Days</option>
          <option value="month">Last 30 Days</option>
          <option value="custom">Custom Range</option>
        </select>
      </div>
      <div class="filter-group" style="justify-content: flex-end;">
        <label>&nbsp;</label>
        <button class="btn btn-primary" onclick="loadData()">Apply Filter</button>
      </div>
    </div>

    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">Start Level</div>
        <div class="stat-value" id="start-level">--</div>
        <div class="stat-unit">Liters</div>
      </div>
      
      <div class="stat-card">
        <div class="stat-label">End Level (Current)</div>
        <div class="stat-value" id="end-level">--</div>
        <div class="stat-unit">Liters</div>
      </div>
      
      <div class="stat-card" style="border-top-color: var(--danger);">
        <div class="stat-label">Total Consumption</div>
        <div class="stat-value" id="total-consumption" style="color: var(--danger);">--</div>
        <div class="stat-unit">Liters</div>
      </div>
      
      <div class="stat-card" style="border-top-color: var(--success);">
        <div class="stat-label">Running Hours</div>
        <div class="stat-value" id="running-hours" style="color: var(--success);">--</div>
        <div class="stat-unit">Hours</div>
      </div>
      
      <div class="stat-card" style="border-top-color: var(--warning);">
        <div class="stat-label">Avg Consumption</div>
        <div class="stat-value" id="avg-consumption" style="color: var(--warning);">--</div>
        <div class="stat-unit">L/Hour</div>
      </div>

      <div class="stat-card" id="refill-card" style="border-top-color: var(--primary); display: none;">
        <div class="stat-label">Refill Prediction</div>
        <div class="stat-value" id="refill-prediction" style="color: var(--primary);">--</div>
        <div class="stat-unit">Days until 50L</div>
      </div>
    </div>

    <div class="chart-section">
      <div class="chart-title">üìà Diesel Consumption</div>
      <div class="chart-container">
        <canvas id="consumptionChart"></canvas>
      </div>
    </div>

    <div class="chart-section">
      <div class="chart-title" id="level-chart-title">üìâ Diesel Level Over Time</div>
      <div class="chart-container">
        <canvas id="levelChart"></canvas>
      </div>
    </div>

    <div class="running-hours-section">
      <div class="chart-title">‚è±Ô∏è Running Timeline (Every 30 Minutes)</div>
      <div id="timeline-container">
        </div>
    </div>

    <div id="loading" class="loading" style="display:none;">
      ‚è≥ Loading data...
    </div>

    <div id="empty-state" class="empty-state" style="display:none;">
      <div class="empty-state-icon">üì≠</div>
      <h2>No Data Available</h2>
      <p>No consumption data found for the selected date range.</p>
      <p style="margin-top:10px; color: var(--text-muted); font-size: 0.9rem;">
        Data is recorded every 30 minutes from 7:00 AM to 8:00 PM.
      </p>
    </div>
  </div>

  <script>
    let consumptionChart, levelChart;
    let currentData = [];
    let dgType = 'dg1';
    const CRITICAL_LEVEL = 50; // Alert threshold

    // Get DG type from URL
    const urlParams = new URLSearchParams(window.location.search);
    dgType = urlParams.get('dg') || 'dg1';

    // Set page title
    const titles = {
      'dg1': 'DG-1 Consumption Details',
      'dg2': 'DG-2 Consumption Details',
      'dg3': 'DG-3 Consumption Details',
      'total': 'Total Diesel Consumption Details'
    };
    document.getElementById('page-title').textContent = titles[dgType] || titles['dg1'];

    // Update level chart title for 'total'
    if (dgType === 'total') {
      document.getElementById('level-chart-title').textContent = 'üìâ Diesel Level Comparison';
      document.getElementById('refill-card').style.display = 'block';
    }

    // Initialize date range to today
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('start-date').value = today;
    document.getElementById('end-date').value = today;

    // Quick select handler
    document.getElementById('quick-select').addEventListener('change', function() {
      const value = this.value;
      const startDateInput = document.getElementById('start-date');
      const endDateInput = document.getElementById('end-date');
      
      const endDate = new Date();
      let startDate = new Date();

      switch(value) {
        case 'today':
          startDate = new Date();
          break;
        case 'yesterday':
          startDate.setDate(startDate.getDate() - 1);
          endDate.setDate(endDate.getDate() - 1);
          break;
        case 'week':
          startDate.setDate(startDate.getDate() - 6); // 7 days range
          break;
        case 'month':
          startDate.setDate(startDate.getDate() - 29); // 30 days range
          break;
        case 'custom':
          // Do nothing, let user pick
          return;
      }

      startDateInput.value = startDate.toISOString().split('T')[0];
      endDateInput.value = endDate.toISOString().split('T')[0];
    });

    async function loadData() {
      const startDate = document.getElementById('start-date').value;
      const endDate = document.getElementById('end-date').value;
      
      if (!startDate || !endDate) {
        alert('Please select a start and end date');
        return;
      }

      if (new Date(endDate) < new Date(startDate)) {
        alert('End date cannot be before start date');
        return;
      }

      document.getElementById('loading').style.display = 'block';
      document.getElementById('empty-state').style.display = 'none';

      try {
        let url;
        // Construct Query
        const query = `startDate=${startDate}&endDate=${endDate}`;
        
        if (dgType === 'total') {
          url = `/api/consumption?${query}`;
        } else {
          url = `/api/consumption?dg=${dgType}&${query}`;
        }

        const response = await fetch(url);
        const result = await response.json();

        if (result.success && result.data.length > 0) {
          currentData = result.data;
          processData(result.data, startDate, endDate);
          document.getElementById('empty-state').style.display = 'none';
        } else {
          showEmptyState();
        }
      } catch (err) {
        console.error('Error loading data:', err);
        showEmptyState();
      } finally {
        document.getElementById('loading').style.display = 'none';
      }
    }

    function showEmptyState() {
      document.getElementById('empty-state').style.display = 'block';
      clearCharts();
      clearStats();
      document.getElementById('timeline-container').innerHTML = '<p style="text-align:center; color: var(--text-muted); padding: 20px;">No timeline data available</p>';
    }

    function clearCharts() {
      if (consumptionChart) consumptionChart.destroy();
      if (levelChart) levelChart.destroy();
    }

    function clearStats() {
      document.getElementById('start-level').textContent = '--';
      document.getElementById('end-level').textContent = '--';
      document.getElementById('total-consumption').textContent = '--';
      document.getElementById('running-hours').textContent = '--';
      document.getElementById('avg-consumption').textContent = '--';
      if (dgType === 'total') {
        document.getElementById('refill-prediction').textContent = '--';
      }
    }

    function processData(data, startDate, endDate) {
      // Update date range subtitle
      const startStr = new Date(startDate + 'T00:00:00').toLocaleDateString('en-IN', { day: 'numeric', month: 'long', year: 'numeric' });
      const endStr = new Date(endDate + 'T00:00:00').toLocaleDateString('en-IN', { day: 'numeric', month: 'long', year: 'numeric' });
      
      if (startStr === endStr) {
        document.getElementById('date-range').textContent = new Date(startDate + 'T00:00:00').toLocaleDateString('en-IN', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
      } else {
        document.getElementById('date-range').textContent = `From ${startStr} to ${endStr}`;
      }

      // Calculate statistics
      let startLevel, endLevel, totalConsumption, runningHours;

      if (dgType === 'total') {
        startLevel = data[0]?.total?.level || 0; 
        endLevel = data[data.length - 1]?.total?.level || 0;
        totalConsumption = data.reduce((sum, r) => sum + (r.total?.consumption || 0), 0);
        
        // Count running intervals for any DG
        runningHours = data.filter(r => 
          (r.dg1?.isRunning || r.dg2?.isRunning || r.dg3?.isRunning)
        ).length * 0.5;

        // --- Refill Prediction Logic ---
        const avgConsumptionRate = runningHours > 0 ? (totalConsumption / runningHours) : 0; // L/hr
        let daysRemaining = '--';
        
        if (avgConsumptionRate > 0) {
          const usableDiesel = endLevel - CRITICAL_LEVEL;
          if (usableDiesel > 0) {
            // Get number of days in the selected range to predict average daily usage
            const daysInRange = Math.max(1, (new Date(endDate) - new Date(startDate)) / (1000 * 60 * 60 * 24) + 1);
            const avgRunningHoursPerDay = runningHours / daysInRange;
            
            if (avgRunningHoursPerDay > 0) {
              const avgDailyConsumption = avgConsumptionRate * avgRunningHoursPerDay; // Avg L/day
              daysRemaining = (usableDiesel / avgDailyConsumption).toFixed(1);
            }
          } else {
            daysRemaining = '0.0'; // Already below critical
          }
        }
        document.getElementById('refill-prediction').textContent = daysRemaining;

      } else {
        startLevel = data[0]?.level || 0;
        endLevel = data[data.length - 1]?.level || 0;
        totalConsumption = data.reduce((sum, r) => sum + (r.consumption || 0), 0);
        runningHours = data.filter(r => r.isRunning).length * 0.5;
      }

      const avgConsumption = runningHours > 0 ? (totalConsumption / runningHours) : 0;

      // Update stats
      document.getElementById('start-level').textContent = startLevel.toFixed(0);
      document.getElementById('end-level').textContent = endLevel.toFixed(0);
      document.getElementById('total-consumption').textContent = totalConsumption.toFixed(1);
      document.getElementById('running-hours').textContent = runningHours.toFixed(1);
      document.getElementById('avg-consumption').textContent = avgConsumption.toFixed(2);

      // Update charts
      updateCharts(data);
      
      // Update timeline
      updateTimeline(data);
    }

    function updateCharts(data) {
      const labels = data.map(r => {
        // Show Date + Time if range > 1 day, else just Time
        const d = new Date(r.timestamp);
        const startDate = document.getElementById('start-date').value;
        const endDate = document.getElementById('end-date').value;
        
        if (startDate !== endDate) {
            return d.toLocaleDateString('en-IN', { day: 'numeric', month: 'short' }) + ' ' + d.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' });
        }
        return d.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' });
      });

      let consumptionData, levelData;
      let levelChartDatasets = []; // For comparison graph

      if (dgType === 'total') {
        consumptionData = data.map(r => r.total?.consumption || 0);
        
        // --- Comparison Datasets ---
        levelChartDatasets = [
          {
            label: 'DG-1 Level (L)',
            data: data.map(r => r.dg1?.level || null),
            borderColor: 'rgba(0, 82, 204, 1)', // Blue
            backgroundColor: 'rgba(0, 82, 204, 0.1)',
            borderWidth: 2, fill: true, tension: 0.1, pointRadius: 1
          },
          {
            label: 'DG-2 Level (L)',
            data: data.map(r => r.dg2?.level || null),
            borderColor: 'rgba(0, 135, 90, 1)', // Green
            backgroundColor: 'rgba(0, 135, 90, 0.1)',
            borderWidth: 2, fill: true, tension: 0.1, pointRadius: 1
          },
          {
            label: 'DG-3 Level (L)',
            data: data.map(r => r.dg3?.level || null),
            borderColor: 'rgba(255, 171, 0, 1)', // Orange
            backgroundColor: 'rgba(255, 171, 0, 0.1)',
            borderWidth: 2, fill: true, tension: 0.1, pointRadius: 1
          }
        ];

      } else {
        consumptionData = data.map(r => r.consumption || 0);
        levelData = data.map(r => r.level || 0);

        // --- Single Dataset ---
        levelChartDatasets = [{
          label: 'Diesel Level (L)',
          data: levelData,
          borderColor: 'rgba(0, 135, 90, 1)',
          backgroundColor: 'rgba(0, 135, 90, 0.1)',
          borderWidth: 3,
          fill: true,
          tension: 0.4,
          pointRadius: 2,
          pointHoverRadius: 4
        }];
      }

      // --- Chart Colors ---
      const chartTextColor = '#172b4d';
      const chartGridColor = 'rgba(23, 43, 77, 0.1)';
      
      // Consumption chart
      if (consumptionChart) consumptionChart.destroy();
      const ctx1 = document.getElementById('consumptionChart').getContext('2d');
      consumptionChart = new Chart(ctx1, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Consumption (L)',
            data: consumptionData,
            backgroundColor: 'rgba(222, 53, 11, 0.8)',
            borderColor: 'rgba(222, 53, 11, 1)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { 
              labels: { color: chartTextColor, font: { size: 14 } }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return 'Consumption: ' + context.parsed.y.toFixed(1) + ' L';
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: { color: chartTextColor, font: { size: 12 } },
              grid: { color: chartGridColor },
              title: { display: true, text: 'Liters', color: chartTextColor }
            },
            x: {
              ticks: { color: chartTextColor, font: { size: 11 }, maxRotation: 45, minRotation: 45 },
              grid: { color: chartGridColor }
            }
          }
        }
      });

      // Level chart
      if (levelChart) levelChart.destroy();
      const ctx2 = document.getElementById('levelChart').getContext('2d');
      levelChart = new Chart(ctx2, {
        type: 'line',
        data: {
          labels: labels,
          datasets: levelChartDatasets
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { 
              labels: { color: chartTextColor, font: { size: 14 } }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return context.dataset.label + ': ' + context.parsed.y.toFixed(0) + ' L';
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: false, // Levels may not start at 0
              ticks: { color: chartTextColor, font: { size: 12 } },
              grid: { color: chartGridColor },
              title: { display: true, text: 'Liters', color: chartTextColor }
            },
            x: {
              ticks: { color: chartTextColor, font: { size: 11 }, maxRotation: 45, minRotation: 45 },
              grid: { color: chartGridColor }
            }
          }
        }
      });
    }

    function updateTimeline(data) {
      const container = document.getElementById('timeline-container');
      container.innerHTML = '';

      if (data.length === 0) {
        container.innerHTML = '<p style="text-align:center; color: var(--text-muted); padding: 20px;">No timeline data available</p>';
        return;
      }

      // For performance on large date ranges, limit timeline items
      // or show newest first. Let's show newest first (reverse)
      // and limit to last 100 items if the list is huge
      const displayData = [...data].reverse().slice(0, 100);

      displayData.forEach(record => {
        const time = new Date(record.timestamp);
        // Format: "14 Nov 10:30 AM"
        const timeStr = time.toLocaleDateString('en-IN', { day: 'numeric', month: 'short' }) + 
                        ' ' + 
                        time.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' });
        
        let isRunning, consumption;
        
        if (dgType === 'total') {
          isRunning = record.dg1?.isRunning || record.dg2?.isRunning || record.dg3?.isRunning;
          consumption = record.total?.consumption || 0;
        } else {
          isRunning = record.isRunning;
          consumption = record.consumption || 0;
        }

        const item = document.createElement('div');
        item.className = `timeline-item ${isRunning ? '' : 'stopped'}`;
        item.innerHTML = `
          <div class="timeline-time">${timeStr}</div>
          <div class="timeline-status ${isRunning ? 'running' : 'stopped'}">
            ${isRunning ? 'üü¢ Running' : 'üî¥ Stopped'}
          </div>
          <div class="timeline-consumption">
            ${consumption.toFixed(1)} L consumed
          </div>
        `;
        container.appendChild(item);
      });
      
      if (data.length > 100) {
         const moreItem = document.createElement('div');
         moreItem.style.textAlign = 'center';
         moreItem.style.padding = '10px';
         moreItem.style.color = 'var(--text-muted)';
         moreItem.innerHTML = `...and ${data.length - 100} older records`;
         container.appendChild(moreItem);
      }
    }

    function exportToExcel() {
      if (currentData.length === 0) {
        alert('No data to export. Please load data first.');
        return;
      }

      const startDate = document.getElementById('start-date').value;
      const endDate = document.getElementById('end-date').value;
      
      // Generate CSV
      let csv = '';
      
      if (dgType === 'total') {
        csv = 'Timestamp,Date,Time,DG1 Level (L),DG1 Consumption (L),DG1 Running,DG2 Level (L),DG2 Consumption (L),DG2 Running,DG3 Level (L),DG3 Consumption (L),DG3 Running,Total Level (L),Total Consumption (L)\n';
        
        currentData.forEach(r => {
          const d = new Date(r.timestamp);
          const dateStr = d.toLocaleDateString('en-IN');
          const timeStr = d.toLocaleTimeString('en-IN');
          
          csv += `${r.timestamp},${dateStr},${timeStr},${r.dg1?.level || 0},${r.dg1?.consumption || 0},${r.dg1?.isRunning ? 'Yes' : 'No'},${r.dg2?.level || 0},${r.dg2?.consumption || 0},${r.dg2?.isRunning ? 'Yes' : 'No'},${r.dg3?.level || 0},${r.dg3?.consumption || 0},${r.dg3?.isRunning ? 'Yes' : 'No'},${r.total?.level || 0},${r.total?.consumption || 0}\n`;
        });
      } else {
        csv = `Timestamp,Date,Time,${dgType.toUpperCase()} Level (L),${dgType.toUpperCase()} Consumption (L),Is Running\n`;
        
        currentData.forEach(r => {
          const d = new Date(r.timestamp);
          const dateStr = d.toLocaleDateString('en-IN');
          const timeStr = d.toLocaleTimeString('en-IN');
          csv += `${r.timestamp},${dateStr},${timeStr},${r.level || 0},${r.consumption || 0},${r.isRunning ? 'Yes' : 'No'}\n`;
        });
      }

      // Download CSV
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      
      link.setAttribute('href', url);
      link.setAttribute('download', `${dgType}_consumption_${startDate}_to_${endDate}.csv`);
      link.style.visibility = 'hidden';
      
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // Load initial data
    loadData();
  </script>
</body>
</html>
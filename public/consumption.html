<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>DG Consumption Details</title>
<link rel="icon" type="image/png" href="/logo.png">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
<style>
  :root {
    --primary: #0052cc; --success: #00875a; --warning: #ffab00; --danger: #de350b;
    --bg-primary: #ffffff; --bg-secondary: #f4f5f7; --bg-tertiary: #ffffff;
    --text-primary: #172b4d; --text-secondary: #42526e; --text-muted: #6b778c;
    --border: #dfe1e6;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { background: var(--bg-primary); font-family: 'Segoe UI', Tahoma, sans-serif; color: var(--text-primary); min-height: 100vh; padding: 15px; }
  .container { max-width: 1600px; margin: 0 auto; }
  .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 20px; background: var(--bg-secondary); border-radius: 12px; border: 1px solid var(--border); flex-wrap: wrap; gap: 15px; }
  .header-left h1 { font-size: 1.8rem; background: linear-gradient(90deg, #0052cc, #0065ff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 5px; }
  .header-left .subtitle { font-size: 0.9rem; color: var(--text-muted); }
  .header-right { display: flex; gap: 10px; flex-wrap: wrap; }
  .btn { padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; transition: all 0.3s; text-decoration: none; display: inline-block; font-size: 0.95rem; }
  .btn-primary { background: var(--primary); color: white; }
  .btn-success { background: var(--success); color: white; }
  .btn-secondary { background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border); }
  .filters { background: var(--bg-secondary); border: 1px solid var(--border); padding: 20px; border-radius: 12px; margin-bottom: 20px; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
  .filter-group { display: flex; flex-direction: column; gap: 8px; }
  label { font-size: 0.9rem; color: var(--text-muted); font-weight: 600; }
  input, select { padding: 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--bg-tertiary); color: var(--text-primary); font-size: 0.95rem; }
  .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px; }
  .stat-card { background: var(--bg-tertiary); border: 1px solid var(--border); padding: 20px; border-radius: 12px; text-align: center; border-top: 4px solid var(--primary); }
  .stat-label { font-size: 0.85rem; color: var(--text-muted); margin-bottom: 10px; text-transform: uppercase; letter-spacing: 0.5px; }
  .stat-value { font-size: 2.2rem; font-weight: 800; margin-bottom: 5px; color: var(--text-primary); }
  .stat-unit { font-size: 0.85rem; color: var(--text-muted); }
  
  #refill-details { 
    margin-top: 10px; font-size: 0.75rem; color: var(--text-muted); text-align: left;
    max-height: 80px; overflow-y: auto; padding: 5px; background: rgba(0, 82, 204, 0.05); border-radius: 4px;
  }
  
  .chart-section { background: var(--bg-secondary); border: 1px solid var(--border); padding: 25px; border-radius: 12px; margin-bottom: 20px; }
  .chart-title { font-size: 1.3rem; font-weight: 700; margin-bottom: 20px; color: var(--text-primary); border-left: 4px solid var(--primary); padding-left: 15px; }
  .chart-container { position: relative; height: 400px; }
  .loading, .empty-state { text-align: center; padding: 60px; color: var(--text-muted); font-size: 1.2rem; }
  .empty-state { background: var(--bg-secondary); border-radius: 12px; }
  .empty-state-icon { font-size: 4rem; margin-bottom: 20px; opacity: 0.5; }

  @media (max-width: 768px) {
    .header { flex-direction: column; align-items: flex-start; }
    .header-right { width: 100%; flex-direction: column; }
    .btn { width: 100%; text-align: center; }
    .chart-container { height: 300px; }
  }
</style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="header-left">
        <h1 id="page-title">DG Consumption Details</h1>
        <div class="subtitle" id="date-range">Loading...</div>
      </div>
      <div class="header-right">
        <button class="btn btn-success" onclick="exportAllData()">üì• Download All Data</button>
        <a href="/" class="btn btn-secondary">‚Üê Back to Dashboard</a>
      </div>
    </div>

    <div class="filters">
      <div class="filter-group">
        <label>From Date</label>
        <input type="date" id="start-date" />
      </div>
      <div class="filter-group">
        <label>To Date</label>
        <input type="date" id="end-date" />
      </div>
      <div class="filter-group">
        <label>Quick Select</label>
        <select id="quick-select">
          <option value="today" selected>Today</option>
          <option value="yesterday">Yesterday</option>
          <option value="week">Last 7 Days</option>
          <option value="month">Last 30 Days</option>
          <option value="custom">Custom Range</option>
        </select>
      </div>
      <div class="filter-group" style="justify-content: flex-end;">
        <label>&nbsp;</label>
        <button class="btn btn-primary" onclick="loadData()">Apply Filter</button>
      </div>
    </div>

    <div class="stats-grid">
      <div class="stat-card"><div class="stat-label">Start Level</div><div class="stat-value" id="start-level">--</div><div class="stat-unit">Liters</div></div>
      <div class="stat-card"><div class="stat-label">End Level</div><div class="stat-value" id="end-level">--</div><div class="stat-unit">Liters</div></div>
      <div class="stat-card" style="border-top-color: var(--danger);"><div class="stat-label">Total Consumption</div><div class="stat-value" id="total-consumption" style="color: var(--danger);">--</div><div class="stat-unit">Liters</div></div>
      
      <div class="stat-card" id="refill-info-card" style="border-top-color: #0052cc;">
        <div class="stat-label">‚õΩ Total Refilled</div>
        <div class="stat-value" id="total-refilled" style="color: #0052cc;">--</div>
        <div class="stat-unit">Liters</div>
        <div id="refill-details"></div>
      </div>
      
      <div class="stat-card" style="border-top-color: var(--success);">
        <div class="stat-label">Total Running Hours</div>
        <div class="stat-value" id="running-hours" style="color: var(--success);">--</div>
        <div class="stat-unit">Hours</div>
      </div>
      
      <div class="stat-card" style="border-top-color: var(--warning);">
        <div class="stat-label">Avg Consumption</div>
        <div class="stat-value" id="avg-consumption" style="color: var(--warning);">--</div>
        <div class="stat-unit">L/Hour</div>
      </div>
      
      <div class="stat-card" id="refill-card">
        <div class="stat-label">Refill Prediction</div>
        <div class="stat-value" id="refill-prediction" style="color: var(--primary);">--</div>
        <div class="stat-unit">Hours until 50L</div>
      </div>
    </div>

    <div class="chart-section">
      <div class="chart-title" id="consumption-chart-title">üìà Hourly Diesel Consumption</div>
      <div class="chart-container">
        <canvas id="consumptionChart"></canvas>
      </div>
    </div>

    <div class="chart-section">
      <div class="chart-title" id="level-chart-title">üìâ Diesel Level Over Time</div>
      <div class="chart-container">
        <canvas id="levelChart"></canvas>
      </div>
    </div>

    <div id="loading" class="loading" style="display:none;">‚è≥ Loading data...</div>
    <div id="empty-state" class="empty-state" style="display:none;">
      <div class="empty-state-icon">üì≠</div>
      <h2>No Data Available</h2>
      <p>No consumption data found for the selected date range.</p>
    </div>
  </div>

<script>
// ============================================================
// ACCURATE CONSUMPTION TRACKING
// ‚úÖ FIXED: Temperature expansion detection (< 20L increase)
// ‚úÖ Refill threshold: 10 Liters
// ‚úÖ 18 Liters per hour consumption rate
// ============================================================

let consumptionChart = null;
let levelChart = null;
let autoRefreshInterval = null;

const CRITICAL_LEVEL = 50;
const REFILL_THRESHOLD = 50; 
const CONSUMPTION_PER_HOUR = 18;

const urlParams = new URLSearchParams(window.location.search);
const dgType = urlParams.get('dg') || 'dg1';

const titles = {
    'dg1': 'DG-1 Consumption',
    'dg2': 'DG-2 Consumption',
    'dg3': 'DG-3 Consumption',
    'total': 'Total Consumption'
};
document.getElementById('page-title').textContent = titles[dgType] || titles['dg1'];

function formatNumber(num) {
    if (num === null || num === undefined || isNaN(num)) return '--';
    return parseFloat(Number(num).toFixed(2));
}

function setDateRange(range) {
    const end = new Date();
    const start = new Date();
    if (range === 'yesterday') {
        start.setDate(start.getDate() - 1);
        end.setDate(end.getDate() - 1);
    } else if (range === 'week') {
        start.setDate(start.getDate() - 6);
    } else if (range === 'month') {
        start.setDate(start.getDate() - 29);
    }
    document.getElementById('start-date').value = start.toISOString().split('T')[0];
    document.getElementById('end-date').value = end.toISOString().split('T')[0];
}

setDateRange('today');
document.getElementById('quick-select').value = 'today';
document.getElementById('quick-select').addEventListener('change', function() {
    if (this.value !== 'custom') setDateRange(this.value);
});

function createRefillEvent(timestamp, tankName, amount) {
    const d = new Date(timestamp);
    return {
        timestamp: timestamp,
        amount: amount,
        tank: tankName.replace('DG', 'DG-'),
        date: d.toLocaleDateString('en-IN'),
        time: d.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' })
    };
}

function setupAutoRefresh() {
    const startDate = document.getElementById('start-date').value;
    const endDate = document.getElementById('end-date').value;
    const today = new Date().toISOString().split('T')[0];
    if (autoRefreshInterval) { clearInterval(autoRefreshInterval); autoRefreshInterval = null; }
    if (startDate === today && endDate === today) {
        autoRefreshInterval = setInterval(() => { loadData(true); }, 30000);
    }
}

async function loadData(silent = false) {
    const startDate = document.getElementById('start-date').value;
    const endDate = document.getElementById('end-date').value;

    if (!silent) {
        document.getElementById('loading').style.display = 'block';
        document.getElementById('empty-state').style.display = 'none';
    }

    try {
        const query = `startDate=${startDate}&endDate=${endDate}`;
        const url = `/api/consumption?dg=${dgType}&${query}`;
        
        console.log('Fetching:', url); // ‚úÖ Debug log
        
        const response = await fetch(url);
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const result = await response.json();
        
        console.log('API Response:', result); // ‚úÖ Debug log

        // ‚úÖ SPECIAL HANDLING FOR 'total'
        if (dgType === 'total') {
            // For total, the API returns stats directly (no detailed data)
            if (result.success && result.stats) {
                // Create a simple summary display
                document.getElementById('start-level').textContent = '--';
                document.getElementById('end-level').textContent = '--';
                document.getElementById('total-consumption').textContent = formatNumber(result.stats.totalConsumption);
                
                // Show breakdown if available
                if (result.stats.breakdown) {
                    const breakdownText = `DG1: ${formatNumber(result.stats.breakdown.dg1)}L | DG2: ${formatNumber(result.stats.breakdown.dg2)}L | DG3: ${formatNumber(result.stats.breakdown.dg3)}L`;
                    document.getElementById('date-range').textContent = breakdownText;
                }
                
                // Hide running hours for total
                document.getElementById('running-hours').textContent = '--';
                document.getElementById('avg-consumption').textContent = '--';
                document.getElementById('refill-prediction').textContent = '--';
                
                // Handle refill events
                const totalRefilledEl = document.getElementById('total-refilled');
                const refillDetailsEl = document.getElementById('refill-details');
                
                if (totalRefilledEl) {
                    const totalRefilled = result.stats.refillEvents ? 
                        result.stats.refillEvents.reduce((sum, e) => sum + (e.amount || 0), 0) : 0;
                    totalRefilledEl.textContent = formatNumber(totalRefilled);
                }
                
                if (refillDetailsEl && result.stats.refillEvents && result.stats.refillEvents.length > 0) {
                    let detailsHTML = `<strong>üìã ${result.stats.refillEvents.length} Refill(s):</strong><br>`;
                    result.stats.refillEvents.forEach(event => {
                        const d = new Date(event.timestamp);
                        const time = d.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' });
                        detailsHTML += `<span style="color:#0052cc">‚õΩ ${event.dg || 'Unknown'} - ${time}</span>: +${formatNumber(event.amount)}L<br>`;
                    });
                    refillDetailsEl.innerHTML = detailsHTML;
                } else if (refillDetailsEl) {
                    refillDetailsEl.innerHTML = '<span style="color:var(--text-muted); font-size:0.8rem;">No refills detected.</span>';
                }
                
                // Clear charts since we don't have hourly data for total
                if (consumptionChart) { consumptionChart.destroy(); consumptionChart = null; }
                if (levelChart) { levelChart.destroy(); levelChart = null; }
                
                document.getElementById('empty-state').style.display = 'none';
                
            } else {
                throw new Error('Invalid response for total consumption');
            }
            
            setupAutoRefresh();
            return;
        }

        // ‚úÖ INDIVIDUAL DG PROCESSING (dg1, dg2, dg3)
        let displayData = [];
        
        if (result.data && result.data.length > 0) {
            displayData = result.data.map(record => {
                let mappedLevel = 0;
                let mappedConsumption = 0;

                if (record.cleanLevel !== undefined) {
                    mappedLevel = record.cleanLevel;
                    mappedConsumption = record.consumption || 0;
                } else {
                    mappedLevel = record[dgType]?.level || 0;
                    mappedConsumption = record[dgType]?.consumption || 0;
                }

                return {
                    timestamp: record.timestamp,
                    date: record.date,
                    level: mappedLevel,
                    consumption: mappedConsumption,
                    rawLevel: record.rawLevel,
                    isRunning: record.isRunning,
                    note: record.note
                };
            });
        }

        if (displayData.length === 0) {
            document.getElementById('empty-state').style.display = 'block';
            clearStats();
        } else {
            processData(displayData, startDate, endDate); 
            document.getElementById('empty-state').style.display = 'none';
        }

        setupAutoRefresh();

    } catch (err) {
        console.error('Error loading data:', err);
        alert('Failed to load data: ' + err.message); // ‚úÖ Show error to user
        document.getElementById('empty-state').style.display = 'block';
        clearStats();
    } finally {
        if (!silent) document.getElementById('loading').style.display = 'none';
    }
}


function clearStats() {
    const ids = ['start-level', 'end-level', 'total-consumption', 'running-hours', 'avg-consumption', 'total-refilled', 'refill-prediction'];
    ids.forEach(id => {
        const el = document.getElementById(id);
        if(el) el.textContent = '--';
    });
    const details = document.getElementById('refill-details');
    if(details) details.innerHTML = '';
}

// ============================================================
// ‚úÖ FIXED: Graph Data Mapping & Start Level Logic
// ============================================================
async function processData(data, startDate, endDate) {
    const startStr = new Date(startDate).toLocaleDateString('en-IN', { day: 'numeric', month: 'short' });
    document.getElementById('date-range').textContent = startStr;

    let totalConsumption = 0;
    let totalRefilled = 0;
    let refillEvents = [];
    let temperatureEvents = []; 
    
    const hourlyConsumption = {};
    const hourlyLevels = {};

    for (let h = 0; h < 24; h++) {
        hourlyConsumption[h] = 0;
        hourlyLevels[h] = [];
    }

    data.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

    let previousLevel = null;

    let cleanData = data.map((record, index) => {
        const hour = new Date(record.timestamp).getHours();
        
        // ‚úÖ FIX: Read the mapped 'level' directly (It comes from record.cleanLevel in loadData)
        // We do NOT need to check dgType here because loadData already handled it.
        const currentLevel = record.level || 0;
        const dbConsumption = record.consumption || 0;

        hourlyLevels[hour].push(currentLevel);

        // ‚úÖ DETECT REFILLS & TEMPERATURE EXPANSIONS
        if (index > 0 && previousLevel !== null) {
            const diff = currentLevel - previousLevel;
            
            if (diff > 0) { // Level increased
                if (diff >= REFILL_THRESHOLD) {
                    // Refill
                    const refillAmount = diff;
                    totalRefilled += refillAmount;
                    refillEvents.push(createRefillEvent(
                        record.timestamp, 
                        dgType.toUpperCase(), 
                        refillAmount
                    ));
                } else {
                    // Temperature expansion
                    temperatureEvents.push({
                        timestamp: record.timestamp,
                        hour: hour,
                        amount: diff,
                        time: new Date(record.timestamp).toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' })
                    });
                }
            }
        }

        // Add consumption to totals
        totalConsumption += dbConsumption;
        hourlyConsumption[hour] += dbConsumption;

        previousLevel = currentLevel;

        return {
            ...record,
            cleanLevel: currentLevel,
            cleanConsumption: dbConsumption,
            hour: hour,
            dateStr: record.date || record.timestamp.split('T')[0]
        };
    });

    // ============================================================
    // ‚úÖ Calculate Start/End Levels
    // ============================================================
    let startLevel = 0;
    let endLevel = 0;

    if (cleanData.length > 0) {
        // 1. Scan for the first real number (Start Level)
        const firstValidRecord = cleanData.find(d => d.cleanLevel > 0);
        if (firstValidRecord) {
            startLevel = firstValidRecord.cleanLevel;
        } else {
            startLevel = cleanData[0].cleanLevel;
        }

        // 2. Set End Level (Last record)
        endLevel = cleanData[cleanData.length - 1].cleanLevel;
    }

    // Handle Live Data Update for Today
    const today = new Date().toISOString().split('T')[0];
    const isViewingToday = (endDate === today);
    
    if (isViewingToday) {
        try {
            const liveResponse = await fetch('/api/data');
            if (liveResponse.ok) {
                const liveData = await liveResponse.json();
                
                let liveLevel = 0;
                if (dgType === 'total') {
                    const dg1 = liveData.dg1 || 0;
                    const dg2 = liveData.dg2 || 0;
                    const dg3 = liveData.dg3 || 0;
                    liveLevel = dg1 + dg2 + dg3;
                } else {
                    liveLevel = liveData[dgType] || 0;
                }
                
                if (liveLevel > 0) {
                    endLevel = liveLevel;
                }
            }
        } catch (err) {
            console.error('Failed to fetch live level:', err);
        }
    }

    // ============================================================
    // Calculate Stats
    // ============================================================
    let runningHours = 0;
    if (totalConsumption > 0) {
        runningHours = totalConsumption / CONSUMPTION_PER_HOUR; 
    }

    let avgConsumptionRate = CONSUMPTION_PER_HOUR; 
    if (runningHours > 0 && totalConsumption > 0) {
        avgConsumptionRate = totalConsumption / runningHours;
    }

    // Refill prediction
    let timeRemaining = '--';
    const predCard = document.getElementById('refill-prediction');
    const predCardContainer = document.getElementById('refill-card');

    if (endLevel > CRITICAL_LEVEL) {
        const usableDiesel = endLevel - CRITICAL_LEVEL;
        let predictionRate = (avgConsumptionRate > 0) ? avgConsumptionRate : CONSUMPTION_PER_HOUR;
        
        timeRemaining = (usableDiesel / predictionRate).toFixed(1);
        
        const hoursLeft = parseFloat(timeRemaining);
        let color = 'var(--danger)';
        if (hoursLeft > 24) color = 'var(--success)';
        else if (hoursLeft > 12) color = '#0052cc';
        else if (hoursLeft > 6) color = 'var(--warning)';

        predCard.style.color = color;
        predCardContainer.style.borderTopColor = color;
    } else {
        timeRemaining = "0.0 (Critical)";
        predCard.style.color = 'var(--danger)';
        predCardContainer.style.borderTopColor = 'var(--danger)';
    }

    // ============================================================
    // Update UI
    // ============================================================
    document.getElementById('start-level').textContent = formatNumber(startLevel);
    document.getElementById('end-level').textContent = formatNumber(endLevel);
    document.getElementById('total-consumption').textContent = formatNumber(totalConsumption);

    const runningHoursEl = document.getElementById('running-hours');
    const runningHoursUnit = runningHoursEl.closest('.stat-card').querySelector('.stat-unit');

    if (runningHours < 1 && runningHours > 0) {
        runningHoursEl.textContent = formatNumber(runningHours * 60);
        runningHoursUnit.textContent = 'Minutes';
    } else {
        runningHoursEl.textContent = formatNumber(runningHours);
        runningHoursUnit.textContent = 'Hours';
    }

    document.getElementById('avg-consumption').textContent = formatNumber(avgConsumptionRate);
    document.getElementById('refill-prediction').textContent = timeRemaining;

    const totalRefilledEl = document.getElementById('total-refilled');
    const refillDetailsEl = document.getElementById('refill-details');

    if (totalRefilledEl) totalRefilledEl.textContent = formatNumber(totalRefilled);

    if (refillDetailsEl) {
        let detailsHTML = '';
        
        if (refillEvents.length > 0) {
            detailsHTML += `<strong>üìã ${refillEvents.length} Refill(s):</strong><br>`;
            refillEvents.forEach(event => {
                detailsHTML += `<span style="color:#0052cc">‚õΩ ${event.time}</span>: +${formatNumber(event.amount)}L<br>`;
            });
        }
        
        if (temperatureEvents.length > 0) {
            if (detailsHTML) detailsHTML += '<br>';
            detailsHTML += `<strong>üå°Ô∏è ${temperatureEvents.length} Temperature Expansion(s):</strong><br>`;
            temperatureEvents.forEach(event => {
                detailsHTML += `<span style="color:#ff9800">üå°Ô∏è ${event.time}</span>: +${formatNumber(event.amount)}L (ignored)<br>`;
            });
        }
        
        if (!detailsHTML) {
            detailsHTML = '<span style="color:var(--text-muted); font-size:0.8rem;">No refills or expansions detected.</span>';
        }
        
        refillDetailsEl.innerHTML = detailsHTML;
    }

    updateCharts(cleanData, startDate, endDate, refillEvents, temperatureEvents, hourlyConsumption, hourlyLevels);
}

// ============================================================
// ‚úÖ UPDATED: Charts with temperature event tooltips
// ============================================================
function updateCharts(cleanData, startDate, endDate, refillEvents, temperatureEvents, hourlyConsumption, hourlyLevels) {
    const isMultiDay = (new Date(endDate) - new Date(startDate)) > 86400000;

    let labels = [];
    let consumptionData = [];
    let levelData = [];
    let pointColors = [];
    let pointRadiuses = [];
    let pointLabels = []; // ‚úÖ NEW: Store tooltip info

    if (isMultiDay) {
        const dailyMap = {};
        cleanData.forEach(d => {
            const dateKey = d.dateStr || d.date;
            if (!dailyMap[dateKey]) dailyMap[dateKey] = { label: dateKey, consumption: 0, levels: [] };
            dailyMap[dateKey].consumption += d.cleanConsumption;
            dailyMap[dateKey].levels.push(d.cleanLevel);
        });

        labels = Object.keys(dailyMap);
        consumptionData = Object.values(dailyMap).map(t => t.consumption);
        levelData = Object.values(dailyMap).map(t => {
            const levels = t.levels.filter(l => l > 0);
            return levels.length > 0 ? levels[levels.length - 1] : null;
        });
        levelData.forEach(() => { 
            pointColors.push('rgba(0, 135, 90, 1)'); 
            pointRadiuses.push(3);
            pointLabels.push(null);
        });

    } else {
        // Single day view
        for (let h = 0; h <= 23; h++) {
            let ampm = h >= 12 ? 'PM' : 'AM';
            let hour12 = h % 12 || 12;
            labels.push(`${hour12} ${ampm}`);

            consumptionData.push(hourlyConsumption[h] || 0);

            if (hourlyLevels[h] && hourlyLevels[h].length > 0) {
                const validLevels = hourlyLevels[h].filter(l => l > 0);
                levelData.push(validLevels.length > 0 ? validLevels[validLevels.length - 1] : null);

                // ‚úÖ Check for refill
                let hasRefill = refillEvents.some(e => new Date(e.timestamp).getHours() === h);
                
                // ‚úÖ Check for temperature expansion
                let hasTempExpansion = temperatureEvents.some(e => e.hour === h);
                
                if (hasRefill) {
                    pointColors.push('#0052cc');
                    pointRadiuses.push(8);
                    pointLabels.push('refill');
                } else if (hasTempExpansion) {
                    pointColors.push('#ff9800'); // ‚úÖ Orange for temperature
                    pointRadiuses.push(6);
                    pointLabels.push('temperature');
                } else {
                    pointColors.push('rgba(0, 135, 90, 1)');
                    pointRadiuses.push(4);
                    pointLabels.push(null);
                }
            } else {
                levelData.push(null);
                pointColors.push('transparent');
                pointRadiuses.push(0);
                pointLabels.push(null);
            }
        }
    }

    // Auto-zoom Y-axis
    const validLevels = levelData.filter(v => v !== null && v > 0);
    let yMin = undefined;
    let yMax = undefined;

    if (validLevels.length > 0) {
        const minVal = Math.min(...validLevels);
        const maxVal = Math.max(...validLevels);
        yMin = Math.floor(minVal - 5);
        yMax = Math.ceil(maxVal + 5);
        if (yMin < 0) yMin = 0;
    }

    // Consumption Chart
    const ctx1 = document.getElementById('consumptionChart');
    if (ctx1) {
        if (consumptionChart) { consumptionChart.destroy(); consumptionChart = null; }
        consumptionChart = new Chart(ctx1, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Consumption (L)',
                    data: consumptionData,
                    backgroundColor: consumptionData.map(val => 
                        val > 0 ? 'rgba(222, 53, 11, 0.8)' : 'rgba(200, 200, 200, 0.1)'
                    ),
                    borderColor: consumptionData.map(val => 
                        val > 0 ? 'rgba(222, 53, 11, 1)' : 'transparent'
                    ),
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { 
                        beginAtZero: true, 
                        title: { display: true, text: 'Liters' },
                        max: Math.max(...consumptionData) > 0 ? Math.ceil(Math.max(...consumptionData) * 1.2) : 10
                    },
                    x: { ticks: { autoSkip: false }, grid: { display: false } }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: (ctx) => {
                                if (ctx.raw === 0) return 'No consumption';
                                return `Consumed: ${formatNumber(ctx.raw)}L`;
                            }
                        }
                    },
                    legend: { display: true }
                }
            }
        });
    }

    // ‚úÖ UPDATED: Level Chart with temperature expansion tooltips
    const ctx2 = document.getElementById('levelChart');
    if (ctx2) {
        if (levelChart) { levelChart.destroy(); levelChart = null; }
        levelChart = new Chart(ctx2, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Level (L)',
                    data: levelData,
                    borderColor: 'rgba(0, 135, 90, 1)',
                    backgroundColor: 'rgba(0, 135, 90, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    spanGaps: true,
                    pointBackgroundColor: pointColors,
                    pointRadius: pointRadiuses,
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
    tooltip: {
        callbacks: {
            label: ctx => {
                const labelType = pointLabels[ctx.dataIndex];
                
                if (labelType === 'refill') {
                    return `‚õΩ Refill! Level: ${formatNumber(ctx.raw)}L`;
                } else if (labelType === 'temperature') {
                    // ‚úÖ UPDATED: Just show "Sensor Noise" - simple and clear
                    return `‚ö†Ô∏è Sensor Noise`;
                }
                
                return `Level: ${formatNumber(ctx.raw)}L`;
            }
        }
    }
},
                scales: {
                    y: {
                        beginAtZero: false,
                        title: { display: true, text: 'Liters' },
                        min: yMin,
                        max: yMax
                    },
                    x: { ticks: { autoSkip: false }, grid: { display: true } }
                }
            }
        });
    }
}

function exportAllData() {
    const startDate = document.getElementById('start-date').value;
    const endDate = document.getElementById('end-date').value;
    window.location.href = `/api/export/all?startDate=${startDate}&endDate=${endDate}`;
}

loadData();
window.addEventListener('beforeunload', () => {
    if (autoRefreshInterval) clearInterval(autoRefreshInterval);
});
</script>
</body>
</html>
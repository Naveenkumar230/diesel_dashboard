<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>DG Consumption Details</title>
<link rel="icon" type="image/png" href="/logo.png">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
  :root {
    --primary: #0052cc; --success: #00875a; --warning: #ffab00; --danger: #de350b;
    --bg-primary: #ffffff; --bg-secondary: #f4f5f7; --bg-tertiary: #ffffff;
    --text-primary: #172b4d; --text-secondary: #42526e; --text-muted: #6b778c;
    --border: #dfe1e6;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { background: var(--bg-primary); font-family: 'Segoe UI', Tahoma, sans-serif; color: var(--text-primary); min-height: 100vh; padding: 15px; }
  .container { max-width: 1600px; margin: 0 auto; }
  .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 20px; background: var(--bg-secondary); border-radius: 12px; border: 1px solid var(--border); flex-wrap: wrap; gap: 15px; }
  .header-left h1 { font-size: 1.8rem; background: linear-gradient(90deg, #0052cc, #0065ff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 5px; }
  .header-left .subtitle { font-size: 0.9rem; color: var(--text-muted); }
  .header-right { display: flex; gap: 10px; flex-wrap: wrap; }
  .btn { padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; transition: all 0.3s; text-decoration: none; display: inline-block; font-size: 0.95rem; }
  .btn-primary { background: var(--primary); color: white; }
  .btn-primary:hover { background: #0041a3; transform: translateY(-2px); }
  .btn-success { background: var(--success); color: white; }
  .btn-success:hover { background: #006644; transform: translateY(-2px); }
  .btn-secondary { background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border); }
  .btn-secondary:hover { background: #dfe1e6; }
  .filters { background: var(--bg-secondary); border: 1px solid var(--border); padding: 20px; border-radius: 12px; margin-bottom: 20px; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
  .filter-group { display: flex; flex-direction: column; gap: 8px; }
  label { font-size: 0.9rem; color: var(--text-muted); font-weight: 600; }
  input, select { padding: 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--bg-tertiary); color: var(--text-primary); font-size: 0.95rem; }
  .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px; }
  .stat-card { background: var(--bg-tertiary); border: 1px solid var(--border); padding: 20px; border-radius: 12px; text-align: center; border-top: 4px solid var(--primary); }
  .stat-label { font-size: 0.85rem; color: var(--text-muted); margin-bottom: 10px; text-transform: uppercase; letter-spacing: 0.5px; }
  .stat-value { font-size: 2.2rem; font-weight: 800; margin-bottom: 5px; color: var(--text-primary); }
  .stat-unit { font-size: 0.85rem; color: var(--text-muted); }
  
  /* Refill Details Styling */
  #refill-details { 
    margin-top: 10px; 
    font-size: 0.75rem; 
    color: var(--text-muted); 
    text-align: left;
    max-height: 80px;
    overflow-y: auto;
    padding: 5px;
    background: rgba(0, 82, 204, 0.05);
    border-radius: 4px;
  }
  
  .chart-section { background: var(--bg-secondary); border: 1px solid var(--border); padding: 25px; border-radius: 12px; margin-bottom: 20px; }
  .chart-title { font-size: 1.3rem; font-weight: 700; margin-bottom: 20px; color: var(--text-primary); border-left: 4px solid var(--primary); padding-left: 15px; }
  .chart-container { position: relative; height: 400px; }
  .loading, .empty-state { text-align: center; padding: 60px; color: var(--text-muted); font-size: 1.2rem; }
  .empty-state { background: var(--bg-secondary); border-radius: 12px; }
  .empty-state-icon { font-size: 4rem; margin-bottom: 20px; opacity: 0.5; }

  @media (max-width: 768px) {
    .header { flex-direction: column; align-items: flex-start; }
    .header-right { width: 100%; flex-direction: column; }
    .btn { width: 100%; text-align: center; }
    .chart-container { height: 300px; }
  }
</style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="header-left">
        <h1 id="page-title">DG Consumption Details</h1>
        <div class="subtitle" id="date-range">Loading...</div>
      </div>
      <div class="header-right">
        <button class="btn btn-success" onclick="exportAllData()">üì• Download All Data</button>
        <a href="/" class="btn btn-secondary">‚Üê Back to Dashboard</a>
      </div>
    </div>

    <div class="filters">
      <div class="filter-group">
        <label>From Date</label>
        <input type="date" id="start-date" />
      </div>
      <div class="filter-group">
        <label>To Date</label>
        <input type="date" id="end-date" />
      </div>
      <div class="filter-group">
        <label>Quick Select</label>
        <select id="quick-select">
          <option value="today" selected>Today</option>
          <option value="yesterday">Yesterday</option>
          <option value="week">Last 7 Days</option>
          <option value="month">Last 30 Days</option>
          <option value="custom">Custom Range</option>
        </select>
      </div>
      <div class="filter-group" style="justify-content: flex-end;">
        <label>&nbsp;</label>
        <button class="btn btn-primary" onclick="loadData()">Apply Filter</button>
      </div>
    </div>

    <div class="stats-grid">
      <div class="stat-card"><div class="stat-label">Start Level</div><div class="stat-value" id="start-level">--</div><div class="stat-unit">Liters</div></div>
      <div class="stat-card"><div class="stat-label">End Level</div><div class="stat-value" id="end-level">--</div><div class="stat-unit">Liters</div></div>
      <div class="stat-card" style="border-top-color: var(--danger);"><div class="stat-label">Total Consumption</div><div class="stat-value" id="total-consumption" style="color: var(--danger);">--</div><div class="stat-unit">Liters</div></div>
      
      <!-- ‚úÖ REFILL CARD - Always visible, shows/hides based on data -->
      <div class="stat-card" id="refill-info-card" style="border-top-color: #0052cc; display: none;">
        <div class="stat-label">‚õΩ Total Refilled</div>
        <div class="stat-value" id="total-refilled" style="color: #0052cc;">--</div>
        <div class="stat-unit">Liters</div>
        <div id="refill-details"></div>
      </div>
      
      <div class="stat-card" style="border-top-color: var(--success);"><div class="stat-label">Total Running Hours</div><div class="stat-value" id="running-hours" style="color: var(--success);">--</div><div class="stat-unit">Hours</div></div>
      <div class="stat-card" style="border-top-color: var(--warning);"><div class="stat-label">Avg Consumption</div><div class="stat-value" id="avg-consumption" style="color: var(--warning);">--</div><div class="stat-unit">L/Hour</div></div>
      <div class="stat-card" id="refill-card" style="display: none;"><div class="stat-label">Refill Prediction</div><div class="stat-value" id="refill-prediction" style="color: var(--primary);">--</div><div class="stat-unit">Days until 50L</div></div>
    </div>

    <div class="chart-section">
      <div class="chart-title" id="consumption-chart-title">üìà Hourly Diesel Consumption</div>
      <div class="chart-container">
        <canvas id="consumptionChart"></canvas>
      </div>
    </div>

    <div class="chart-section">
      <div class="chart-title" id="level-chart-title">üìâ Diesel Level Over Time</div>
      <div class="chart-container">
        <canvas id="levelChart"></canvas>
      </div>
    </div>

    <div id="loading" class="loading" style="display:none;">‚è≥ Loading data...</div>
    <div id="empty-state" class="empty-state" style="display:none;">
      <div class="empty-state-icon">üì≠</div>
      <h2>No Data Available</h2>
      <p>No consumption data found for the selected date range.</p>
    </div>
  </div>

<script>
// ‚úÖ FINAL FIXED VERSION: Handles DG1/2/3 Structure & Day-Wise Aggregation

let consumptionChart = null;
let levelChart = null;
let autoRefreshInterval = null;

// ‚úÖ CONFIGURATION
const CRITICAL_LEVEL = 50;
const REFILL_THRESHOLD = 20; 
const NOISE_THRESHOLD = 0.5; 
const CONSUMPTION_PER_HOUR = 7; // 7 Liters = 1 Hour

// 1. GET URL PARAMETERS
const urlParams = new URLSearchParams(window.location.search);
const dgType = urlParams.get('dg') || 'dg1'; // Default to dg1
const titles = { 'dg1': 'DG-1 Consumption', 'dg2': 'DG-2 Consumption', 'dg3': 'DG-3 Consumption', 'total': 'Total Consumption' };

// Set Title
document.getElementById('page-title').textContent = titles[dgType] || titles['dg1'];
if (dgType === 'total') document.getElementById('refill-card').style.display = 'block';

// Helper: Format Numbers
function formatNumber(num) {
    if (num === null || num === undefined || isNaN(num)) return '--';
    return parseFloat(Number(num).toFixed(2)); 
}

// 2. DATE HANDLING
function setDateRange(range) {
    const end = new Date();
    const start = new Date();
    if (range === 'yesterday') {
        start.setDate(start.getDate() - 1);
        end.setDate(end.getDate() - 1);
    } else if (range === 'week') {
        start.setDate(start.getDate() - 6);
    } else if (range === 'month') {
        start.setDate(start.getDate() - 29);
    }
    // Adjust for timezone (India)
    const offset = start.getTimezoneOffset() * 60000;
    document.getElementById('start-date').value = new Date(start - offset).toISOString().split('T')[0];
    document.getElementById('end-date').value = new Date(end - offset).toISOString().split('T')[0];
}

// Initialize Dates
setDateRange('today'); 
document.getElementById('quick-select').addEventListener('change', function() {
  if (this.value !== 'custom') setDateRange(this.value);
});

// 3. FETCH DATA
async function loadData() {
  const startDate = document.getElementById('start-date').value;
  const endDate = document.getElementById('end-date').value;
  
  document.getElementById('loading').style.display = 'block'; 
  document.getElementById('empty-state').style.display = 'none';

  try {
    // Fetch from API
    const url = `/api/consumption?dg=${dgType}&startDate=${startDate}&endDate=${endDate}`;
    console.log("Fetching URL:", url); // Debugging
    
    const response = await fetch(url);
    const result = await response.json();
    let displayData = result.data || [];

    if (displayData.length === 0) {
        showEmptyState();
        return;
    }

    processData(displayData, startDate, endDate);

  } catch (err) {
    console.error('Error loading data:', err);
    showEmptyState();
  } finally {
    document.getElementById('loading').style.display = 'none';
  }
}

function showEmptyState() {
  document.getElementById('empty-state').style.display = 'block';
  if (consumptionChart) consumptionChart.destroy();
  if (levelChart) levelChart.destroy();
  
  // Reset stats
  ['start-level', 'end-level', 'total-consumption', 'running-hours', 'avg-consumption'].forEach(id => {
      document.getElementById(id).textContent = '--';
  });
}

// 4. CORE LOGIC: NOISE FILTER + DG DATA EXTRACTION
function processWithNoiseFilter(data, selectedDg) {
  let totalConsumption = 0;
  let totalRefilled = 0;
  let refillEvents = [];
  let stableLevel = null; 
  
  let cleanData = data.map((record) => {
    // ‚úÖ FIX: Access the specific DG object correctly
    let rawLevel = 0;
    if (selectedDg === 'total') {
        rawLevel = record.total?.level || 0;
    } else {
        // This handles dg1, dg2, dg3 structure: { dg1: { level: 500 } }
        rawLevel = record[selectedDg]?.level || 0; 
    }

    // Initialize first reading
    if (stableLevel === null) stableLevel = rawLevel;

    let diff = rawLevel - stableLevel;
    let consumption = 0;

    // Logic: Big Jump = Refill, Drop = Consumption, Small Wiggle = Noise
    if (diff > REFILL_THRESHOLD) {
        totalRefilled += diff;
        refillEvents.push({ 
            timestamp: record.timestamp, 
            amount: diff, 
            time: new Date(record.timestamp).toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' }) 
        });
        stableLevel = rawLevel; 
    } else if (diff < -NOISE_THRESHOLD) {
        consumption = Math.abs(diff);
        totalConsumption += consumption;
        stableLevel = rawLevel; 
    } 
    
    return { 
        timestamp: record.timestamp, 
        cleanLevel: stableLevel, 
        cleanConsumption: consumption,
        dateStr: record.timestamp.split('T')[0] // For daily aggregation
    };
  });

  return { totalConsumption, totalRefilled, refillEvents, cleanData };
}

// 5. PROCESS DATA & UPDATE UI
function processData(data, startDate, endDate) {
  const { totalConsumption, totalRefilled, refillEvents, cleanData } = processWithNoiseFilter(data, dgType);

  // Update Top Cards
  const startLevel = cleanData.length > 0 ? cleanData[0].cleanLevel : 0;
  const endLevel = cleanData.length > 0 ? cleanData[cleanData.length - 1].cleanLevel : 0;
  const runningHours = (totalConsumption > 0) ? (totalConsumption / CONSUMPTION_PER_HOUR) : 0;

  document.getElementById('start-level').textContent = formatNumber(startLevel);
  document.getElementById('end-level').textContent = formatNumber(endLevel);
  document.getElementById('total-consumption').textContent = formatNumber(totalConsumption);
  document.getElementById('running-hours').textContent = formatNumber(runningHours);
  document.getElementById('avg-consumption').textContent = formatNumber(runningHours > 0 ? (totalConsumption / runningHours) : 0);

  // Refill Logic
  const refillCard = document.getElementById('refill-info-card');
  if (totalRefilled > 0) {
    refillCard.style.display = 'block';
    document.getElementById('total-refilled').textContent = formatNumber(totalRefilled);
    let detailsHTML = `<strong>üìã ${refillEvents.length} Refill(s):</strong><br>`;
    refillEvents.forEach(event => { 
        detailsHTML += `<span style="color:#0052cc">‚õΩ ${event.time}</span>: +${formatNumber(event.amount)}L<br>`; 
    });
    document.getElementById('refill-details').innerHTML = detailsHTML;
  } else {
    refillCard.style.display = 'none';
  }

  updateCharts(cleanData, startDate, endDate, refillEvents);
}

// 6. CHART RENDERING (Day-wise vs Hourly)
function updateCharts(cleanData, startDate, endDate, refillEvents) {
    // Check if date range is greater than 24 hours
    const isMultiDay = (new Date(endDate) - new Date(startDate)) > (1000 * 60 * 60 * 24);
    
    let labels = [];
    let consumptionData = [];
    let levelData = [];

    if (isMultiDay) {
        // ‚úÖ DAY-WISE AGGREGATION LOGIC
        document.getElementById('consumption-chart-title').textContent = 'üìà Daily Consumption';
        
        // Group by Date
        const days = {};
        cleanData.forEach(d => {
            if (!days[d.dateStr]) days[d.dateStr] = { consumption: 0, level: d.cleanLevel };
            days[d.dateStr].consumption += d.cleanConsumption;
            days[d.dateStr].level = d.cleanLevel; // Take last level of the day
        });

        Object.keys(days).sort().forEach(date => {
            labels.push(date); // e.g., "2025-11-20"
            consumptionData.push(days[date].consumption);
            levelData.push(days[date].level);
        });

    } else {
        // ‚úÖ HOURLY / MINUTE LOGIC (Detailed View)
        document.getElementById('consumption-chart-title').textContent = 'üìà Detailed Consumption';
        cleanData.forEach(d => {
            const timeLabel = new Date(d.timestamp).toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' });
            labels.push(timeLabel);
            consumptionData.push(d.cleanConsumption);
            levelData.push(d.cleanLevel);
        });
    }

    // DESTROY OLD CHARTS
    if (consumptionChart) { consumptionChart.destroy(); consumptionChart = null; }
    if (levelChart) { levelChart.destroy(); levelChart = null; }

    // RENDER CONSUMPTION CHART (Bar)
    const ctxCons = document.getElementById('consumptionChart').getContext('2d');
    consumptionChart = new Chart(ctxCons, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Consumption (Liters)',
                data: consumptionData,
                backgroundColor: 'rgba(222, 53, 11, 0.8)',
                borderColor: 'rgba(222, 53, 11, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: { y: { beginAtZero: true } }
        }
    });

    // RENDER LEVEL CHART (Line)
    const ctxLevel = document.getElementById('levelChart').getContext('2d');
    levelChart = new Chart(ctxLevel, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Diesel Level (Liters)',
                data: levelData,
                borderColor: '#00875a',
                backgroundColor: 'rgba(0, 135, 90, 0.1)',
                borderWidth: 2,
                fill: true,
                pointRadius: isMultiDay ? 4 : 0 // Hide dots if too many points
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: { y: { beginAtZero: false } }
        }
    });
}

function exportAllData() {
  const startDate = document.getElementById('start-date').value;
  const endDate = document.getElementById('end-date').value;
  window.location.href = `/api/export/consumption?dg=${dgType}&startDate=${startDate}&endDate=${endDate}`;
}

// Initial Load
loadData();

</script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>DG Monitoring System Dashboard</title>
<link rel="icon" type="image/png" href="/logo.png">
<style>
  :root {
    --primary: #0052cc; 
    --success: #00875a; 
    --warning: #ffab00; 
    --danger: #de350b; 
    --bg-primary: #ffffff; 
    --bg-secondary: #f4f5f7; 
    --bg-tertiary: #ffffff; 
    --text-primary: #172b4d; 
    --text-secondary: #42526e; 
    --text-muted: #6b778c; 
    --border: #dfe1e6; 
  }
  
  * { box-sizing: border-box; margin: 0; padding: 0; }
  
  body {
    background: var(--bg-primary);
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    color: var(--text-primary);
    min-height: 100vh;
    padding: 15px;
  }
  
  .container { max-width: 1400px; margin: 0 auto; }

  
  /* --- NEW ANALYTICS STYLES --- */
.analytics-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 12px;
    padding: 15px 20px;
    background: #f4f5f7;
    border-top: 1px solid #dfe1e6;
    margin-top: -10px; /* Connect visually to the param grid */
}
.analytics-card {
    background: #fff;
    border: 1px solid #dfe1e6;
    border-radius: 8px;
    padding: 12px;
    text-align: center;
    position: relative;
    box-shadow: 0 2px 4px rgba(0,0,0,0.03);
}
.analytics-label {
    font-size: 0.75rem;
    color: #6b778c;
    text-transform: uppercase;
    font-weight: 700;
    margin-bottom: 5px;
}
.analytics-value {
    font-size: 1.2rem;
    font-weight: 800;
    color: #172b4d;
}
.analytics-unit {
    font-size: 0.8rem;
    color: #999;
    font-weight: normal;
}
/* Specific Colors for Impact */
.val-cost { color: #d97706; } /* Gold/Orange */
.val-time { color: #0052cc; } /* Blue */
.val-fuel { color: #00875a; } /* Green */
.val-load { color: #6554c0; } /* Purple */

@media (max-width: 768px) {
    .analytics-grid { grid-template-columns: repeat(2, 1fr); }
}

  /* HEADER STYLES */
  .header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 30px;
    background: var(--bg-secondary);
    border-radius: 12px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    border: 1px solid var(--border);
    text-align: left;
    margin-bottom: 25px;
  }
  
  .header-logo {
    height: 65px;
    width: auto;
    object-fit: contain;
  }

  h1 {
    margin: 0;
    font-size: 1.8rem;
    background: linear-gradient(90deg, #0052cc, #0065ff);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    line-height: 1.2;
  }
  /* Add/Check this in your CSS */
@media (max-width: 900px) {
  .header {
    flex-direction: column;
    text-align: center;
    gap: 15px;
  }
  
  h1 {
    margin: 0 !important; /* Resets the margin we added for laptop view */
    font-size: 1.5rem;
  }
  
  .header > div {
    flex-direction: column;
    gap: 15px;
    width: 100%;
    align-items: center !important;
  }
  
  .status-line {
    text-align: center !important;
  }
}
  
  .status-line {
    text-align: right;
    font-size: 0.85rem;
    color: var(--text-muted);
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 5px;
  }

  @media (max-width: 768px) {
    .header {
      flex-direction: column;
      text-align: center;
      gap: 15px;
      padding: 20px;
    }
    .status-line {
      align-items: center;
      text-align: center;
    }
    .header-logo {
        height: 50px;
    }
  }
  
  .status-indicator {
    display: inline-block;
    width: 10px; height: 10px;
    border-radius: 50%;
    margin-right: 8px;
    animation: pulse 2s infinite;
  }
  
  .status-online { background: var(--success); }
  .status-offline { background: var(--danger); }
  
  @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

  /* Diesel Section */
  .diesel-section { background: var(--bg-secondary); border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); border: 1px solid var(--border); }
  .section-header { font-size: 1.1rem; font-weight: 700; color: var(--text-secondary); margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid var(--border); display: flex; align-items: center; gap: 8px; }
  .diesel-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
  .diesel-card { background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 8px; padding: 20px; text-align: center; position: relative; overflow: hidden; transition: all 0.3s; cursor: pointer; text-decoration: none; color: inherit; display: block; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); }
  .diesel-card:hover { transform: translateY(-3px); box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1); border-color: var(--primary); }
  .diesel-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; }
  .diesel-card.normal::before { background: linear-gradient(90deg, #10b981, #34d399); }
  .diesel-card.warning::before { background: linear-gradient(90deg, #f59e0b, #fbbf24); }
  .diesel-card.critical::before { background: linear-gradient(90deg, #ef4444, #f87171); }
  .diesel-label { font-size: 0.85rem; color: var(--text-muted); margin-bottom: 10px; text-transform: uppercase; letter-spacing: 0.5px; }
  .diesel-value { font-size: 2.5rem; font-weight: 800; line-height: 1; margin-bottom: 5px; color: var(--text-primary); }
  .diesel-unit { font-size: 0.9rem; color: var(--text-muted); }

  /* Electrical Sections */
  .dg-electrical-section { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 12px; margin-bottom: 15px; overflow: hidden; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); }
  .dg-header-link { text-decoration: none; color: inherit; display: block; }
  .dg-header { padding: 18px 20px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: background 0.3s; border-bottom: 1px solid var(--border); }
  .dg-header-link:hover .dg-header { background: rgba(0, 82, 204, 0.05); }
  .dg-title { display: flex; align-items: center; gap: 12px; flex: 1; }
  .dg-name { font-size: 1.2rem; font-weight: 700; color: var(--text-primary); }
  .status-badge { padding: 4px 12px; border-radius: 12px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
  .status-running { background: var(--success); color: white; }
  .status-off { background: var(--danger); color: white; }
  .expand-icon { font-size: 1.5rem; transition: transform 0.3s; color: var(--text-muted); }
  .dg-electrical-section.expanded .expand-icon { transform: rotate(180deg); }
  .dg-content { max-height: 0; overflow: hidden; transition: max-height 0.4s ease; }
  .dg-electrical-section.expanded .dg-content { max-height: 2000px; }
.param-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; padding: 20px; }
@media (max-width: 1200px) {.param-grid {grid-template-columns: repeat(4, 1fr);}}
@media (max-width: 768px) {.param-grid {  grid-template-columns: repeat(2, 1fr); }}
  .param-card { background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 8px; padding: 15px; text-align: center; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
  .param-label { font-size: 0.75rem; color: var(--text-muted); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.3px; }
  .param-value { font-size: 1.5rem; font-weight: 700; margin-bottom: 3px; color: var(--text-primary); }
  .param-unit { font-size: 0.8rem; color: var(--text-muted); }
  .alert-banner { background: linear-gradient(135deg, #ef4444, #dc2626); color: white; padding: 15px 20px; border-radius: 8px; margin-bottom: 20px; display: none; align-items: center; gap: 10px; font-weight: 600; animation: slideDown 0.3s ease; }
  .alert-banner.show { display: flex; }
  @keyframes slideDown { from { transform: translateY(-100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

  @media (max-width: 768px) {
    h1 { font-size: 1.5rem; }
    .diesel-value { font-size: 2rem; }
    .param-value { font-size: 1.3rem; }
    .diesel-grid { grid-template-columns: repeat(2, 1fr); }
    .param-grid { grid-template-columns: repeat(2, 1fr); }
  }
</style>
</head>
<body>
  <div class="header">
  <img src="/logo.png" alt="Aquarelle Logo" class="header-logo">
  
  <h1 style="margin-left: 320px; margin-right: auto;">DG Monitoring System Dashboard</h1>
  
  <div style="display: flex; align-items: center; gap: 25px;">
    
    <div class="status-line" style="text-align: right;">
      <div style="display: flex; align-items: center; gap: 5px; justify-content: flex-end;">
        <span class="status-indicator status-online" id="server-status"></span>
        <span style="font-weight: 600; font-size: 0.9rem;">Server Online</span>
      </div>
      <div style="font-size: 0.85rem; color: var(--text-muted);">
        Last Updated: <span id="last-update">--</span>
      </div>
    </div>

    <!-- <a href="/analytics.html" class="btn btn-primary" style="text-decoration: none; padding: 10px 25px; background: #0052cc; color: white; border-radius: 8px; font-weight: 600; white-space: nowrap;">
      üìä Analytics
    </a> -->
    
  </div>
</div>
    <div id="alert-container"></div>

        <div class="diesel-section">
      <div class="section-header">
        üõ¢Ô∏è Diesel Levels (Click for Details)
      </div>
      <div class="diesel-grid">
        <a href="/consumption.html?dg=dg1" class="diesel-card normal" id="dg1-diesel-card">
          <div class="diesel-label">DG-1 Diesel</div>
          <div class="diesel-value" id="dg1-diesel">--</div>
          <div class="diesel-unit">Liters</div>
        </a>
        <a href="/consumption.html?dg=dg2" class="diesel-card normal" id="dg2-diesel-card">
          <div class="diesel-label">DG-2 Diesel</div>
          <div class="diesel-value" id="dg2-diesel">--</div>
          <div class="diesel-unit">Liters</div>
        </a>
        <a href="/consumption.html?dg=dg3" class="diesel-card normal" id="dg3-diesel-card">
          <div class="diesel-label">DG-3 Diesel</div>
          <div class="diesel-value" id="dg3-diesel">--</div>
          <div class="diesel-unit">Liters</div>
        </a>
        <a href="/consumption.html?dg=total" class="diesel-card normal">
          <div class="diesel-label">Total Diesel</div>
          <div class="diesel-value" id="total-diesel">--</div>
          <div class="diesel-unit">Liters</div>
        </a>
      </div>
    </div>

    <!-- DG 1 -->
   <!-- DG 1 -->
<div class="dg-electrical-section expanded" id="dg1-section">
  <a href="/electrical.html?dg=dg1" class="dg-header-link">
    <div class="dg-header">
      <div class="dg-title">
        <div class="dg-name">‚öôÔ∏è DG-1 Electrical Parameters</div>
        <div class="status-badge status-off" id="dg1-status">OFF</div>
      </div>
      <div class="expand-icon" data-target="dg1-content">‚ñº</div>
    </div>
  </a>
  <div class="dg-content" id="dg1-content">
   <div class="param-grid">
  <div class="param-card"><div class="param-label">Voltage R</div><div class="param-value" id="dg1-voltage-r">--</div><div class="param-unit">V</div></div>
  <div class="param-card"><div class="param-label">Voltage Y</div><div class="param-value" id="dg1-voltage-y">--</div><div class="param-unit">V</div></div>
  <div class="param-card"><div class="param-label">Voltage B</div><div class="param-value" id="dg1-voltage-b">--</div><div class="param-unit">V</div></div>
  <div class="param-card"><div class="param-label">Current R</div><div class="param-value" id="dg1-current-r">--</div><div class="param-unit">A</div></div>
  <div class="param-card"><div class="param-label">Current Y</div><div class="param-value" id="dg1-current-y">--</div><div class="param-unit">A</div></div>
  <div class="param-card"><div class="param-label">Current B</div><div class="param-value" id="dg1-current-b">--</div><div class="param-unit">A</div></div>
  <div class="param-card"><div class="param-label">kWh</div><div class="param-value" id="dg1-active-power">--</div><div class="param-unit">kWh</div></div>
  <div class="param-card"><div class="param-label">Frequency</div><div class="param-value" id="dg1-frequency">--</div><div class="param-unit">Hz</div></div>
  <div class="param-card"><div class="param-label">Power Factor</div><div class="param-value" id="dg1-power-factor">--</div><div class="param-unit">PF</div></div>
  <div class="param-card"><div class="param-label">Runtime</div><div class="param-value" id="dg1-runtime">--</div><div class="param-unit">Minutes</div></div>
  </div> 

<div class="analytics-grid">
    
    <div class="analytics-card">
        <div class="analytics-label">‚è±Ô∏è Session Time</div>
        <div class="analytics-value val-time" id="dg1-calc-time">0</div>
        <div class="analytics-unit">Minutes</div>
    </div>

    <div class="analytics-card">
        <div class="analytics-label">‚õΩ Fuel Used</div>
        <div class="analytics-value val-fuel" id="dg1-calc-fuel">0.0</div>
        <div class="analytics-unit">Liters</div>
    </div>

    <div class="analytics-card" style="border-bottom: 3px solid #f59e0b;">
        <div class="analytics-label">üí∞ Est. Cost</div>
        <div class="analytics-value val-cost">
            <span style="font-size:0.9rem">‚Çπ</span>
            <span id="dg1-calc-cost">0</span>
        </div>
        <div class="analytics-unit">Indian Rupees</div>
    </div>

    <div class="analytics-card">
        <div class="analytics-label">‚öôÔ∏è Efficiency</div>
        <div class="analytics-value val-load" id="dg1-load-pct">0%</div>
        <div class="analytics-unit" id="dg1-load-status">Idle</div>
    </div>

</div>
</div>
  </div>
</div>

    <!-- DG 2 -->
    <!-- DG 2 -->
    <div class="dg-electrical-section expanded" id="dg2-section">
      <a href="/electrical.html?dg=dg2" class="dg-header-link">
        <div class="dg-header">
          <div class="dg-title"><div class="dg-name">‚öôÔ∏è DG-2 Electrical Parameters</div><div class="status-badge status-off" id="dg2-status">OFF</div></div>
          <div class="expand-icon" data-target="dg2-content">‚ñº</div>
        </div>
      </a>
      <div class="dg-content" id="dg2-content">
        <div class="param-grid">
          <div class="param-card"><div class="param-label">Voltage R</div><div class="param-value" id="dg2-voltage-r">--</div><div class="param-unit">V</div></div>
          <div class="param-card"><div class="param-label">Voltage Y</div><div class="param-value" id="dg2-voltage-y">--</div><div class="param-unit">V</div></div>
          <div class="param-card"><div class="param-label">Voltage B</div><div class="param-value" id="dg2-voltage-b">--</div><div class="param-unit">V</div></div>
          <div class="param-card"><div class="param-label">Current R</div><div class="param-value" id="dg2-current-r">--</div><div class="param-unit">A</div></div>
          <div class="param-card"><div class="param-label">Current Y</div><div class="param-value" id="dg2-current-y">--</div><div class="param-unit">A</div></div>
          <div class="param-card"><div class="param-label">Current B</div><div class="param-value" id="dg2-current-b">--</div><div class="param-unit">A</div></div>
          <div class="param-card"><div class="param-label">kWh</div><div class="param-value" id="dg2-active-power">--</div><div class="param-unit">kWh</div></div>
          <div class="param-card"><div class="param-label">Frequency</div><div class="param-value" id="dg2-frequency">--</div><div class="param-unit">Hz</div></div>
          <div class="param-card"><div class="param-label">Power Factor</div><div class="param-value" id="dg2-power-factor">--</div><div class="param-unit">PF</div></div>
  <div class="param-card"><div class="param-label">Runtime</div><div class="param-value" id="dg2-runtime">--</div><div class="param-unit">Minutes</div></div>
  </div> 

<div class="analytics-grid">
    <div class="analytics-card">
        <div class="analytics-label">‚è±Ô∏è Session Time</div>
        <div class="analytics-value val-time" id="dg2-calc-time">0</div>
        <div class="analytics-unit">Minutes</div>
    </div>
    <div class="analytics-card">
        <div class="analytics-label">‚õΩ Fuel Used</div>
        <div class="analytics-value val-fuel" id="dg2-calc-fuel">0.0</div>
        <div class="analytics-unit">Liters</div>
    </div>
    <div class="analytics-card" style="border-bottom: 3px solid #f59e0b;">
        <div class="analytics-label">üí∞ Est. Cost</div>
        <div class="analytics-value val-cost">
            <span style="font-size:0.9rem">‚Çπ</span>
            <span id="dg2-calc-cost">0</span>
        </div>
        <div class="analytics-unit">Indian Rupees</div>
    </div>
    <div class="analytics-card">
        <div class="analytics-label">‚öôÔ∏è Efficiency</div>
        <div class="analytics-value val-load" id="dg2-load-pct">0%</div>
        <div class="analytics-unit" id="dg2-load-status">Idle</div>
    </div>
</div>
        </div>
      </div>
    </div>

    <!-- DG 3 -->
    <div class="dg-electrical-section expanded" id="dg3-section">
      <a href="/electrical.html?dg=dg3" class="dg-header-link">
        <div class="dg-header">
          <div class="dg-title"><div class="dg-name">‚öôÔ∏è DG-3 Electrical Parameters</div><div class="status-badge status-off" id="dg3-status">OFF</div></div>
          <div class="expand-icon" data-target="dg3-content">‚ñº</div>
        </div>
      </a>
      <div class="dg-content" id="dg3-content">
        <div class="param-grid">
          <div class="param-card"><div class="param-label">Voltage R</div><div class="param-value" id="dg3-voltage-r">--</div><div class="param-unit">V</div></div>
          <div class="param-card"><div class="param-label">Voltage Y</div><div class="param-value" id="dg3-voltage-y">--</div><div class="param-unit">V</div></div>
          <div class="param-card"><div class="param-label">Voltage B</div><div class="param-value" id="dg3-voltage-b">--</div><div class="param-unit">V</div></div>
          <div class="param-card"><div class="param-label">Current R</div><div class="param-value" id="dg3-current-r">--</div><div class="param-unit">A</div></div>
          <div class="param-card"><div class="param-label">Current Y</div><div class="param-value" id="dg3-current-y">--</div><div class="param-unit">A</div></div>
          <div class="param-card"><div class="param-label">Current B</div><div class="param-value" id="dg3-current-b">--</div><div class="param-unit">A</div></div>
          <div class="param-card"><div class="param-label">kWh</div><div class="param-value" id="dg3-active-power">--</div><div class="param-unit">kWh</div></div>
          <div class="param-card"><div class="param-label">Frequency</div><div class="param-value" id="dg3-frequency">--</div><div class="param-unit">Hz</div></div>
          <div class="param-card"><div class="param-label">Power Factor</div><div class="param-value" id="dg3-power-factor">--</div><div class="param-unit">PF</div></div>
  <div class="param-card"><div class="param-label">Runtime</div><div class="param-value" id="dg3-runtime">--</div><div class="param-unit">Minutes</div></div>

  </div> 

<div class="analytics-grid">
    <div class="analytics-card">
        <div class="analytics-label">‚è±Ô∏è Session Time</div>
        <div class="analytics-value val-time" id="dg3-calc-time">0</div>
        <div class="analytics-unit">Minutes</div>
    </div>
    <div class="analytics-card">
        <div class="analytics-label">‚õΩ Fuel Used</div>
        <div class="analytics-value val-fuel" id="dg3-calc-fuel">0.0</div>
        <div class="analytics-unit">Liters</div>
    </div>
    <div class="analytics-card" style="border-bottom: 3px solid #f59e0b;">
        <div class="analytics-label">üí∞ Est. Cost</div>
        <div class="analytics-value val-cost">
            <span style="font-size:0.9rem">‚Çπ</span>
            <span id="dg3-calc-cost">0</span>
        </div>
        <div class="analytics-unit">Indian Rupees</div>
    </div>
    <div class="analytics-card">
        <div class="analytics-label">‚öôÔ∏è Efficiency</div>
        <div class="analytics-value val-load" id="dg3-load-pct">0%</div>
        <div class="analytics-unit" id="dg3-load-status">Idle</div>
    </div>
</div>
        </div>
      </div>
    </div>

    <!-- DG 4 -->
    <div class="dg-electrical-section expanded" id="dg4-section">
      <a href="/electrical.html?dg=dg4" class="dg-header-link">
        <div class="dg-header">
          <div class="dg-title"><div class="dg-name">‚öôÔ∏è DG-4 Electrical Parameters</div><div class="status-badge status-off" id="dg4-status">OFF</div></div>
          <div class="expand-icon" data-target="dg4-content">‚ñº</div>
        </div>
      </a>
      <div class="dg-content" id="dg4-content">
        <div class="param-grid">
          <div class="param-card"><div class="param-label">Voltage R</div><div class="param-value" id="dg4-voltage-r">--</div><div class="param-unit">V</div></div>
          <div class="param-card"><div class="param-label">Voltage Y</div><div class="param-value" id="dg4-voltage-y">--</div><div class="param-unit">V</div></div>
          <div class="param-card"><div class="param-label">Voltage B</div><div class="param-value" id="dg4-voltage-b">--</div><div class="param-unit">V</div></div>
          <div class="param-card"><div class="param-label">Current R</div><div class="param-value" id="dg4-current-r">--</div><div class="param-unit">A</div></div>
          <div class="param-card"><div class="param-label">Current Y</div><div class="param-value" id="dg4-current-y">--</div><div class="param-unit">A</div></div>
          <div class="param-card"><div class="param-label">Current B</div><div class="param-value" id="dg4-current-b">--</div><div class="param-unit">A</div></div>
          <div class="param-card"><div class="param-label">kWh</div><div class="param-value" id="dg4-active-power">--</div><div class="param-unit">kWh</div></div>
          <div class="param-card"><div class="param-label">Frequency</div><div class="param-value" id="dg4-frequency">--</div><div class="param-unit">Hz</div></div>
          <div class="param-card"><div class="param-label">Power Factor</div><div class="param-value" id="dg4-power-factor">--</div><div class="param-unit">PF</div></div>
  <div class="param-card"><div class="param-label">Runtime</div><div class="param-value" id="dg4-runtime">--</div><div class="param-unit">Minutes</div></div>
  </div> 

<div class="analytics-grid">
    <div class="analytics-card">
        <div class="analytics-label">‚è±Ô∏è Session Time</div>
        <div class="analytics-value val-time" id="dg4-calc-time">0</div>
        <div class="analytics-unit">Minutes</div>
    </div>
    <div class="analytics-card">
        <div class="analytics-label">‚õΩ Fuel Used</div>
        <div class="analytics-value val-fuel" id="dg4-calc-fuel">0.0</div>
        <div class="analytics-unit">Liters</div>
    </div>
    <div class="analytics-card" style="border-bottom: 3px solid #f59e0b;">
        <div class="analytics-label">üí∞ Est. Cost</div>
        <div class="analytics-value val-cost">
            <span style="font-size:0.9rem">‚Çπ</span>
            <span id="dg4-calc-cost">0</span>
        </div>
        <div class="analytics-unit">Indian Rupees</div>
    </div>
    <div class="analytics-card">
        <div class="analytics-label">‚öôÔ∏è Efficiency</div>
        <div class="analytics-value val-load" id="dg4-load-pct">0%</div>
        <div class="analytics-unit" id="dg4-load-status">Idle</div>
    </div>
</div>
        </div>
      </div>
    </div>

  </div>
<script>
    // --- CONFIGURATION ---
    const CONFIG = {
        CRITICAL_LEVEL: 50,
        WARNING_LEVEL: 70,
        RUNNING_AMPS: 5,       // Threshold to decide "Is Running"
        MAX_AMPS: 175,         // For Efficiency Calc (125 kVA)
        DIESEL_PRICE: 97.00,
        // Noise Filters (Ignore values outside these ranges)
        MAX_VOLTAGE: 600,
        MAX_FREQ: 70
    };

    // --- STATE MANAGEMENT ---
    let isUpdating = false;
    let dailyStats = { dg1: {}, dg2: {}, dg3: {}, dg4: {} };
    // Store the last "Good" running data to show when DG stops
    let lastRunningData = { dg1: null, dg2: null, dg3: null, dg4: null };

    // --- UI EXPANSION LOGIC ---
    document.querySelectorAll('.expand-icon').forEach(icon => {
        icon.addEventListener('click', (e) => {
            e.preventDefault(); 
            e.stopPropagation();
            
            const contentId = icon.getAttribute('data-target');
            const content = document.getElementById(contentId);
            const section = content.closest('.dg-electrical-section');
            section.classList.toggle('expanded');
            content.style.maxHeight = section.classList.contains('expanded') ? '2000px' : '0';
        });
    });

    document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('.dg-content').forEach(content => {
            const section = content.closest('.dg-electrical-section');
            if (section.classList.contains('expanded')) { 
                content.style.maxHeight = '2000px'; 
            } else { 
                content.style.maxHeight = '0'; 
            }
        });
        // Initial Fetch
        fetchDailyAnalytics();
        refresh();
    });

    // --- UTILITY FUNCTION ---
    function formatNum(num, decimals = 1) {
        if (num === undefined || num === null || isNaN(num)) return '--';
        if (num === 0) return decimals > 0 ? '0.0' : '0';
        return num.toFixed(decimals);
    }

    // --- API CALLS ---
    async function fetchData() {
        try {
            const response = await fetch('/api/data');
            if (!response.ok) return null;
            return await response.json();
        } catch (err) { 
            console.error('‚ùå fetchData error:', err);
            return null; 
        }
    }

    // ‚úÖ FETCH HISTORY & FIND LAST GOOD RECORD (Fixes "0" when OFF)
    async function fetchDailyAnalytics() {
        const today = new Date().toISOString().split('T')[0];
        const dgs = ['dg1', 'dg2', 'dg3', 'dg4'];

        for (const dg of dgs) {
            try {
                const res = await fetch(`/api/electrical/${dg}?startDate=${today}&endDate=${today}`);
                const json = await res.json();
                
                // A. Update Analytics (Blue Boxes)
                if (json.analytics) {
                    dailyStats[dg] = {
                        time: json.analytics.totalMinutes || 0,
                        fuel: json.analytics.totalFuel || 0,
                        cost: json.analytics.totalCost || 0
                    };
                }

                // B. Find Last Running Record (Smart Hold)
                // We look backwards from the end of the data to find the last time Amps > 5
                if (json.data && json.data.length > 0) {
                    for (let i = json.data.length - 1; i >= 0; i--) {
                        const row = json.data[i];
                        const avgAmps = ((row.currentR || 0) + (row.currentY || 0) + (row.currentB || 0)) / 3;
                        // Check if valid run data (No Noise)
                        if (avgAmps > CONFIG.RUNNING_AMPS && row.frequency < CONFIG.MAX_FREQ) {
                            lastRunningData[dg] = row; // Save this as the "Last Known Good State"
                            console.log(`‚úÖ Cached last running data for ${dg}:`, row);
                            break;
                        }
                    }
                }
            } catch (e) { 
                console.error(`‚ùå Error fetching analytics for ${dg}:`, e); 
            }
        }
        updateAnalyticsUI();
    }

    // --- UI UPDATERS ---
    
    function updateAnalyticsUI() {
        const dgs = ['dg1', 'dg2', 'dg3', 'dg4'];
        dgs.forEach(dg => {
            const stats = dailyStats[dg] || {};
            const set = (id, val) => { 
                const el = document.getElementById(id); 
                if(el) el.textContent = val; 
            };
            
            // Update Blue Boxes with Database Values
            set(`${dg}-calc-time`, Math.round(stats.time || 0));
            set(`${dg}-calc-fuel`, (stats.fuel || 0).toFixed(2));
            set(`${dg}-calc-cost`, Math.round(stats.cost || 0));
        });
    }

    async function updateDieselLevels(data) {
        if(!data) return;
        
        const levels = { 
            dg1: data.dg1 || 0, 
            dg2: data.dg2 || 0, 
            dg3: data.dg3 || 0 
        };
        const total = levels.dg1 + levels.dg2 + levels.dg3;

        ['dg1', 'dg2', 'dg3'].forEach(dg => {
            const val = levels[dg];
            const el = document.getElementById(`${dg}-diesel`);
            const card = document.getElementById(`${dg}-diesel-card`);
            
            if(el) el.textContent = val > 0 ? val : "--";
            
            if(card && val > 0) {
                card.className = 'diesel-card';
                if (val <= CONFIG.CRITICAL_LEVEL) card.classList.add('critical');
                else if (val <= CONFIG.WARNING_LEVEL) card.classList.add('warning');
                else card.classList.add('normal');
            }
        });
        
        const totalEl = document.getElementById('total-diesel');
        if(totalEl) totalEl.textContent = total > 0 ? total : "--";

        // Update Alert Banner
        const criticalDGs = Object.entries(levels)
            .filter(([key, value]) => value > 0 && value <= CONFIG.CRITICAL_LEVEL)
            .map(([key]) => key.toUpperCase().replace('DG', 'DG-'));
        
        const container = document.getElementById('alert-container');
        if(container) {
            container.innerHTML = '';
            if (criticalDGs.length > 0) {
                container.innerHTML = `<div class="alert-banner show">‚ö†Ô∏è CRITICAL: Low diesel levels in ${criticalDGs.join(', ')}! Refuel immediately.</div>`;
            }
        }
    }

    // ‚úÖ COMPLETE FIXED FUNCTION - SMART DISPLAY LOGIC
    function updateElectricalParams(data) {
        if (!data || !data.electrical) {
            console.warn("‚ö†Ô∏è No electrical data received");
            return;
        }
        
        const dgs = ['dg1', 'dg2', 'dg3', 'dg4'];

        dgs.forEach(dg => {
            let d = data.electrical[dg];
            
            // ‚úÖ FIX 1: Added safety check
            if (!d) {
                console.warn(`‚ö†Ô∏è No data for ${dg}`);
                return;
            }

            // ‚úÖ FIX 2: Handle undefined/null values properly
            const avgAmps = ((d.currentR || 0) + (d.currentY || 0) + (d.currentB || 0)) / 3;
            
            // Check for Noise (Voltage too high or Freq too high)
            const isNoise = (d.voltageR > CONFIG.MAX_VOLTAGE) || (d.frequency > CONFIG.MAX_FREQ);
            const isLiveRunning = (avgAmps > CONFIG.RUNNING_AMPS) && !isNoise;

            // 2. Decide Source: Live or Last Known?
            // If it's NOT running (0 Amps) or Noisy, show the "Last Running Data" from history
            if (!isLiveRunning && lastRunningData[dg]) {
                d = lastRunningData[dg]; // Use history when OFF
                console.log(`üìã Using cached data for ${dg}`);
            } else if (isLiveRunning) {
                lastRunningData[dg] = { ...d }; // ‚úÖ FIX 3: Save copy of good data
                console.log(`‚úÖ ${dg} is running - saving current data`);
            }

            // 3. Update Status Badge (Always based on Real Live Status)
            const statusEl = document.getElementById(`${dg}-status`);
            if(statusEl) {
                if (isLiveRunning) {
                    statusEl.textContent = "RUNNING";
                    statusEl.className = "status-badge status-running";
                } else {
                    statusEl.textContent = "OFF";
                    statusEl.className = "status-badge status-off";
                }
            }

            // 4. ‚úÖ FIX 4: CRITICAL FIX - Update Cards with Proper Display Logic
            ['r', 'y', 'b'].forEach(phase => {
                const P = phase.toUpperCase();
                
                // Voltage Update
                const vEl = document.getElementById(`${dg}-voltage-${phase}`);
                if(vEl) {
                    const voltage = d[`voltage${P}`];
                    if (voltage !== undefined && voltage !== null && !isNaN(voltage)) {
                        vEl.textContent = Math.round(voltage);
                    } else {
                        vEl.textContent = '--';
                    }
                }
                
                // ‚≠ê Current Update - THE MAIN FIX
                const cEl = document.getElementById(`${dg}-current-${phase}`);
                if(cEl) {
                    const current = d[`current${P}`];
                    
                    // Explicit null/undefined check
                    if (current !== undefined && current !== null && !isNaN(current)) {
                        // Show the value even if it's 0
                        cEl.textContent = Math.round(current);
                        // Debug log (comment out in production)
                        // console.log(`‚úÖ ${dg} Current ${P}: ${current}A`);
                    } else {
                        cEl.textContent = '--';
                        console.warn(`‚ö†Ô∏è ${dg} Current ${P}: MISSING DATA`);
                    }
                } else {
                    console.error(`‚ùå Element not found: ${dg}-current-${phase}`);
                }
            });

            // 5. Update other electrical parameters
            const freqEl = document.getElementById(`${dg}-frequency`);
            if(freqEl) freqEl.textContent = formatNum(d.frequency, 1);
            
            const apEl = document.getElementById(`${dg}-active-power`);
            if(apEl) apEl.textContent = formatNum(d.activePower, 1);
            
            const pfEl = document.getElementById(`${dg}-power-factor`);
            if(pfEl) pfEl.textContent = formatNum(d.powerFactor, 2);
            
            const rtEl = document.getElementById(`${dg}-runtime`);
            if(rtEl) rtEl.textContent = formatNum(d.runningHours, 0);

            // 6. Efficiency (Recalculate based on displayed data)
            const dispAmps = ((d.currentR || 0) + (d.currentY || 0) + (d.currentB || 0)) / 3;
            const loadPct = Math.round((dispAmps / CONFIG.MAX_AMPS) * 100);
            
            const loadEl = document.getElementById(`${dg}-load-pct`);
            const statusTextEl = document.getElementById(`${dg}-load-status`);

            if (loadEl) loadEl.textContent = loadPct + "%";
            if (statusTextEl) {
                if (loadPct > 90) { 
                    statusTextEl.textContent = "Overload ‚ö†Ô∏è"; 
                    statusTextEl.style.color = "red"; 
                }
                else if (loadPct > 40) { 
                    statusTextEl.textContent = "Efficient ‚úÖ"; 
                    statusTextEl.style.color = "green"; 
                }
                else { 
                    statusTextEl.textContent = "Idle"; 
                    statusTextEl.style.color = "orange"; 
                }
            }
        });
    }

    function updateTimestamp() {
        const now = new Date();
        const el = document.getElementById('last-update');
        if (el) {
            el.textContent = now.toLocaleString('en-IN', { 
                timeZone: 'Asia/Kolkata',
                timeStyle: 'medium', 
                dateStyle: 'short' 
            });
        }
    }

    // --- MAIN REFRESH FUNCTION ---
    async function refresh() {
        if (isUpdating) return;
        isUpdating = true;
        
        try {
            const data = await fetchData();
            const indicator = document.getElementById('server-status');
            
            // üîç OPTIONAL DEBUG - Uncomment to see raw data
            // if(data && data.electrical && data.electrical.dg1) {
            //     console.log("üìä DG1 Raw Data:", data.electrical.dg1);
            // }
            
            if (data) {
                if(indicator) { 
                    indicator.classList.remove('status-offline'); 
                    indicator.classList.add('status-online'); 
                }
                
                await updateDieselLevels(data);
                updateElectricalParams(data);
                updateTimestamp();
            } else {
                if(indicator) { 
                    indicator.classList.remove('status-online'); 
                    indicator.classList.add('status-offline'); 
                }
            }
        } catch (e) { 
            console.error('‚ùå Refresh error:', e); 
        } finally {
            isUpdating = false;
        }
    }

    // --- AUTO-REFRESH TIMERS ---
    setInterval(refresh, 1000);           // Refresh live data every 1 second
    setInterval(fetchDailyAnalytics, 30000); // Refresh analytics every 30 seconds
</script>
</body>
</html>
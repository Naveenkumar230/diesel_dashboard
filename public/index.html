<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>DG Monitoring System Dashboard</title>
<link rel="icon" type="image/png" href="/logo.png">
<style>
  :root {
    --primary: #0052cc; 
    --success: #00875a; 
    --warning: #ffab00; 
    --danger: #de350b; 
    --bg-primary: #ffffff; 
    --bg-secondary: #f4f5f7; 
    --bg-tertiary: #ffffff; 
    --text-primary: #172b4d; 
    --text-secondary: #42526e; 
    --text-muted: #6b778c; 
    --border: #dfe1e6; 
  }
  
  * { box-sizing: border-box; margin: 0; padding: 0; }
  
  body {
    background: var(--bg-primary);
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    color: var(--text-primary);
    min-height: 100vh;
    padding: 15px;
  }
  
  .container { max-width: 1400px; margin: 0 auto; }
  
  /* HEADER STYLES */
  .header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 30px;
    background: var(--bg-secondary);
    border-radius: 12px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    border: 1px solid var(--border);
    text-align: left;
    margin-bottom: 25px;
  }
  
  .header-logo {
    height: 65px;
    width: auto;
    object-fit: contain;
  }

  h1 {
    margin: 0;
    font-size: 1.8rem;
    background: linear-gradient(90deg, #0052cc, #0065ff);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    line-height: 1.2;
  }
  
  .status-line {
    text-align: right;
    font-size: 0.85rem;
    color: var(--text-muted);
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 5px;
  }

  @media (max-width: 768px) {
    .header {
      flex-direction: column;
      text-align: center;
      gap: 15px;
      padding: 20px;
    }
    .status-line {
      align-items: center;
      text-align: center;
    }
    .header-logo {
        height: 50px;
    }
  }
  
  .status-indicator {
    display: inline-block;
    width: 10px; height: 10px;
    border-radius: 50%;
    margin-right: 8px;
    animation: pulse 2s infinite;
  }
  
  .status-online { background: var(--success); }
  .status-offline { background: var(--danger); }
  
  @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

  /* Diesel Section */
  .diesel-section { background: var(--bg-secondary); border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); border: 1px solid var(--border); }
  .section-header { font-size: 1.1rem; font-weight: 700; color: var(--text-secondary); margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid var(--border); display: flex; align-items: center; gap: 8px; }
  .diesel-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
  .diesel-card { background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 8px; padding: 20px; text-align: center; position: relative; overflow: hidden; transition: all 0.3s; cursor: pointer; text-decoration: none; color: inherit; display: block; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); }
  .diesel-card:hover { transform: translateY(-3px); box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1); border-color: var(--primary); }
  .diesel-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; }
  .diesel-card.normal::before { background: linear-gradient(90deg, #10b981, #34d399); }
  .diesel-card.warning::before { background: linear-gradient(90deg, #f59e0b, #fbbf24); }
  .diesel-card.critical::before { background: linear-gradient(90deg, #ef4444, #f87171); }
  .diesel-label { font-size: 0.85rem; color: var(--text-muted); margin-bottom: 10px; text-transform: uppercase; letter-spacing: 0.5px; }
  .diesel-value { font-size: 2.5rem; font-weight: 800; line-height: 1; margin-bottom: 5px; color: var(--text-primary); }
  .diesel-unit { font-size: 0.9rem; color: var(--text-muted); }

  /* Electrical Sections */
  .dg-electrical-section { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 12px; margin-bottom: 15px; overflow: hidden; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); }
  .dg-header-link { text-decoration: none; color: inherit; display: block; }
  .dg-header { padding: 18px 20px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: background 0.3s; border-bottom: 1px solid var(--border); }
  .dg-header-link:hover .dg-header { background: rgba(0, 82, 204, 0.05); }
  .dg-title { display: flex; align-items: center; gap: 12px; flex: 1; }
  .dg-name { font-size: 1.2rem; font-weight: 700; color: var(--text-primary); }
  .status-badge { padding: 4px 12px; border-radius: 12px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
  .status-running { background: var(--success); color: white; }
  .status-off { background: var(--danger); color: white; }
  .expand-icon { font-size: 1.5rem; transition: transform 0.3s; color: var(--text-muted); }
  .dg-electrical-section.expanded .expand-icon { transform: rotate(180deg); }
  .dg-content { max-height: 0; overflow: hidden; transition: max-height 0.4s ease; }
  .dg-electrical-section.expanded .dg-content { max-height: 2000px; }
.param-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; padding: 20px; }
@media (max-width: 1200px) {.param-grid {grid-template-columns: repeat(4, 1fr);}}
@media (max-width: 768px) {.param-grid {  grid-template-columns: repeat(2, 1fr); }}
  .param-card { background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 8px; padding: 15px; text-align: center; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
  .param-label { font-size: 0.75rem; color: var(--text-muted); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.3px; }
  .param-value { font-size: 1.5rem; font-weight: 700; margin-bottom: 3px; color: var(--text-primary); }
  .param-unit { font-size: 0.8rem; color: var(--text-muted); }
  .alert-banner { background: linear-gradient(135deg, #ef4444, #dc2626); color: white; padding: 15px 20px; border-radius: 8px; margin-bottom: 20px; display: none; align-items: center; gap: 10px; font-weight: 600; animation: slideDown 0.3s ease; }
  .alert-banner.show { display: flex; }
  @keyframes slideDown { from { transform: translateY(-100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

  @media (max-width: 768px) {
    h1 { font-size: 1.5rem; }
    .diesel-value { font-size: 2rem; }
    .param-value { font-size: 1.3rem; }
    .diesel-grid { grid-template-columns: repeat(2, 1fr); }
    .param-grid { grid-template-columns: repeat(2, 1fr); }
  }
</style>
</head>
<body>
  <div class="container">
    
  <div class="header">
  <img src="/logo.png" alt="Aquarelle Logo" class="header-logo">
  
  <h1>DG Monitoring System Dashboard</h1>
  
  <div class="status-line">
    <span class="status-indicator status-online" id="server-status"></span>
    Last Updated: <span id="last-update">--</span>
  </div>
  <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
    <a href="/analytics.html" class="btn btn-primary" style="text-decoration: none; padding: 10px 20px; background: #0052cc; color: white; border-radius: 8px; font-weight: 600;">
      üìä Analytics
    </a>
  </div>
</div>


    <div id="alert-container"></div>

        <div class="diesel-section">
      <div class="section-header">
        üõ¢Ô∏è Diesel Levels (Click for Details)
      </div>
      <div class="diesel-grid">
        <a href="/consumption.html?dg=dg1" class="diesel-card normal" id="dg1-diesel-card">
          <div class="diesel-label">DG-1 Diesel</div>
          <div class="diesel-value" id="dg1-diesel">--</div>
          <div class="diesel-unit">Liters</div>
        </a>
        <a href="/consumption.html?dg=dg2" class="diesel-card normal" id="dg2-diesel-card">
          <div class="diesel-label">DG-2 Diesel</div>
          <div class="diesel-value" id="dg2-diesel">--</div>
          <div class="diesel-unit">Liters</div>
        </a>
        <a href="/consumption.html?dg=dg3" class="diesel-card normal" id="dg3-diesel-card">
          <div class="diesel-label">DG-3 Diesel</div>
          <div class="diesel-value" id="dg3-diesel">--</div>
          <div class="diesel-unit">Liters</div>
        </a>
        <a href="/consumption.html?dg=total" class="diesel-card normal">
          <div class="diesel-label">Total Diesel</div>
          <div class="diesel-value" id="total-diesel">--</div>
          <div class="diesel-unit">Liters</div>
        </a>
      </div>
    </div>

    <!-- DG 1 -->
   <!-- DG 1 -->
<div class="dg-electrical-section expanded" id="dg1-section">
  <a href="/electrical.html?dg=dg1" class="dg-header-link">
    <div class="dg-header">
      <div class="dg-title">
        <div class="dg-name">‚öôÔ∏è DG-1 Electrical Parameters</div>
        <div class="status-badge status-off" id="dg1-status">OFF</div>
      </div>
      <div class="expand-icon" data-target="dg1-content">‚ñº</div>
    </div>
  </a>
  <div class="dg-content" id="dg1-content">
   <div class="param-grid">
  <div class="param-card"><div class="param-label">Voltage R</div><div class="param-value" id="dg1-voltage-r">--</div><div class="param-unit">V</div></div>
  <div class="param-card"><div class="param-label">Voltage Y</div><div class="param-value" id="dg1-voltage-y">--</div><div class="param-unit">V</div></div>
  <div class="param-card"><div class="param-label">Voltage B</div><div class="param-value" id="dg1-voltage-b">--</div><div class="param-unit">V</div></div>
  <div class="param-card"><div class="param-label">Current R</div><div class="param-value" id="dg1-current-r">--</div><div class="param-unit">A</div></div>
  <div class="param-card"><div class="param-label">Current Y</div><div class="param-value" id="dg1-current-y">--</div><div class="param-unit">A</div></div>
  <div class="param-card"><div class="param-label">Current B</div><div class="param-value" id="dg1-current-b">--</div><div class="param-unit">A</div></div>
  <div class="param-card"><div class="param-label">kWh</div><div class="param-value" id="dg1-active-power">--</div><div class="param-unit">kWh</div></div>
  <div class="param-card"><div class="param-label">Frequency</div><div class="param-value" id="dg1-frequency">--</div><div class="param-unit">Hz</div></div>
  <div class="param-card"><div class="param-label">Power Factor</div><div class="param-value" id="dg1-power-factor">--</div><div class="param-unit">PF</div></div>
  <div class="param-card"><div class="param-label">Runtime</div><div class="param-value" id="dg1-runtime">--</div><div class="param-unit">Hrs</div></div>
</div>
  </div>
</div>

    <!-- DG 2 -->
    <!-- DG 2 -->
    <div class="dg-electrical-section expanded" id="dg2-section">
      <a href="/electrical.html?dg=dg2" class="dg-header-link">
        <div class="dg-header">
          <div class="dg-title"><div class="dg-name">‚öôÔ∏è DG-2 Electrical Parameters</div><div class="status-badge status-off" id="dg2-status">OFF</div></div>
          <div class="expand-icon" data-target="dg2-content">‚ñº</div>
        </div>
      </a>
      <div class="dg-content" id="dg2-content">
        <div class="param-grid">
          <div class="param-card"><div class="param-label">Voltage R</div><div class="param-value" id="dg2-voltage-r">--</div><div class="param-unit">V</div></div>
          <div class="param-card"><div class="param-label">Voltage Y</div><div class="param-value" id="dg2-voltage-y">--</div><div class="param-unit">V</div></div>
          <div class="param-card"><div class="param-label">Voltage B</div><div class="param-value" id="dg2-voltage-b">--</div><div class="param-unit">V</div></div>
          <div class="param-card"><div class="param-label">Current R</div><div class="param-value" id="dg2-current-r">--</div><div class="param-unit">A</div></div>
          <div class="param-card"><div class="param-label">Current Y</div><div class="param-value" id="dg2-current-y">--</div><div class="param-unit">A</div></div>
          <div class="param-card"><div class="param-label">Current B</div><div class="param-value" id="dg2-current-b">--</div><div class="param-unit">A</div></div>
          <div class="param-card"><div class="param-label">kWh</div><div class="param-value" id="dg2-active-power">--</div><div class="param-unit">kWh</div></div>
          <div class="param-card"><div class="param-label">Frequency</div><div class="param-value" id="dg2-frequency">--</div><div class="param-unit">Hz</div></div>
          <div class="param-card"><div class="param-label">Power Factor</div><div class="param-value" id="dg2-power-factor">--</div><div class="param-unit">PF</div></div>
  <div class="param-card"><div class="param-label">Runtime</div><div class="param-value" id="dg2-runtime">--</div><div class="param-unit">Hrs</div></div>
        </div>
      </div>
    </div>

    <!-- DG 3 -->
    <div class="dg-electrical-section expanded" id="dg3-section">
      <a href="/electrical.html?dg=dg3" class="dg-header-link">
        <div class="dg-header">
          <div class="dg-title"><div class="dg-name">‚öôÔ∏è DG-3 Electrical Parameters</div><div class="status-badge status-off" id="dg3-status">OFF</div></div>
          <div class="expand-icon" data-target="dg3-content">‚ñº</div>
        </div>
      </a>
      <div class="dg-content" id="dg3-content">
        <div class="param-grid">
          <div class="param-card"><div class="param-label">Voltage R</div><div class="param-value" id="dg3-voltage-r">--</div><div class="param-unit">V</div></div>
          <div class="param-card"><div class="param-label">Voltage Y</div><div class="param-value" id="dg3-voltage-y">--</div><div class="param-unit">V</div></div>
          <div class="param-card"><div class="param-label">Voltage B</div><div class="param-value" id="dg3-voltage-b">--</div><div class="param-unit">V</div></div>
          <div class="param-card"><div class="param-label">Current R</div><div class="param-value" id="dg3-current-r">--</div><div class="param-unit">A</div></div>
          <div class="param-card"><div class="param-label">Current Y</div><div class="param-value" id="dg3-current-y">--</div><div class="param-unit">A</div></div>
          <div class="param-card"><div class="param-label">Current B</div><div class="param-value" id="dg3-current-b">--</div><div class="param-unit">A</div></div>
          <div class="param-card"><div class="param-label">kWh</div><div class="param-value" id="dg3-active-power">--</div><div class="param-unit">kWh</div></div>
          <div class="param-card"><div class="param-label">Frequency</div><div class="param-value" id="dg3-frequency">--</div><div class="param-unit">Hz</div></div>
          <div class="param-card"><div class="param-label">Power Factor</div><div class="param-value" id="dg4-power-factor">--</div><div class="param-unit">PF</div></div>
  <div class="param-card"><div class="param-label">Runtime</div><div class="param-value" id="dg4-runtime">--</div><div class="param-unit">Hrs</div></div>
        </div>
      </div>
    </div>

    <!-- DG 4 -->
    <div class="dg-electrical-section expanded" id="dg4-section">
      <a href="/electrical.html?dg=dg4" class="dg-header-link">
        <div class="dg-header">
          <div class="dg-title"><div class="dg-name">‚öôÔ∏è DG-4 Electrical Parameters</div><div class="status-badge status-off" id="dg4-status">OFF</div></div>
          <div class="expand-icon" data-target="dg4-content">‚ñº</div>
        </div>
      </a>
      <div class="dg-content" id="dg4-content">
        <div class="param-grid">
          <div class="param-card"><div class="param-label">Voltage R</div><div class="param-value" id="dg4-voltage-r">--</div><div class="param-unit">V</div></div>
          <div class="param-card"><div class="param-label">Voltage Y</div><div class="param-value" id="dg4-voltage-y">--</div><div class="param-unit">V</div></div>
          <div class="param-card"><div class="param-label">Voltage B</div><div class="param-value" id="dg4-voltage-b">--</div><div class="param-unit">V</div></div>
          <div class="param-card"><div class="param-label">Current R</div><div class="param-value" id="dg4-current-r">--</div><div class="param-unit">A</div></div>
          <div class="param-card"><div class="param-label">Current Y</div><div class="param-value" id="dg4-current-y">--</div><div class="param-unit">A</div></div>
          <div class="param-card"><div class="param-label">Current B</div><div class="param-value" id="dg4-current-b">--</div><div class="param-unit">A</div></div>
          <div class="param-card"><div class="param-label">kWh</div><div class="param-value" id="dg4-active-power">--</div><div class="param-unit">kWh</div></div>
          <div class="param-card"><div class="param-label">Frequency</div><div class="param-value" id="dg4-frequency">--</div><div class="param-unit">Hz</div></div>
          <div class="param-card"><div class="param-label">Power Factor</div><div class="param-value" id="dg4-power-factor">--</div><div class="param-unit">PF</div></div>
  <div class="param-card"><div class="param-label">Runtime</div><div class="param-value" id="dg4-runtime">--</div><div class="param-unit">Hrs</div></div>
        </div>
      </div>
    </div>

  </div>

<script>
    // index.html - SMART DB FALLBACK VERSION

    const CRITICAL_LEVEL = 50;
    const WARNING_LEVEL = 70;
    const DG_RUNNING_THRESHOLD = 4; 
    const VOLTAGE_THRESHOLD = 200;  

    const DG_MAX_KW = { dg1: 500, dg2: 500, dg3: 380, dg4: 380 };

    // Cache DB history to reduce API calls
    let dbCache = { dg1: null, dg2: null, dg3: null, dg4: null };
    let dieselHistoryCache = { dg1: null, dg2: null, dg3: null };
    
    // Cooldown tracker
    let historyCooldown = { dg1: 0, dg2: 0, dg3: 0, dg4: 0 };
    let dieselCooldown = { dg1: 0, dg2: 0, dg3: 0 };

    // Flag to prevent overlapping updates
    let isUpdating = false;

    document.querySelectorAll('.expand-icon').forEach(icon => {
      icon.addEventListener('click', (e) => {
        e.preventDefault(); e.stopPropagation(); 
        const contentId = icon.getAttribute('data-target');
        const content = document.getElementById(contentId);
        const section = content.closest('.dg-electrical-section');
        section.classList.toggle('expanded');
        content.style.maxHeight = section.classList.contains('expanded') ? '2000px' : '0';
      });
    });

    document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('.dg-content').forEach(content => {
            const section = content.closest('.dg-electrical-section');
            if (section.classList.contains('expanded')) { content.style.maxHeight = '2000px'; } 
            else { content.style.maxHeight = '0'; }
        });
    });

    async function fetchData() {
      try {
        const response = await fetch('/api/data');
        if (!response.ok) return null;
        return await response.json();
      } catch (err) {
        console.warn('Network glitch (fetchData), skipping update.');
        return null;
      }
    }

    // ‚úÖ NEW: Fetch Diesel History if Live Data is 0
    async function fetchLastDieselHistory(dg) {
       if (dieselHistoryCache[dg]) return dieselHistoryCache[dg];
       if (Date.now() - dieselCooldown[dg] < 60000) return 0; // 1 min cooldown

       try {
           const today = new Date().toISOString().split('T')[0];
           // Fetch today's consumption to get last level
           let response = await fetch(`/api/consumption?dg=${dg}&startDate=${today}&endDate=${today}`);
           let result = await response.json();
           
           if (!result.data || result.data.length === 0) {
                // If empty today, try yesterday
                const yest = new Date();
                yest.setDate(yest.getDate() - 1);
                const yestStr = yest.toISOString().split('T')[0];
                response = await fetch(`/api/consumption?dg=${dg}&startDate=${yestStr}&endDate=${yestStr}`);
                result = await response.json();
           }
           
           if (result.data && result.data.length > 0) {
               const lastRecord = result.data[result.data.length - 1];
               const level = lastRecord.level || 0;
               if (level > 0) {
                   dieselHistoryCache[dg] = level;
                   return level;
               }
           }
       } catch(e) { console.error("History fetch error:", e); }
       
       dieselCooldown[dg] = Date.now();
       return 0;
    }

    async function fetchLastHistory(dg) {
      if (dbCache[dg]) return dbCache[dg];
      if (Date.now() - historyCooldown[dg] < 60000) return null; 

      try {
          const today = new Date().toISOString().split('T')[0];
          let response = await fetch(`/api/electrical/${dg}?startDate=${today}&endDate=${today}`);
          
          if (!response.ok) {
              historyCooldown[dg] = Date.now();
              return null;
          }
          
          let result = await response.json();

          if (!result.data || result.data.length === 0) {
               const yest = new Date();
               yest.setDate(yest.getDate() - 1);
               const yestStr = yest.toISOString().split('T')[0];
               response = await fetch(`/api/electrical/${dg}?startDate=${yestStr}&endDate=${yestStr}`);
               if (!response.ok) {
                   historyCooldown[dg] = Date.now(); 
                   return null;
               }
               result = await response.json();
          }

          if (result.data && result.data.length > 0) {
              const lastRecord = result.data[result.data.length - 1];
              dbCache[dg] = lastRecord;
              return lastRecord;
          } else {
              historyCooldown[dg] = Date.now();
          }
      } catch (e) { 
          historyCooldown[dg] = Date.now();
          return null; 
      }
      return {}; 
    }

    function formatNum(num, decimals = 1) {
      if (num === undefined || num === null || isNaN(num)) return '--';
      if (num === 0) return decimals > 0 ? '0.0' : '0';
      return num.toFixed(decimals);
    }

    async function updateDieselLevels(data) {
      if(!data) return;

      let levels = { dg1: data.dg1 || 0, dg2: data.dg2 || 0, dg3: data.dg3 || 0 };
      
      // ‚úÖ SMART FALLBACK: If live level is 0, fetch from DB
      for (const dg of ['dg1', 'dg2', 'dg3']) {
          if (levels[dg] === 0) {
              const historyLevel = await fetchLastDieselHistory(dg);
              if (historyLevel > 0) levels[dg] = historyLevel;
          }
      }

      ['dg1', 'dg2', 'dg3'].forEach(dg => {
        const level = levels[dg];
        const card = document.getElementById(`${dg}-diesel-card`);
        const valueEl = document.getElementById(`${dg}-diesel`);
        if (valueEl) valueEl.textContent = formatNum(level, 0);
        if (card) {
          card.className = 'diesel-card'; 
          if (level <= CRITICAL_LEVEL) card.classList.add('critical');
          else if (level <= WARNING_LEVEL) card.classList.add('warning');
          else card.classList.add('normal');
        }
      });
      
      const total = levels.dg1 + levels.dg2 + levels.dg3;
      document.getElementById('total-diesel').textContent = formatNum(total, 0);

      const criticalDGs = Object.entries(levels).filter(([_, value]) => value <= CRITICAL_LEVEL).map(([key]) => key.toUpperCase().replace('DG', 'DG-'));
      const container = document.getElementById('alert-container');
      container.innerHTML = '';
      if (criticalDGs.length > 0) {
        container.innerHTML = `<div class="alert-banner show">‚ö†Ô∏è CRITICAL: Low diesel levels in ${criticalDGs.join(', ')}! Refuel immediately.</div>`;
      }
    }

async function updateElectricalParams(data) {
  if (!data || !data.electrical) return;

  const dgList = ['dg1', 'dg2', 'dg3', 'dg4'];
  const updates = [];

  for (const dg of dgList) {
    let liveData = data.electrical[dg] || {};
    const hasVoltage = (liveData.voltageR || 0) > VOLTAGE_THRESHOLD;
    
    let promise;
    if (hasVoltage) {
        dbCache[dg] = null; 
        historyCooldown[dg] = 0; 
        promise = Promise.resolve(liveData);
    } else {
        promise = fetchLastHistory(dg).then(hist => hist || liveData);
    }
    updates.push({ dg, liveData, promise });
  }

  const results = await Promise.all(updates.map(u => u.promise));

  updates.forEach((item, index) => {
    const dg = item.dg;
    const displayData = results[index];
    const liveData = item.liveData;

    const isRunning = (liveData.activePower || 0) > DG_RUNNING_THRESHOLD;
    const statusEl = document.getElementById(`${dg}-status`);
    if (statusEl) {
      statusEl.textContent = isRunning ? 'RUNNING' : 'OFF';
      statusEl.className = 'status-badge ' + (isRunning ? 'status-running' : 'status-off');
    }

    // Update Voltages
    ['r', 'y', 'b'].forEach(phase => {
      const el = document.getElementById(`${dg}-voltage-${phase}`);
      if (el) el.textContent = formatNum(displayData[`voltage${phase.toUpperCase()}`]);
    });
    
    // Update Currents
    ['r', 'y', 'b'].forEach(phase => {
      const el = document.getElementById(`${dg}-current-${phase}`);
      if (el) el.textContent = formatNum(displayData[`current${phase.toUpperCase()}`]);
    });

    // Update Frequency
    const freqEl = document.getElementById(`${dg}-frequency`);
    if (freqEl) freqEl.textContent = formatNum(displayData.frequency);

    // Update Active Power (kWh)
    const apEl = document.getElementById(`${dg}-active-power`);
    if (apEl) apEl.textContent = formatNum(displayData.activePower);

    // ‚úÖ NEW: Update Power Factor
    const pfEl = document.getElementById(`${dg}-power-factor`);
    if (pfEl) pfEl.textContent = formatNum(displayData.powerFactor || 0, 2);

    // ‚úÖ NEW: Update Runtime Hours
    const rtEl = document.getElementById(`${dg}-runtime`);
    if (rtEl) rtEl.textContent = formatNum(displayData.runningHours || 0, 1);
  });
}


    function updateTimestamp() {
      const now = new Date();
      const timestampEl = document.getElementById('last-update');
      if (timestampEl) {
        timestampEl.textContent = now.toLocaleString('en-IN', { timeZone: 'Asia/Kolkata', dateStyle: 'short', timeStyle: 'medium' });
      }
    }

    async function refresh() {
      if (isUpdating) return;
      isUpdating = true;

      try {
          const data = await fetchData();
          const indicator = document.getElementById('server-status');

          if (!data) {
            if (indicator) { indicator.classList.remove('status-online'); indicator.classList.add('status-offline'); }
            return; 
          }

          if (indicator) { indicator.classList.remove('status-offline'); indicator.classList.add('status-online'); }

          await updateDieselLevels(data);
          await updateElectricalParams(data); 
          updateTimestamp();
      } catch (e) {
          console.error("Refresh error:", e);
      } finally {
          isUpdating = false;
      }
    }

    setInterval(refresh, 500);
    refresh();
</script>
</body>
</html>